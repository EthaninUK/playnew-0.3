const axios = require('axios');

const DIRECTUS_URL = 'http://localhost:8055';
const EMAIL = 'the_uk1@outlook.com';
const PASSWORD = 'Mygcdjmyxzg2026!';

const GUIDE_CONFIG = {
  title: '稳定币对冲保本策略',
  slug: 'stablecoin-hedging-capital-preservation',
  summary: '通过Delta中性策略和稳定币对冲机制，在保护本金安全的前提下获取5-12%的稳定收益，适合风险厌恶型投资者',
  category: 'stablecoin-yield',
  category_l1: 'yield',
  category_l2: '稳定币理财',
  difficulty_level: 3,
  risk_level: 2,
  time_commitment: '中等',
  initial_capital_min: 10000,
  initial_capital_max: 1000000,
  apy_min: 5,
  apy_max: 12,
  status: 'published',
  author: 'PlayNew Team',
  content: `
# 稳定币对冲保本策略

## TL;DR
- **核心机制**: Delta中性对冲 + 稳定币收益组合
- **收益来源**: 借贷利息 + 资金费率套利 + LP费用
- **风险控制**: 对冲比例自动调整 + 多重保护机制
- **适合人群**: 保守型投资者，追求稳定收益
- **最低资金**: $10,000 起步，$50,000+ 效果最佳

---

## 一、策略原理

### 1.1 Delta中性对冲
通过同时持有现货和衍生品的相反头寸，抵消价格波动风险：

- **做多现货**: 存入USDC获取借贷收益
- **做空永续**: 在衍生品交易所开空单
- **净敞口**: 价格波动时盈亏相抵，实现保本

### 1.2 收益来源结构
多重收益叠加，平滑波动：

1. **借贷利息**: Aave/Compound存款利息 3-6%
2. **资金费率**: 永续合约资金费率收益 2-8%
3. **LP手续费**: 稳定币池做市收益 1-3%
4. **奖励代币**: 协议治理代币激励 1-5%

### 1.3 保本机制
- **对冲比例**: 动态调整至90-110%
- **保证金管理**: 维持率不低于200%
- **止损设置**: 单日波动超5%触发平仓
- **资金隔离**: 分散至3-5个协议

---

## 二、实战操作步骤

### 2.1 资金配置方案

**方案A - 保守型**（风险等级：低）
- 60% Aave存款获取利息
- 30% GMX对冲空单
- 10% Curve稳定币池

**方案B - 平衡型**（风险等级：中低）
- 50% Compound借贷
- 35% dYdX对冲
- 15% Convex增强池

**方案C - 激进型**（风险等级：中）
- 40% 高收益协议
- 45% 多协议对冲组合
- 15% Delta-neutral策略

### 2.2 开仓流程

#### Step 1: 现货端建仓
1. 准备 $10,000 USDC
2. 在 Aave 存入 $6,000
3. 在 Curve 3Pool 存入 $1,000
4. 预留 $3,000 作为对冲保证金

#### Step 2: 衍生品端对冲
1. 在 GMX 开空 BTC-USD 永续
2. 名义价值 $6,000
3. 杠杆 2x（保证金 $3,000）
4. 设置自动追加保证金

#### Step 3: 参数监控
每日检查：
- 对冲比例是否在 90-110%
- 保证金维持率 > 200%
- 资金费率是否为正
- Aave利用率是否正常

### 2.3 调仓规则

**触发条件**：
1. 对冲比例偏离 ±15%
2. 资金费率连续3天为负
3. 借贷利率下降超过30%
4. 市场极端波动（日波动>10%）

**调仓动作**：
- 增加/减少衍生品头寸
- 转移资金至更高收益协议
- 调整保证金比例
- 平掉部分头寸锁定利润

---

## 三、风险管理体系

### 3.1 协议风险防护
- **分散投资**: 不超过40%资金在单一协议
- **协议审计**: 仅使用经过3次以上审计的协议
- **保险覆盖**: 购买Nexus Mutual协议保险
- **紧急预案**: 设置快速撤资路径

### 3.2 市场风险应对
- **极端行情**: 单日波动>15%触发全平
- **流动性危机**: 保持20%流动性储备
- **脱锚风险**: 监控稳定币偏离度<2%
- **资金费率倒挂**: 及时平仓转移阵地

### 3.3 操作风险控制
- **自动化脚本**: 使用机器人监控调仓
- **多签钱包**: 大额操作需要2/3签名
- **定期审计**: 每周复盘持仓情况
- **备用方案**: 准备3套退出路径

---

## 四、真实案例分析

### 案例1：$50,000 保守型组合（3个月）

**初始配置**：
- Aave USDC 存款：$30,000（APY 4%）
- GMX BTC空单：$20,000名义（2x杠杆）
- Curve 3Pool：$10,000（APY 3%）

**收益明细**：
- 借贷利息：$30,000 × 4% ÷ 4 = $300
- 资金费率：$20,000 × 6% ÷ 4 = $300
- LP手续费：$10,000 × 3% ÷ 4 = $75
- CRV奖励：$10,000 × 2% ÷ 4 = $50

**3个月净收益**：$725（年化5.8%）
**价格波动影响**：BTC涨20%，对冲后净值波动<1%

### 案例2：$100,000 激进型组合（6个月）

**初始配置**：
- Compound借贷：$40,000（APY 5%）
- dYdX + GMX对冲组合：$50,000
- Pendle PT-sUSDe：$10,000（固定APY 8%）

**半年收益**：
- 借贷：$40,000 × 5% ÷ 2 = $1,000
- 对冲套利：$50,000 × 10% ÷ 2 = $2,500
- Pendle固定：$10,000 × 8% ÷ 2 = $400

**半年净收益**：$3,900（年化7.8%）
**最大回撤**：-2.3%（发生在3月市场暴跌）

---

## 五、工具与自动化

### 5.1 监控工具
- **DeBank**: 实时查看DeFi持仓
- **Zapper**: 跨协议收益追踪
- **Dune Analytics**: 定制仪表盘
- **Telegram Bot**: 异常警报推送

### 5.2 自动化脚本
可以部署以下自动化任务：
- 对冲比例每小时检查
- 资金费率自动收割
- 保证金不足自动充值
- 收益代币自动复投

### 5.3 风控面板
关键指标实时监控：
- 整体对冲比例
- 各协议保证金率
- 预期年化收益
- 当前风险敞口

---

## 六、常见问题FAQ

**Q1: 对冲策略会完全消除风险吗？**
A: 不会。虽然价格风险被对冲，但仍存在：
- 协议风险（智能合约漏洞）
- 流动性风险（极端行情无法平仓）
- 操作风险（参数设置错误）
- 滑点损失（大额交易）

**Q2: 资金费率转负怎么办？**
A: 有两种处理方式：
- 短期转负（1-2天）：继续持有，长期仍为正
- 持续转负（>3天）：平掉空单，转移至其他交易所

**Q3: 需要盯盘吗？**
A: 建议每日检查一次，结合自动化工具：
- 设置价格警报（±5%）
- 保证金率警报（<250%）
- 对冲比例警报（偏离>20%）
- 其他时间可以不管

**Q4: 和直接存稳定币收益有何区别？**
A: 主要区别：
- 纯存款：收益3-5%，风险低
- 对冲策略：收益5-12%，风险中低
- 对冲策略通过资金费率套利获取额外收益

**Q5: 最低资金要求？**
A: 理论上$5,000可以开始，但建议：
- $10,000: 基础配置，收益覆盖gas
- $50,000: 最佳配置，各环节效率高
- $100,000+: 可以使用更复杂策略

**Q6: 税务处理如何？**
A: 各国政策不同，一般原则：
- 借贷利息：按利息收入报税
- 资金费率：按衍生品交易报税
- LP手续费：按投资收益报税
- 建议咨询当地税务顾问

---

## 七、进阶优化

### 7.1 收益增强
- **杠杆借贷**: 使用1.5x杠杆提升收益至9-15%
- **波动率套利**: 在IV高时卖出期权收取权利金
- **基差套利**: 现货-期货价差收敛获利
- **跨链套利**: 不同链间资金费率差套利

### 7.2 成本优化
- **Layer 2部署**: 使用Arbitrum/Optimism降低gas
- **批量操作**: 合并交易减少手续费
- **流动性挖矿**: 参与治理获取额外代币
- **推荐返佣**: 邀请好友获取手续费返还

### 7.3 策略组合
可以与其他策略叠加使用：
- 80% 对冲保本 + 20% 激进策略
- 核心仓位保本 + 卫星仓位博高收益
- 季度轮动：牛市减少对冲，熊市加大对冲

---

## 八、退出策略

### 8.1 正常退出
1. 先平掉衍生品空单
2. 等待资金费率结算
3. 提取Aave/Compound存款
4. 退出Curve LP
5. 全部转换为USDC/USDT

**预计时间**: 1-2天
**损失**: 滑点 + gas费用 < 0.5%

### 8.2 紧急退出
如遇市场崩盘或协议风险：
1. 立即平掉所有衍生品头寸
2. 提取所有存款（即使产生清算费）
3. 转移至CEX稳定币
4. 暂时退出市场观望

**预计时间**: 1-6小时
**可能损失**: 2-5%

---

## 执行检查清单

### 开仓前检查：
- [ ] 已完成至少1次模拟操作
- [ ] 理解对冲原理和风险点
- [ ] 准备好监控工具和自动化脚本
- [ ] 设置好价格和保证金警报
- [ ] 预留至少30% 应急资金

### 运行中检查（每日）：
- [ ] 对冲比例在90-110%范围
- [ ] 保证金维持率>200%
- [ ] 所有协议运行正常
- [ ] 资金费率为正
- [ ] 无异常大额转账

### 月度复盘：
- [ ] 计算实际年化收益率
- [ ] 分析收益来源占比
- [ ] 评估风险调整后收益
- [ ] 对比其他策略表现
- [ ] 决定是否调整配置

---

**免责声明**: 本策略涉及DeFi协议和衍生品交易，存在智能合约、市场波动、流动性等风险。虽然通过对冲降低了价格风险，但无法完全消除所有风险。请根据自身风险承受能力谨慎参与，建议从小资金开始测试。
`,
  steps: [
    {
      order_index: 1,
      title: '资金准备与分配',
      description: '准备$10,000 USDC，分配至现货（60%）、衍生品保证金（30%）、流动性池（10%）',
      estimated_time: '30分钟',
      complexity: 'easy'
    },
    {
      order_index: 2,
      title: '现货端建仓',
      description: '在Aave存入$6,000 USDC，在Curve 3Pool存入$1,000，开始赚取利息',
      estimated_time: '1小时',
      complexity: 'medium'
    },
    {
      order_index: 3,
      title: '衍生品对冲',
      description: '在GMX/dYdX开空$6,000名义价值的BTC永续合约（2x杠杆），建立Delta中性头寸',
      estimated_time: '1小时',
      complexity: 'medium'
    },
    {
      order_index: 4,
      title: '设置监控和警报',
      description: '配置DeBank监控，设置对冲比例、保证金率、价格波动警报，部署自动化脚本',
      estimated_time: '1-2小时',
      complexity: 'hard'
    },
    {
      order_index: 5,
      title: '日常维护与调仓',
      description: '每日检查对冲比例和保证金率，根据市场情况调整头寸，每周收割资金费率和奖励',
      estimated_time: '15分钟/天',
      complexity: 'medium'
    }
  ]
};

async function getAuthToken() {
  const response = await axios.post(`${DIRECTUS_URL}/auth/login`, {
    email: EMAIL,
    password: PASSWORD,
  });
  return response.data.data.access_token;
}

async function addGuide() {
  try {
    const token = await getAuthToken();

    const strategy = {
      ...GUIDE_CONFIG,
      status: 'published',
      is_featured: false,
      view_count: 0,
      bookmark_count: 0,
      published_at: new Date().toISOString(),
    };

    const response = await axios.post(
      `${DIRECTUS_URL}/items/strategies`,
      strategy,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      },
    );

    console.log('\n✅ 稳定币对冲保本策略创建成功!');
    console.log(`   ID: ${response.data.data.id}`);
    console.log(`   Slug: ${response.data.data.slug}`);
    console.log(`   访问: http://localhost:3000/strategies/${response.data.data.slug}\n`);
  } catch (error) {
    console.error('\n❌ 创建失败:', error.response?.data || error.message);
  }
}

addGuide();