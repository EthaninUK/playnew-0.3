const axios = require('axios');

const DIRECTUS_URL = 'http://localhost:8055';

const GUIDE_CONFIG = {
  title: 'Pendle 收益分层策略',
  slug: 'pendle-yield-strategy',
  summary:
    'Pendle收益分层策略实战：固定收益PT（本金代币）vs浮动收益YT（收益代币）、Aave/Lido/GMX收益代币化、锁定未来收益率（APY 5-15%）、收益交易策略（买卖YT套利）、到期日管理、无常损失分析、流动性挖矿奖励、牛熊市场应对、隐含APY计算、$20K本金年赚$2,500案例。',

  category: 'stablecoin-yield',
  category_l1: 'yield',
  category_l2: '稳定币理财',

  difficulty_level: 3,
  risk_level: 3,
  apy_min: 5,
  apy_max: 15,

  threshold_capital: '5,000–100,000 USD（需理解复杂金融产品）',
  threshold_capital_min: 5000,
  time_commitment: '初始学习15小时，设置策略3小时，每周监控到期日和APY变化1小时',
  time_commitment_minutes: 60,
  threshold_tech_level: 'advanced',

  content: `> **适用人群**：理解债券和期权概念、希望交易未来收益、能承受复杂DeFi产品学习曲线、追求固定收益或高杠杆收益的高级玩家

> **阅读时间**：≈ 30–40 分钟

> **关键词**：Pendle Finance / Yield Trading / Principal Token / Yield Token / Fixed Income / Interest Rate Derivatives / Implied APY / Maturity / DeFi Bonds / Yield Stripping

---

## 🧭 TL;DR

**核心策略**：在Pendle协议中将收益资产（如Aave USDC）拆分为本金代币（PT）和收益代币（YT），交易未来收益率。

**什么是Pendle**：
- DeFi利率衍生品协议
- 将"带息资产"拆分为"本金"和"利息"
- 可以分别交易、实现不同策略

**两种代币**：
- **PT（Principal Token）**：本金代币，到期赎回1:1本金，类似零息债券
- **YT（Yield Token）**：收益代币，获得全部利息，类似高杠杆收益权

**收益模型**（$20K本金）：
- **买入PT**（保守）：锁定5% 固定APY = **$1,000/年**（确定性收益）
- **买入YT**（激进）：如果APY保持10% = **$2,000/年**（浮动收益）
- **提供LP**（平衡）：赚取交易费+PENDLE奖励 = 8-12% APY

**优势**：
- ✅ 固定收益（对冲利率下降风险）
- ✅ 高杠杆收益（YT放大收益率）
- ✅ 策略灵活（多空收益率）
- ✅ 真实收益（非通胀代币奖励）

**劣势**：
- ❌ 学习曲线陡峭（需要理解债券概念）
- ❌ 流动性风险（小池子滑点高）
- ❌ 到期日管理（需要滚动投资）
- ❌ 复杂度高（不适合小白）

---

## 🗂 目录
1. [Pendle核心概念](#pendle核心概念)
2. [PT固定收益策略](#pt固定收益策略)
3. [YT杠杆收益策略](#yt杠杆收益策略)
4. [LP流动性挖矿](#lp流动性挖矿)
5. [隐含APY计算](#隐含apy计算)
6. [到期日管理](#到期日管理)
7. [牛熊市场策略](#牛熊市场策略)
8. [风险与对冲](#风险与对冲)
9. [真实收益案例](#真实收益案例)
10. [常见问题FAQ](#常见问题faq)

---

## 🧩 Pendle核心概念

### 收益拆分机制

**传统收益资产**：
- 存入Aave 10,000 USDC → 获得10,000 aUSDC
- aUSDC每秒增值（5% APY）
- 1年后赎回 → 10,500 USDC（本金+利息）

**Pendle拆分**：
- 存入10,000 aUSDC到Pendle
- 获得：
  - **10,000 PT-aUSDC**（本金代币，2025年12月31日到期）
  - **10,000 YT-aUSDC**（收益代币，2025年12月31日到期）

---

### 代币价值

#### PT（Principal Token）- 本金代币
**特性**：
- 到期赎回1:1底层资产
- 类似零息债券
- 价格<1（折价交易）

**示例**：
- PT-aUSDC（2025年12月到期）
- 当前价格：$0.95
- 含义：花$9,500买入10,000 PT，到期赎回10,000 USDC
- 锁定收益：$500（5.26% APY）

---

#### YT（Yield Token）- 收益代币
**特性**：
- 获得底层资产的全部收益
- 到期后价值归零
- 价格波动大（收益率敏感）

**示例**：
- YT-aUSDC（2025年12月到期）
- 当前价格：$0.05
- 如果aUSDC APY保持5%：
  - 1年后收益：10,000 × 5% = $500
  - YT价值：$500 ÷ 10,000 = $0.05
  - 投资回报：($0.05 - $0.05) ÷ $0.05 = 0%

**如果APY涨至10%**：
- 1年后收益：10,000 × 10% = $1,000
- YT价值涨至：$0.10
- 投资回报：($0.10 - $0.05) ÷ $0.05 = **100%**

**收益率杠杆！**

---

### Pendle工作流程

**存入（Mint）**：
1. 将aUSDC存入Pendle
2. 获得PT + YT（1:1比例）
3. 可分别卖出PT或YT

**赎回（Redeem）**：
到期后：
- PT持有者：赎回1:1本金
- YT持有者：赎回累积的利息

到期前：
- 在Pendle AMM卖出PT/YT（可能溢价/折价）

---

## 🛡️ PT固定收益策略

### 适用场景

**何时买入PT**：
- ✅ 预期未来收益率下降
- ✅ 追求确定性收益（保守型）
- ✅ 对冲利率风险

**示例场景**：
- 当前Aave USDC APY：8%
- 你认为美联储降息 → APY可能降至3%
- **策略**：买入PT锁定当前8%隐含APY

---

### 操作流程

#### Step 1：选择池子
访问 https://app.pendle.finance/trade/markets

**热门PT池子**（2025年1月）：
| 底层资产 | 到期日 | 隐含APY | 流动性 |
|----------|--------|---------|--------|
| **PT-aUSDC** | 2025-12-31 | 6.5% | $50M |
| **PT-sDAI** | 2025-06-30 | 5.8% | $80M |
| **PT-GLP** | 2025-09-30 | 12% | $30M |

---

#### Step 2：计算隐含APY
**PT价格 → 隐含APY转换**：

公式：
隐含APY = (1 ÷ PT价格 - 1) ÷ 剩余天数 × 365

示例：
- PT-aUSDC价格：$0.95
- 到期日：300天后
- 隐含APY = (1 ÷ 0.95 - 1) ÷ 300 × 365 = **6.4%**

含义：买入PT相当于锁定6.4%固定收益

---

#### Step 3：买入PT
1. 在Pendle App选择PT-aUSDC池子
2. 点击"Buy PT"
3. 输入金额（如10,000 USDC）
4. 查看预计获得的PT数量（约10,526 PT）
5. 确认交易（Gas $5-$15）

**完成后**：
- 钱包收到10,526 PT-aUSDC
- 到期后赎回 → 10,526 USDC
- 锁定收益：$526（6.4% APY）

---

#### Step 4：持有至到期
**到期日操作**：
1. 访问Pendle App
2. 找到"Redeem"页面
3. 点击赎回PT
4. 1:1换回底层资产（10,526 aUSDC → 10,526 USDC）

**提前退出**：
- 可在到期前卖出PT
- 价格波动：利率上升 → PT价格下跌，利率下降 → PT价格上涨

---

### 收益对比

**场景对比**（$10K本金，1年期）：

| 策略 | 操作 | 1年后收益 | 风险 |
|------|------|-----------|------|
| **直接Aave** | 存入Aave | $500（5% APY浮动） | 利率下降至2% → $200 |
| **买入PT** | 买入PT锁定6.4% | $640（确定） | 无利率风险 |

**适合人群**：
- 保守型投资者
- 预期利率下降
- 需要确定性收益（如养老金）

---

## 📈 YT杠杆收益策略

### YT的杠杆效应

**核心原理**：YT价格远低于本金，但获得全部收益 → 放大收益率

**数值示例**：
- aUSDC本金：$10,000
- aUSDC年收益：$500（5% APY）
- YT价格：$0.05/个
- 买入10,000 YT成本：$500

**收益计算**：
- 1年后YT赎回收益：$500
- 投资回报率：$500 ÷ $500 = **100%**

对比：
- 直接持有aUSDC：5% APY
- 持有YT：100% APY（20倍杠杆！）

---

### 适用场景

**何时买入YT**：
- ✅ 预期未来收益率上升
- ✅ 追求高风险高收益
- ✅ 对收益率看多（做多利率）

**示例场景**：
- GLP（GMX流动性池）当前APY：15%
- 你认为GMX交易量增加 → APY可能涨至25%
- **策略**：买入YT-GLP获得高杠杆收益

---

### 操作流程

#### Step 1：评估风险
**YT风险**：
- ❌ 如果APY下降 → YT价值暴跌
- ❌ 到期后归零（无剩余价值）
- ❌ 高波动性

**仅用5-10%资金投资YT**

---

#### Step 2：选择高APY池子
**推荐池子**（高波动=高收益潜力）：
- YT-GLP（GMX流动性，APY 10-20%）
- YT-stETH（以太坊质押，APY 3-5%，牛市可能更高）
- YT-pendle-LP（Pendle自身LP，APY 15-30%）

---

#### Step 3：买入YT
1. 在Pendle选择YT-GLP池子
2. 点击"Buy YT"
3. 投入$1,000（小额测试）
4. 获得约10,000 YT-GLP（价格$0.10）

---

#### Step 4：监控收益率
**每周检查**：
- GLP当前APY
- YT价格变化
- 如果APY上升 → YT价格上涨 → 可提前卖出止盈

---

### 风险案例

**失败案例**：
- 买入YT-stETH（$0.04，预期APY 4%）
- 以太坊质押APY降至2%（熊市）
- YT价格跌至$0.02
- 损失：50%

**成功案例**：
- 买入YT-GLP（$0.12，当前APY 15%）
- GMX交易量暴增，APY涨至25%
- YT价格涨至$0.25
- 收益：108%

---

## 💧 LP流动性挖矿

### Pendle AMM机制

**Pendle的LP池**：
- PT-SY流动性池（PT vs 底层资产）
- 提供流动性 → 赚取交易手续费 + PENDLE奖励

**收益来源**：
1. **交易手续费**：2-4% APY
2. **PENDLE代币奖励**：5-10% APY
3. **Swap费用**：用户买卖PT/YT时支付
4. **总APY**：8-15%

---

### 操作流程

#### Step 1：选择LP池
**推荐**：
- PT-sDAI池（稳定币，无常损失低）
- PT-aUSDC池（流动性最好）

#### Step 2：添加流动性
1. 准备等值的PT + SY（如5,000 PT + 5,000 aUSDC）
2. 在Pendle点击"Add Liquidity"
3. 确认交易
4. 收到LP代币

#### Step 3：质押LP
1. 质押LP代币到Gauge
2. 开始赚取PENDLE奖励

---

### 无常损失分析

**Pendle LP的特殊性**：
- PT价格随时间推移自动上涨（到期接近1）
- 无常损失可预测

**示例**：
- 添加流动性：$5K PT（$0.95）+ $5K aUSDC
- 300天后PT接近$1
- PT价格上涨5% → 无常损失约0.6%
- 但手续费+奖励（12% APY）覆盖无常损失

**结论**：Pendle LP无常损失可控

---

## 🧮 隐含APY计算

### PT隐含APY

**公式**：
隐含APY = ((1 / PT价格) - 1) / 剩余天数 × 365

**快速估算表**：
| PT价格 | 剩余天数 | 隐含APY |
|--------|----------|---------|
| $0.95 | 365 | 5.26% |
| $0.90 | 365 | 11.11% |
| $0.95 | 180 | 10.69% |
| $0.98 | 90 | 8.29% |

**规律**：
- PT价格越低 → 隐含APY越高
- 剩余天数越少 → 隐含APY对价格越敏感

---

### YT隐含APY

**公式**：
YT隐含APY = (底层APY × (1 / YT价格)) - (1 / 剩余年限)

**复杂！建议直接查看Pendle仪表盘显示的隐含APY**

---

## 📅 到期日管理

### 到期日滚动策略

**问题**：PT/YT到期后需要重新投资

**策略**：阶梯式到期
- 1月：$5K投资PT（3月到期）
- 2月：$5K投资PT（6月到期）
- 3月：$5K投资PT（9月到期）

**好处**：
- 平滑现金流
- 降低再投资风险（利率波动）

---

### 自动滚动工具

**Yearn/Beefy整合Pendle**：
- 自动到期赎回
- 自动购买新期限PT
- 省去手动操作

---

## 🐂🐻 牛熊市场策略

### 牛市策略

**特征**：DeFi收益率上升（借贷需求增加）

**操作**：
1. **买入YT**（放大收益率上升）
2. 例如：买入YT-aUSDC
3. 如果APY从5%涨至8% → YT价格涨60%+

**风险**：如果牛市未到，YT归零

---

### 熊市策略

**特征**：DeFi收益率下降（借贷需求减少）

**操作**：
1. **买入PT**（锁定当前高APY）
2. 例如：当APY=8%时买入PT，锁定收益
3. 即使APY降至3%，你仍获得8%

**对比**：
- 直接Aave：APY 8% → 3%，收益减少
- 持有PT：锁定8%，不受影响

---

### 震荡市策略

**特征**：收益率波动，方向不明

**操作**：
1. **提供LP**（赚取中性收益）
2. 不赌收益率方向
3. 稳定赚取交易手续费+PENDLE奖励（8-12%）

---

## ⚠️ 风险与对冲

### 主要风险

#### 1. 到期风险
**PT风险**：
- 提前卖出可能亏损（如果利率上升，PT价格下跌）
- 对策：持有至到期（确保1:1赎回）

**YT风险**：
- 到期归零
- 对策：只用小额资金（5-10%资产）

---

#### 2. 流动性风险
**问题**：小池子滑点高

**数据**（PT-GLP池）：
- 流动性：$30M
- 买入$1M PT：滑点2%
- 买入$10M PT：滑点15%

**对策**：
- 大额分批买入
- 选择流动性>$50M的池子

---

#### 3. 智能合约风险
**Pendle安全评分**：8.5/10

**审计**：
- Ackee Blockchain（2023）
- Zellic（2024）
- 无重大黑客事件

**风险**：
- 新协议（2021年上线）
- 复杂度高（合约风险大于Aave）

---

### 对冲策略

**组合对冲**：
- 50%买入PT（固定收益）
- 25%买入YT（博取上涨）
- 25%提供LP（中性收益）

**结果**：
- 收益率上升：YT盈利覆盖PT机会成本
- 收益率下降：PT保护+LP稳定收益
- **降低波动，稳定收益**

---

## 💰 真实收益案例

### 案例1：保守型（$20K，买入PT）

**配置**：
- 买入PT-sDAI（到期日2025年6月）
- PT价格：$0.97
- 隐含APY：6.2%

**成本**：
- 本金：$20,000
- Gas费：$10

**6个月后收益**：
- 到期赎回：$20,000 / 0.97 = $20,619
- 收益：$619
- 年化APY：6.2%

**对比直接Aave**（假设APY降至3%）：
- 直接Aave收益：$20K × 3% ÷ 2 = $300
- PT额外收益：$619 - $300 = **$319**

---

### 案例2：激进型（$5K，买入YT）

**配置**：
- 买入YT-GLP（到期日2025年9月）
- YT价格：$0.12
- 当前GLP APY：15%

**成本**：
- 本金：$5,000
- 获得：41,666 YT

**9个月后（APY保持15%）**：
- GLP收益：$41,666 × 15% × 0.75年 = $4,687
- YT赎回价值：$4,687
- 亏损：$5,000 - $4,687 = **-$313**（-6.3%）

**如果APY涨至20%**：
- GLP收益：$41,666 × 20% × 0.75 = $6,250
- 盈利：$6,250 - $5,000 = **$1,250**（+25%）

**高风险高收益！**

---

### 案例3：平衡型（$30K，LP挖矿）

**配置**：
- PT-aUSDC LP池
- 提供$15K PT + $15K USDC

**收益**：
- 交易手续费：3% APY = $900/年
- PENDLE奖励：8% APY = $2,400/年
- 总APY：11%
- **年收益**：$3,300

**无常损失**：
- PT价格从$0.95涨至$1
- 无常损失：0.6% = $180
- 净收益：$3,300 - $180 = **$3,120**

---

## ❓ 常见问题FAQ

**Q1：Pendle和Aave有什么区别？**
> **Aave是借贷**（存款赚浮动利息），**Pendle是利率衍生品**（拆分本金和利息分别交易）。Pendle适合：①锁定固定收益（买PT）②放大收益率（买YT）③交易利率波动。Aave更简单，Pendle更灵活但复杂。

**Q2：PT到期后一定能赎回吗？**
> **是的！** PT到期后1:1赎回底层资产。除非底层协议出问题（如Aave被黑），否则PT赎回100%保证。风险：到期前卖出可能亏损（价格波动）。

**Q3：YT会归零吗？**
> **到期后会！** YT价值=剩余收益，到期后收益已全部分配 → YT价值归零。如果提前卖出，价格取决于剩余收益预期。建议：只用小额资金买YT（高风险）。

**Q4：如何选择到期日？**
> **看策略**。短期（3-6个月）：适合测试，流动性好，但滚动频繁。长期（1-2年）：减少滚动次数，但锁定时间长。建议：新手从6个月期开始。

**Q5：PENDLE代币值得持有吗？**
> **看涨DeFi收益率交易市场的话，值得**。PENDLE用于治理+LP激励。风险：①协议新，采用率不确定②代币通胀（释放计划3年）。建议：LP挖矿获得的PENDLE定期卖出（锁定收益）。

---

## ✅ 执行清单

### 初学阶段（第1-2周）
- [ ] 学习利率衍生品概念（YouTube搜索"Pendle教程"）
- [ ] 理解PT/YT机制（阅读Pendle官方文档）
- [ ] 在测试网体验买卖PT/YT
- [ ] 计算隐含APY（使用Pendle计算器）
- [ ] 小额测试$1K买入PT-sDAI

### 策略部署（第3-4周）
- [ ] 决定策略：保守（PT）/激进（YT）/平衡（LP）
- [ ] 投入$5K-$20K本金
- [ ] 选择合适到期日（6-12个月）
- [ ] 设置到期日提醒（日历/Telegram Bot）
- [ ] 监控隐含APY变化

### 高级优化（持续）
- [ ] 建立阶梯式到期投资组合
- [ ] 对冲策略：50% PT + 25% YT + 25% LP
- [ ] 关注Pendle治理提案（影响手续费分配）
- [ ] 每月再平衡（根据APY预期调整）
- [ ] 学习高级策略（如利差交易、对冲套利）

---

## 🔚 结语

Pendle收益分层策略是**DeFi利率衍生品的创新**：
- ✅ **优势**：固定收益（PT）、杠杆收益（YT）、策略灵活
- ⚠️ **挑战**：学习曲线陡峭、流动性风险、复杂度高

**三个核心要点**：
1. **风险分层**：保守用PT（锁定6-8%），激进用YT（博取20%+），平衡用LP（稳定10%）
2. **到期日管理**：阶梯式投资，避免一次性到期集中风险
3. **市场判断**：牛市买YT（做多利率），熊市买PT（锁定高利率），震荡做LP（中性收益）

Pendle是**高级DeFi玩家的收益优化工具**！📊💰
`,

  steps: [
    { step_number: 1, title: '核心概念学习', description: '深入理解PT（本金代币）和YT（收益代币）的拆分机制，学习零息债券和收益率杠杆概念，观看Pendle官方教程视频（YouTube 20分钟），阅读白皮书理解隐含APY计算公式，在Pendle测试网练习买卖PT/YT操作（无成本试错）。', estimated_time: '10–15 小时' },
    { step_number: 2, title: '隐含APY计算与池子选择', description: '访问Pendle App查看各池子隐含APY（PT-sDAI/PT-aUSDC/PT-GLP），学习使用隐含APY计算器（公式：(1/PT价格 - 1) / 剩余天数 × 365），对比不同到期日的收益率曲线，选择流动性>$50M的池子（降低滑点），评估底层资产风险（Aave vs Lido vs GMX）。', estimated_time: '3–5 小时' },
    { step_number: 3, title: '小额策略测试', description: '选择保守策略测试：$1K-$5K买入PT-sDAI（锁定固定收益6-8%），或激进策略测试：$500-$1K买入YT-GLP（博取高收益），设置到期日提醒（Google Calendar/Telegram Bot），观察7-14天PT价格随到期日接近而上涨，记录实际APY与隐含APY的偏差。', estimated_time: '1–2 周' },
    { step_number: 4, title: '规模化与组合配置', description: '确认策略可行后增加至$10K-$50K本金，建立对冲组合：50% PT（固定收益）+ 25% YT（杠杆收益）+ 25% LP（交易手续费），设置阶梯式到期日（3月/6月/9月分散投资），每周检查隐含APY变化（利率上升时加仓PT，利率下降时减仓）。', estimated_time: '5–10 小时' },
    { step_number: 5, title: '长期管理与滚动投资', description: '到期前30天开始规划再投资（滚动至新到期日），监控底层协议APY变化（Aave/Lido利率趋势），收割PENDLE代币奖励并决定持有或卖出，每月再平衡组合（根据市场环境调整PT/YT/LP比例），学习高级策略（如利差交易、跨池套利）。', estimated_time: '每周1小时' },
  ],
};

async function getAuthToken() {
  const response = await axios.post(`${DIRECTUS_URL}/auth/login`, {
    email: 'the_uk1@outlook.com',
    password: 'Mygcdjmyxzg2026!',
  });
  return response.data.data.access_token;
}

async function addGuide() {
  try {
    const token = await getAuthToken();

    const strategy = {
      ...GUIDE_CONFIG,
      status: 'published',
      is_featured: true,
      view_count: 0,
      bookmark_count: 0,
      published_at: new Date().toISOString(),
    };

    const response = await axios.post(
      `${DIRECTUS_URL}/items/strategies`,
      strategy,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      },
    );

    console.log('\n✅ Pendle 收益分层策略创建成功!');
    console.log(`   ID: ${response.data.data.id}`);
    console.log(`   Slug: ${response.data.data.slug}`);
    console.log(`   访问: http://localhost:3000/strategies/${response.data.data.slug}\n`);
  } catch (error) {
    console.error('\n❌ 创建失败:', error.response?.data || error.message);
  }
}

addGuide();