// 策略 33.1 & 33.2: 衍生品策略 (Derivatives Strategies) - 波动率策略 (Volatility Strategies)
// category_l1: derivatives
// category: volatility
// category_l2: volatility

const axios = require('axios');

/**
 * 33.1 VIX 指数期货套利 / DVOL 波动率交易
 */
const STRATEGY_33_1 = {
  title:
    'VIX / DVOL 波动率指数期货套利 - 交易恐慌与平静本身，而不是只赌价格方向',
  slug: 'vix-dvol-volatility-index-futures-arbitrage',
  summary:
    'VIX / DVOL 波动率指数期货套利，是一种围绕波动率本身而不是只赌价格方向的策略。在传统金融中，对应 VIX 指数期货和期权的期限结构套利、跨品种波动率价差等玩法；在加密市场中，则借助 Deribit DVOL 等隐含波动率指数和期权隐含波动率曲面，交易市场恐慌与平静的错定价。通过做多或做空短期与长期波动率、构建波动率价差组合，赚取情绪回归和波动率均值回归带来的结构性收益。该策略适合对期权、隐含波动率和希腊值有一定理解的进阶玩家或团队。',
  category: 'volatility',
  category_l1: 'derivatives',
  category_l2: 'volatility',
  risk_level: 4,
  apy_min: 8,
  apy_max: 60,
  min_investment: 2000,
  time_commitment:
    '需要每周多次跟踪波动率指数、期权隐含波动率曲面和宏观事件，不适合完全放养型玩家',
  status: 'published',
  content: `# 33.1 VIX / DVOL 波动率指数期货套利 - 交易恐慌与平静本身，而不是只赌价格方向

---

## 一、策略一句话说明

不再只盯着 BTC 或 ETH 的价格涨跌，而是直接交易市場情绪。通过波动率指数和期权隐含波动率曲面判断市場高恐慌或过度平静，围绕波动率本身构建多空组合，利用波动率均值回归、期限结构变化和跨品种错定价来获利。

当市場过度紧张时，未来往往会慢慢冷静下来；  
当市场过于平静时，某个时刻又会被激活。  
本策略，就是围绕这两个过程设计的系统化玩法。

---

## 二、适用标的与市场环境

一类是传统金融世界的 VIX 指数期货和期权；  
另一类是加密世界中的 DVOL 这类波动率指数，以及 BTC、ETH 等主流币的期权市场。

在你的平台里，可以用更通俗的方式描述给用户：

- 标的类别  
  1. BTC 波动率指数  
  2. ETH 波动率指数  
  3. 交易所提供的波动率期货或变差合约  
  4. 由多腿期权组合构出来的波动率头寸

- 适合的市场环境  
  1. 有明确的宏观主题或链上叙事  
  2. 事件密集前后，例如减半、FOMC、ETF 批准或拒绝  
  3. 波动率明显偏离历史平均水平的时候

在这些环境里，市场情绪往往出现稳定的模式：  
要么恐慌被急剧放大，要么过度平静，  
而波动率金融产品会把这种情绪写进价格里面。

---

## 三、从价格到波动率：用户视角的直觉转变

很多新手只会问几个问题：

- BTC 还会不会涨  
- ETH 会不会跌到某个价格  
- 这个位置追不追

而波动率交易者关心的问题是：

- 接下来一个月，波动会不会比现在更大  
- 市场现在有没有把恐慌定价得太贵  
- 当前隐含波动率是否远高于过去半年平均水平  
- 期限结构是否反常，例如短期波动率远高于长期

可以在玩法卡片里用对比方式来教育用户：

- 价格交易者：在问会涨还是会跌  
- 波动率交易者：在问接下来会不会剧烈晃动

价格是方向，波动率是情绪强度。  
而 VIX / DVOL 玩法就是直接交易情绪强度。

---

## 四、典型结构一：波动率均值回归型交易

第一类思路，是最直观的均值回归。

步骤拆解：

1. 收集 DVOL 历史数据  
   - 例如过去 180 天或 365 天  
   - 计算滚动平均值和标准差

2. 定义高位区和低位区  
   - 当当前值高于平均值加上两倍标准差  
   - 视为极端高波动或极端恐慌  
   - 当当前值低于平均值减两倍标准差  
   - 视为极端平静或波动率被低估

3. 行动逻辑  
   - 极端高波动区：  
     偏向做空波动率  
     用期权组合、波动率期货等工具  
   - 极端低波动区：  
     偏向做多波动率  
     通过买跨式或买入波动率产品

同时向用户强调：  
均值回归不是马上发生，而是概率过程。  
所以仓位与时间窗口都必须更加稳健。

---

## 五、典型结构二：期限结构套利

第二类思路，是关注不同期限的波动率之间的形状变化。

示例场景：

- 短期 DVOL 明显高于长期  
  表示市场认为近期很危险，远期相对平静  
- 长期 DVOL 反而高于短期很多  
  表示前方有大周期不确定性，比如减半、政策拐点

对于经验丰富的玩家，可以提供以下两种结构示例：

1. 做空暴涨的短期波动率，做多偏低的长期波动率  
   - 构建类似日历价差结构  
   - 通过卖出近期高波动率期权，买入远期相对便宜的期权  
   - 收益来源是期限结构从畸形恢复为正常

2. 反向操作，在过度平静的短期中买入波动率  
   - 当短期 DVOL 被压得过低  
   - 而你知道有即将到来的高影响事件  
   - 可以通过买入近期期权来捕捉事件波动

玩法卡片中不必讲太多公式，可以用图形解释：  
画一条短期 DVOL 曲线和长期 DVOL 曲线，  
让用户看到“短期很高、长期很低”的畸形形状，  
再告诉他，我们要套利的就是这种形状恢复正常的过程。

---

## 六、典型结构三：跨品种波动率价差

第三类思路，是在不同资产的波动率之间做价差。

常见搭配：

- BTC 波动率 vs ETH 波动率  
- ETH 波动率 vs 某个叙事龙头币的波动率

直觉上：

- 在某些阶段，ETH 的波动率可能长期高于 BTC  
- 但如果某一段时间 ETH 波动率被抬得过高  
  而 BTC 波动率保持平稳  
  就可能出现短期的错位机会

可以设计形象故事：

- 一段时间内，所有人都在讨论某个链上生态  
- ETH 期权市场被交易得非常火热  
- 隐含波动率被情绪推得很高  
- 而 BTC 在同一时期相对平静  

如果你认为这种差异并不合理：

- 可以构造组合  
  一边是做空 ETH 波动率  
  一边是做多 BTC 波动率  
- 等待市场情绪回归  
  即 ETH 波动率下降  
  BTC 波动率回到正常或略有提升  
- 套利的就是波动率差值的收敛

---

## 七、落地到期权结构：如何把指数交易变成可执行头寸

对于普通用户，不需要讲太多希腊字母公式。  
可以提供这样的映射说明：

- 做多波动率  
  1. 买入跨式期权组合  
  2. 买入宽跨式期权  
  3. 购买交易所提供的波动率多头产品

- 做空波动率  
  1. 卖出跨式或宽跨式  
  2. 构建带保护的波动率空头，比如蝶式  
  3. 订阅带收益上限的波动率卖出策略

你可以在玩法卡片中提供两三个标准模板，  
每个模板配一个简单表格，例如：

- 目标：做多短期波动率  
- 工具：BTC 七天跨式  
- 止盈止损逻辑：  
  当波动率在事件后明显回落，或者期权损耗超过一定比例时离场

---

## 八、风险拆解：为什么波动率交易不适合无准备的新手梭哈

要在玩法中讲清楚几点：

1. 波动率不是稳赚不赔  
   高波动率可以更高，低波动率可以更低  
   做空波动率会遇到尾部风险，做多波动率会遇到时间损耗

2. 工具层复杂  
   期权，波动率期货，变差合约背后都有金融工程逻辑  
   对新手来说，理解成本很高，不适合立刻重仓

3. 流动性与滑点  
   波动率产品常常集中在少数平台，  
   某些期限或执行价可能非常不活跃，  
   实际成交价格和指数理论值之间可能差很多

4. 黑天鹅与风控  
   做空波动率，本质上是在卖保险  
   多年的保费收入可能被一次极端事件完全抵消甚至超额亏损  
   必须严格限制仓位和杠杆水平

---

## 九、实战使用前的准备清单

给用户一份简洁的准备清单，让他知道自己是否适合触碰这个模块：

- 你是否已经理解期权的基本概念  
- 你是否明白时间价值、隐含波动率和实现波动率的区别  
- 你是否可以接受一次交易可能跨越数周甚至数月  
- 你是否已经为波动率策略设置了清晰的资金上限  
- 你是否愿意先用纸面模拟一两次，再投入真金白银

---

## 十、小结：把波动率当成一条独立的资产线

对于你的平台用户，可以用一段总结性说明：

过去，他们眼里只有一条价格曲线。  
做多做空，都只是围绕价格本身在操作。

而本策略向他们展示的是另一条曲线：  
那条代表恐慌与平静的波动率曲线。

在宏观叙事、链上故事、监管新闻的推动下，  
波动率会像一根紧绷的橡皮筋，被不断拉紧和放松。  

VIX 和 DVOL 类玩法，就是教他们：  
如何在这根橡皮筋被拉得太紧或太松的时候，  
利用金融工具去做一笔结构性的交易。

这不再是简单赌方向，而是一种更高维度的铲子。  

`
};

/**
 * 33.2 Gamma Scalping 伽马剥头皮
 */
const STRATEGY_33_2 = {
  title:
    'Gamma Scalping 伽马剥头皮 - 用高频现货对冲，把波动本身榨成现金流',
  slug: 'gamma-scalping-volatility-trading',
  summary:
    'Gamma Scalping 伽马剥头皮，是在持有长 Gamma、短 Theta 的期权组合基础上，通过高频或中频的现货对冲操作，把价格来回波动转化为一笔笔对冲收益。典型做法是买入接近平值的跨式期权或其他长 Gamma 结构，让仓位对价格波动高度敏感，然后根据 Delta 的变化不断买入或卖出现货，使净 Delta 维持在近似中性区间。在震荡行情中，对冲产生的收益有机会覆盖期权时间价值损耗，从而形成长期可持续的波动盈利模式。该策略对执行纪律和成本控制要求极高，更适合作为进阶玩家的技能树模块。',
  category: 'volatility',
  category_l1: 'derivatives',
  category_l2: 'volatility',
  risk_level: 4,
  apy_min: 10,
  apy_max: 80,
  min_investment: 3000,
  time_commitment:
    '需要日内多次检查与执行对冲操作，对盯盘和自动化交易有较高要求',
  status: 'published',
  content: `# 33.2 Gamma Scalping 伽马剥头皮 - 用高频现货对冲，把波动本身榨成现金流

---

## 一、策略一句话说明

先买一份对价格双向波动非常敏感的期权组合，  
再用现货高频对冲，把每一次小波动都变成一笔小收益，  
只要这些小收益足够多，就可以盖过期权的时间价值损耗，  
最终形成一个在震荡市里稳定抽水的系统。

---

## 二、直觉类比：拿着弹簧和水桶的人

可以这样讲给你的用户听：

想象你拿着一根弹簧，价格就是弹簧的两端。  
你花钱买了一套机械装置，让这根弹簧一旦被拉长或压缩，  
装置就会立刻把这种形变转换为机械能。

这套装置就是长 Gamma 的期权组合。  
而水桶是你的现货账户。  
当弹簧被拉长，你适时卖一些现货，  
当弹簧回落或被压缩，你再买回一些现货。

只要价格在一个区间里反复拉伸和回落，  
你就能不断通过这套装置，把能量一点点装进水桶里。

---

## 三、基础构件：长 Gamma 组合和现货对冲

从结构上看，Gamma Scalping 由两部分组成：

1. 长 Gamma 的期权组合  
   - 最常见的是近月平值跨式  
   - 也可以是近月宽跨式、蝶式等有 Gamma 暴露的结构  
   - 特征是：价格稍微动一点，Delta 变化就很快

2. 负责对冲的现货账户  
   - 用于买入或卖出标的资产，比如 BTC 或 ETH  
   - 每次价格波动导致 Delta 偏离零点时，  
     通过买卖现货把整体仓位调回接近 Delta 中性

在玩法卡片中要强调一个核心点：

- 你不是在赌方向  
- 你是在利用价格来回晃动这件事本身

---

## 四、Gamma Scalping 的典型操作节奏

可以将流程拆成一个简单的循环，让用户容易理解：

第一步：建仓长 Gamma

- 选择标的，比如 BTC  
- 选择到期时间，比如 7 天后到期的期权  
- 选择执行价接近当前现货价格  
- 买入相同张数的看涨和看跌，构建一个平值跨式  
- 此时，你是长 Gamma、短 Theta

第二步：观察价格微小变化

- 当 BTC 更新价格时，你的期权组合 Delta 会发生变化  
- 例如价格略微上涨，组合 Delta 变成正值  
- 价格略微下跌，组合 Delta 变成负值

第三步：用现货对冲 Delta

- 如果组合 Delta 变成正值太多  
  就在现货市场卖出少量 BTC  
  让整体 Delta 回到接近零  
- 如果组合 Delta 变成负值太多  
  就在现货市场买入少量 BTC  

第四步：重复这个过程

- 当价格围绕某个重心上下波动时  
  你的对冲行为就会反复在高位卖出、低位买入  
  形成一笔笔已实现的对冲收益

最后的关键，是看对冲收益总和是否大于期权时间价值损耗。

---

## 五、对用户讲清楚的两个核心概念

在玩法文案中，可以用通俗描述代替专业术语：

一是 Delta 中性

- 简单理解为：  
  不希望组合整体偏多或偏空  
  而是希望它对价格方向的敏感度为零附近  
- 这意味着你不靠赌涨跌赚钱  
  而是靠来回波动赚钱

二是时间价值的成本

- 你买入的期权，就像买了一张计时的通行证  
- 时间一秒一秒流逝，通行证会不断贬值  
- 如果价格不怎么波动，你就等于白烧了这张通行证  
- 所以 Gamma Scalping 的目标是  
  在通行证失效之前，从波动中榨出足够多的收益

只要这两个点讲明白，用户就知道：  
这是在用波动对抗时间的损耗。

---

## 六、适合使用 Gamma Scalping 的市场环境

Gamma Scalping 并非在所有行情下都适合使用。  
可以帮用户给出几个典型适用场景：

1. 预期将出现明显的震荡行情  
   - 比如重要事件前后的反复试探  
   - 大级别区间盘整阶段  
   - 上下有明显支撑和阻力的区间内

2. 目前隐含波动率水平相对合理或略低  
   - 如果隐含波动率特别高，  
     买 Gamma 的成本会非常昂贵  
   - 这意味着需要更剧烈的波动才能覆盖时间价值损耗

3. 标的流动性良好  
   - 现货市场交易深度足够  
   - 对冲时滑点可控  
   - 期权市场有一定成交量，价差不过分离谱

可以在你的平台中配一个 Tag：

- 适用行情：震荡市、事件前后、宽幅盘整区间  
- 不适用行情：单边强趋势、极端无波行情

---

## 七、执行参数与节奏设计

为了让用户感到这个玩法是可控的，可以给出参数层面的范例：

1. 期权选择

- 标的：BTC 或 ETH 等流动性最好品种  
- 到期时间：7 天到 14 天的短期为主  
- 执行价：接近平值或者稍微偏内的执行价  
- 数量：根据整体资金规模控制在合理比例

2. 对冲频率

- 定义一个目标 Delta 区间  
  比如整体 Delta 维持在正负 0.1 之间  
- 当 Delta 偏离超出这个范围时才执行对冲  
- 每天最多对冲次数设置一个上限  
  比如不超过 20 次  
  避免过度交易

3. 单次对冲规模

- 根据当前 Delta 偏离程度决定对冲规模  
- 可以定义最小单位和最大单位  
- 避免一次对冲过度反向，导致状态震荡不稳

4. 时间窗口

- 通常在期权剩余时间还比较充裕时进行频繁对冲  
- 接近到期前，根据波动和盈亏情况选择  
  提前结束策略或持有到期

---

## 八、收益和风险的拆分说明

在玩法卡里，可以用一个收益分解来教育用户：

收益部分：

- Gamma 带来的波动获利  
  可以理解为对冲过程中高卖低买结构产生的已实现利润  
- 波动率上升带来的额外收益  
  如果在买入组合后波动率继续抬升  
  期权本身也会升值，进一步放大收益

成本和风险：

- 时间价值损耗  
  每一天过去，期权的时间价值会自然消失一部分  
- 手续费和滑点  
  高频对冲必然会让用户付出大量手续费  
  如果费率不够低，可能直接吃掉全部收益  
- 极端行情  
  当行情突然出现大单边时，  
  对冲节奏很可能跟不上价格  
  导致组合出现较大方向性风险

你可以引导用户思考一个问题：  
在高波动、高方向性行情中，是否应该停用 Gamma Scalping，  
而把策略切换到更适合趋势行情的玩法。

---

## 九、适合什么样的玩家

Gamma Scalping 更像是一种专业技能，而不是入门玩法。

在卡片里可以写明：

- 目标人群  
  1. 已经熟悉期权基础概念  
  2. 对行情监控和风控有耐心  
  3. 愿意接受大量微小交易构成整体收益的模式

- 不适合的人群  
  1. 完全不懂期权，只想一键暴富的新手  
  2. 不喜欢频繁盯盘或不想搭建自动化系统的人  
  3. 无法承受短期内组合浮亏波动的玩家

并且强调：

这是一个需要反复练习和复盘的手艺。  
它不是按一次按钮就能长期自动赚钱的魔法机。

---

## 十、实战执行前后，可以给用户的操作清单

执行前：

- 是否已经用小资金做过至少一次纸面模拟  
- 是否已经在测试环境中跑过简单的对冲逻辑  
- 是否清楚自己的资金上限和最大可接受回撤  
- 是否对期权产品和现货市场的手续费结构有完整认知

执行中：

- 是否严格按照预设的 Delta 区间执行，不随意放大风险  
- 是否记录每次对冲的价格和规模  
- 是否定期检查策略是否仍适合当前行情结构  
- 在波动率急剧变化时，是否有应对方案

执行后：

- 统计期内全部对冲收益与期权时间价值损耗  
- 分析哪一段行情最赚钱，哪一段最拖累收益  
- 调整下一个周期的参数设定  
- 决定是否要提升自动化程度，以降低执行负担

---

## 十一、小结：把 Gamma Scalping 放在玩法体系里的定位

在衍生品策略的整体版图中，可以这样向用户描述位置：

- 波动率指数套利模块  
  更偏宏观与结构性，周期较长，频率较低

- Gamma Scalping 模块  
  更偏执行技巧与微观结构，周期较短，频率较高

一个成熟的波动率交易者，往往会两者兼用：

- 用波动率视角判断大致环境  
  当前适合做多 Gamma 还是做空 Gamma  
- 用 Gamma Scalping 的技巧  
  在决定做多 Gamma 的期间，把每一次波动榨干

对于你的平台，这一策略可以被标记为：

高级技能模块，适合已经熟悉期权和网格类玩法的用户，  
作为他们向专业波动率交易者迈进时的重要一阶。

`
};

/**
 * 上传 33.1 & 33.2 策略到 Directus
 */
async function uploadStrategies() {
  const DIRECTUS_URL = 'http://localhost:8055';

  console.log(
    '开始上传策略 33.1 (VIX / DVOL 波动率指数期货套利) 和 33.2 (Gamma Scalping 伽马剥头皮)...\n'
  );

  try {
    // 获取新的管理员令牌
    const { execSync } = require('child_process');
    const tokenOutput = execSync('./get-new-directus-token.sh').toString();
    const tokenMatch = tokenOutput.match(/DIRECTUS_ADMIN_TOKEN=(.+)/);

    if (!tokenMatch) {
      throw new Error('Failed to get admin token');
    }

    const ADMIN_TOKEN = tokenMatch[1].trim();

    const headers = {
      Authorization: `Bearer ${ADMIN_TOKEN}`,
      'Content-Type': 'application/json'
    };

    console.log('上传策略 33.1: VIX / DVOL 波动率指数期货套利...');
    await axios.post(`${DIRECTUS_URL}/items/strategies`, STRATEGY_33_1, {
      headers
    });
    console.log('✅ 策略 33.1 上传成功\n');

    console.log('上传策略 33.2: Gamma Scalping 伽马剥头皮...');
    await axios.post(`${DIRECTUS_URL}/items/strategies`, STRATEGY_33_2, {
      headers
    });
    console.log('✅ 策略 33.2 上传成功\n');

    const response = await axios.get(
      `${DIRECTUS_URL}/items/strategies?limit=1&meta=total_count`,
      { headers }
    );
    console.log(
      `✅ 数据库中现有策略总数: ${response.data.meta.total_count}`
    );
  } catch (error) {
    console.error('❌ 上传失败:', error.response?.data || error.message);
    process.exit(1);
  }
}

// 若需要直接在 Node 中运行本文件写入策略，可以解除下面一行注释：
uploadStrategies();
