const axios = require('axios');

const DIRECTUS_URL = 'http://localhost:8055';
const DIRECTUS_EMAIL = 'the_uk1@outlook.com';
const DIRECTUS_PASSWORD = 'Mygcdjmyxzg2026!';

const STRATEGY_20_4 = {
  title: '期权日历价差套利 - 赚取时间价值差异',
  slug: 'calendar-spread-arbitrage',
  summary: '买入长期期权，卖出短期同行权价期权，利用不同到期日的 IV 差异和 Theta 衰减速度差获利。适合预期波动率稳定的市场环境，年化收益 15-35%。',
  category: 'options-volatility-arbitrage',
  category_l1: 'arbitrage',
  category_l2: 'options-volatility-arbitrage',
  risk_level: 2,
  apy_min: 15,
  apy_max: 35,
  content: `# 期权日历价差套利 - 赚取时间价值差异

> **预计阅读时间：** 20 分钟
> **难度等级：** 高级
> **风险等级：** ⚠️⚠️ 中低（2/5）

---

## 📖 日历价差基础

### 什么是日历价差(Calendar Spread)？

日历价差是一种利用不同到期日期权之间时间价值衰减速度差异的策略。

**核心构成：**
\`\`\`
买入：长期期权（如 60 天到期）
卖出：短期期权（如 7 天到期）
行权价：相同
\`\`\`

**盈利原理：**
- 短期期权 Theta 衰减更快
- 卖出短期期权收取权利金
- 长期期权保值作为保护
- 短期到期后，长期期权仍有价值

### 时间价值衰减曲线

\`\`\`
时间价值
    │
    │  *
    │    *
    │      *
    │        *
    │          **
    │            ***
    │               *****
    └──────────────────── 到期时间
    60天      30天    7天  0

关键观察：
- 最后 7 天衰减最快（约占总时间价值的 30%）
- 60 天期权每天衰减约 1.7%
- 7 天期权每天衰减约 14%
\`\`\`

---

## 🎯 策略核心逻辑

### 经典案例演示

**市场条件：**
- BTC 现价：$60,000
- ATM 期权（$60,000 行权价）

**期权参数：**

| 到期日 | IV | 期权价格 | Theta(/天) | Vega |
|--------|-----|----------|-----------|------|
| 7 天 | 55% | $1,200 | -$170 | $35 |
| 60 天 | 50% | $3,800 | -$28 | $120 |

**构建日历价差：**
\`\`\`
卖出 7 天 $60,000 Call：+$1,200
买入 60 天 $60,000 Call：-$3,800
净支出：$2,600

组合 Greeks：
Theta：-$28 - (-$170) = +$142/天（正 Theta！）
Vega：$120 - $35 = +$85（做多波动率）
\`\`\`

**7 天后（短期期权到期）：**

假设 BTC 保持在 $60,000：
- 短期期权到期作废：赚取全部 $1,200 权利金
- 长期期权剩余 53 天，价值约 $3,600
- 组合价值：$3,600
- 利润：$3,600 - $2,600 = $1,000
- **收益率：38.5%（7天）**

---

## 📊 不同场景分析

### 场景 1：价格保持不变（最佳）
- 短期期权到期作废
- 长期期权保留大部分时间价值
- 利润最大化

### 场景 2：价格大幅波动
- 短期期权可能被行权
- 需要管理行权风险
- 应对：选择略 OTM 的行权价

### 场景 3：IV 变化
- IV 上升：长期期权 Vega 更大，价值增加更多，额外利润
- IV 下降：长期期权损失更大，部分抵消 Theta 收益

---

## 🔧 实操指南

### 选择合适的期权

**行权价选择：**
- ATM 或略 OTM（Delta 0.4-0.5）
- ATM 有最大 Theta，但风险也大
- 略 OTM 更安全

**到期日选择：**
\`\`\`
短期：7-14 天（Theta 最大）
长期：45-90 天（时间价值保护）

比例建议：
- 1:6（7天 vs 42天）
- 1:8（7天 vs 56天）
\`\`\`

### 展期策略

短期到期后，可以继续卖出新的短期期权：
- 连续收取时间价值
- 当长期期权 < 30 天时停止展期

---

## ⚠️ 风险与应对

| 风险类型 | 严重程度 | 应对策略 |
|----------|----------|----------|
| **Pin Risk** | 中 | 提前平仓短期腿 |
| **IV 下降** | 中 | 选择低 IV 环境入场 |
| **方向风险** | 低 | Delta 中性调整 |

---

## 📈 收益预期

| 市场状态 | 单次收益 | 周期 | 年化 |
|----------|----------|------|------|
| 理想（价格稳定） | 8-15% | 7天 | 50-100% |
| 正常 | 4-8% | 7天 | 25-50% |
| 不利（大幅波动） | -5-0% | 7天 | N/A |

**保守估计年化：15-35%**

> ⚠️ **重要提示：** 日历价差最适合预期低波动的市场。在高波动环境下，短期期权可能被行权，造成损失。`,
  status: 'published'
};

const STRATEGY_20_5 = {
  title: 'Box Spread 合成融资 - 无风险利率套利',
  slug: 'box-spread-synthetic-financing',
  summary: '通过期权构建 Box Spread 组合（买入看涨价差+卖出看跌价差），锁定到期收益，获得低于市场利率的融资或无风险套利。适合大资金低风险偏好者，年化收益 5-15%。',
  category: 'options-volatility-arbitrage',
  category_l1: 'arbitrage',
  category_l2: 'options-volatility-arbitrage',
  risk_level: 1,
  apy_min: 5,
  apy_max: 15,
  content: `# Box Spread 合成融资 - 无风险利率套利

> **预计阅读时间：** 18 分钟
> **难度等级：** 高级
> **风险等级：** ⚠️ 极低（1/5）

---

## 📖 Box Spread 原理

### 什么是 Box Spread？

Box Spread 是一个由四个期权组成的组合，到期时收益完全确定，相当于一笔"合成贷款"。

**组合结构：**
\`\`\`
低行权价（K1）：买入 Call，卖出 Put
高行权价（K2）：卖出 Call，买入 Put

等价于：
买入 Bull Call Spread（K1-K2）
卖出 Bull Put Spread（K1-K2）
\`\`\`

### 为什么收益确定？

**到期时组合价值 = K2 - K1（恒定）**

\`\`\`
假设 K1 = $55,000，K2 = $60,000

情况 1：到期价格 < K1（如 $50,000）
- 净值：$5,000

情况 2：K1 < 价格 < K2（如 $57,000）
- 净值：$5,000

情况 3：价格 > K2（如 $65,000）
- 净值：$5,000

结论：无论到期价格如何，组合价值 = K2 - K1 = $5,000
\`\`\`

---

## 🎯 套利逻辑

### 套利机会来源

**理论定价：**
\`\`\`
Box Spread 价值 = (K2 - K1) × e^(-rT)

其中 r = 无风险利率，T = 到期时间

如果市场价格 ≠ 理论价值，存在套利空间
\`\`\`

**实际例子：**
- K2 - K1 = $5,000
- 到期时间 = 30 天
- 无风险利率 = 5%
- 理论价值 = $4,979.45

如果市场价格 = $4,900（折价）：
- 买入 Box Spread：$4,900
- 到期收入：$5,000
- 利润：$100
- 年化收益：24.8%

### 两种套利方向

**1. 借入资金（Box 折价时）**
\`\`\`
支付 $4,900（Box 价格）
到期收到 $5,000
隐含利率高于市场利率
\`\`\`

**2. 贷出资金（Box 溢价时）**
\`\`\`
收到 $5,020（卖出 Box）
到期支付 $5,000
隐含利率低于市场利率
\`\`\`

---

## 📊 实战操作

### 案例：Deribit BTC Box Spread

**市场条件：**
- BTC 现价：$60,000
- 30 天后到期
- 选择 K1 = $55,000，K2 = $65,000

**期权市场价格：**

| 期权 | 类型 | 行权价 | 价格 | 操作 |
|------|------|--------|------|------|
| A | Call | $55,000 | $6,200 | 买入 |
| B | Put | $55,000 | $450 | 卖出 |
| C | Call | $65,000 | $1,100 | 卖出 |
| D | Put | $65,000 | $5,800 | 买入 |

**Box Spread 成本计算：**
\`\`\`
买入成本：$6,200 + $5,800 = $12,000
卖出收入：$450 + $1,100 = $1,550
净成本：$10,450

到期价值：$10,000

隐含利率 = (10,450 - 10,000) / 10,000 × (365/30) = 54.8%
\`\`\`

**寻找套利机会：**
当市场 IV 异常或定价错误时，可能出现 Box 折价：
\`\`\`
如果净成本 = $9,800
到期价值 = $10,000
利润 = $200
年化 = 24.5%
\`\`\`

---

## 🔧 执行要点

### 同时执行四笔交易

**关键：原子性执行**
- 四笔交易需要尽快完成
- 避免部分成交导致的风险敞口
- 使用 API 自动化执行

### 持有到期

**注意事项：**
- 欧式期权：自动结算
- 美式期权：可能被提前行权（避免使用）
- 确保有足够保证金

---

## ⚠️ 风险与应对

| 风险类型 | 严重程度 | 应对策略 |
|----------|----------|----------|
| **执行风险** | 中 | 使用限价单，分批执行 |
| **流动性风险** | 中 | 选择主流行权价 |
| **提前行权** | 中 | 仅使用欧式期权 |
| **交易所风险** | 低 | 选择信誉交易所 |

### 成本考量

\`\`\`
交易手续费：4 × 0.03% = 0.12%
保证金占用成本：约 0.5-1%
滑点损失：约 0.5-1%

总成本：约 1-2%

因此需要 > 2% 的套利空间才能盈利
\`\`\`

---

## 💡 实战技巧

### 寻找定价异常时机

**高概率出现时机：**
- 市场极端波动时
- 流动性枯竭时
- 大户平仓时

### 选择最优行权价

**推荐：**
- K1、K2 都是高流动性行权价
- 间距适中（$5,000-$10,000 for BTC）
- 避免太深 ITM/OTM

---

## 📈 收益预期

| 市场状态 | 隐含利率 | 套利空间 | 年化收益 |
|----------|----------|----------|----------|
| 正常 | 5-8% | 0-2% | 0-5% |
| 波动 | 10-20% | 5-15% | 5-15% |
| 极端 | 20-50% | 15-40% | 15-40%（罕见）|

**保守估计年化：5-15%**

> ⚠️ **重要提示：** Box Spread 套利机会在高效市场中较少出现。需要实时监控多个交易所，并准备大量资金以抓住短暂机会。由于是无风险套利，一旦出现会被迅速抹平。`,
  status: 'published'
};

async function main() {
  try {
    console.log('认证中...');

    const authResponse = await axios.post(`${DIRECTUS_URL}/auth/login`, {
      email: DIRECTUS_EMAIL,
      password: DIRECTUS_PASSWORD
    });

    const token = authResponse.data.data.access_token;
    console.log('认证成功！\n');

    const config = {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    };

    const strategies = [STRATEGY_20_4, STRATEGY_20_5];

    for (const strategy of strategies) {
      const existingResponse = await axios.get(
        `${DIRECTUS_URL}/items/strategies?filter[slug][_eq]=${strategy.slug}`,
        config
      );

      if (existingResponse.data.data && existingResponse.data.data.length > 0) {
        console.log(`⏭️  策略 "${strategy.title}" 已存在，跳过`);
        continue;
      }

      await axios.post(
        `${DIRECTUS_URL}/items/strategies`,
        strategy,
        config
      );

      console.log(`✅ 策略创建成功: ${strategy.title}`);
      console.log(`   Slug: ${strategy.slug}`);
      console.log(`   APY: ${strategy.apy_min}-${strategy.apy_max}%\n`);
    }

    const countResponse = await axios.get(
      `${DIRECTUS_URL}/items/strategies?limit=0&meta=total_count`,
      config
    );

    console.log('========================================');
    console.log(`📊 数据库中策略总数: ${countResponse.data.meta.total_count}`);
    console.log('========================================');

  } catch (error) {
    console.error('❌ 错误:', error.response?.data || error.message);
    process.exit(1);
  }
}

main();
