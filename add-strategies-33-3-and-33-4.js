// 策略 33.3 & 33.4: 衍生品策略 (Derivatives Strategies) - 波动率策略 (Volatility Strategies)
// category_l1: derivatives
// category: volatility
// category_l2: volatility

const axios = require('axios');

/**
 * 33.3 Calendar Spread 日历价差
 *
 * 一级分类: 衍生品策略 (Derivatives Strategies)
 * category_l1: derivatives
 * category: volatility
 * category_l2: volatility
 *
 * 核心：利用“同一执行价、不同到期日”期权之间的时间价值和波动率定价差，
 *       通过买入长期期权、卖出短期期权，赚取时间价值衰减差和波动率结构变化。
 */
const STRATEGY_33_3 = {
  title:
    'Calendar Spread 日历价差 - 用时间价值差与期限波动结构做的精细波动率交易',
  slug: 'calendar-spread-volatility-term-structure',
  summary:
    'Calendar Spread（日历价差）是一种利用同一执行价、不同到期日的期权之间时间价值与隐含波动率差异的策略：典型做法是买入长期期权、卖出短期期权，在价格大致围绕某个中枢震荡时，通过短期期权更快的时间价值衰减获得净收益。它本质上是一种“做多远期波动率、做空近期波动率”的期限结构交易，同时对价格方向不完全敏感，更关注波动率和时间结构本身的变化。适合作为波动率进阶玩家从“看涨看跌”升级到“时间与结构交易”的一块关键技能。',
  category: 'volatility',
  category_l1: 'derivatives',
  category_l2: 'volatility',
  risk_level: 3,
  apy_min: 8,
  apy_max: 50,
  min_investment: 1500,
  time_commitment:
    '以天/周为单位跟踪，不需要盯盘式高频操作，但需要持续关注波动率和事件节奏',
  status: 'published',
  content: `# 33.3 Calendar Spread 日历价差 - 用时间价值差与期限波动结构做的精细波动率交易

---

## 一、策略一句话说明

在同一个执行价上，同时持有两份到期日不同的期权：

- 买入到期时间更长的期权（通常时间价值较多、对波动敏感）；  
- 卖出到期时间更短的期权（时间价值衰减更快）；  

在标的价格大致围绕某个区间震荡的情况下：

- 短期期权的时间价值会快速衰减；  
- 长期期权的时间价值衰减相对缓慢；  

你赚取的是 **“短期时间价值衰减得比长期快”** 这件事本身，加上对波动率结构变化的判断，而不是只赌价格单方向上涨或下跌。

---

## 二、给用户的直觉类比：租房与长租合约

可以用一个生活化的类比说明日历价差：

- 假设你锁定了一份“未来一年房租”的长期合同（相当于买入长期期权）；  
- 同时，你把这间房短期转租给不同租客，签一个月、两个月的短租合约（相当于卖出短期期权）；  

如果你判断这座城市整体租金不会在短时间暴涨暴跌，而是比较平稳：

- 长约帮你锁住了整体一年内的“使用权”；  
- 一个月一个月的短约租客，会不断帮你“支付时间价值”；  
- 只要短租租金总和超过你自己一年长租成本，你就赚到了“时间差的钱”。

Calendar Spread 的逻辑就是类似这种：

- 不直接赌房价涨跌  
- 而是利用长期与短期租约之间的结构差赚一手

---

## 三、基础结构：同一执行价，不同到期日

日历价差的基本要素有三个：

1. 同一个标的（例如 BTC、ETH）  
2. 同一个执行价（例如 60,000 美元执行价的看涨期权）  
3. 不同到期日（例如 7 天和 30 天到期）

最经典的构造：

- 买入：远月期权（Long远期）  
- 卖出：近月期权（Short近期）  

可以是：

- Call Calendar Spread（看涨方向日历）  
- Put Calendar Spread（看跌方向日历）  

也可以适当做“斜日历”（执行价不完全一致），但在入门玩法里，可以先让用户理解“同一执行价、不同到期”的标准日历结构。

---

## 四、策略逻辑：你到底在赌什么？

日历价差的本质可以拆成三层：

### 1. 赌“时间价值衰减差”

短期期权：

- 时间价值衰减快，特别是临近到期的一两周；  
- 每天 Theta 损耗明显；

长期期权：

- 时间价值更厚，衰减相对平滑；  
- 在短期内不会损耗太多；

当标的价格在短期内没有大幅跑出执行价太远时：

- 你卖出的近月期权时间价值“飞快掉”；  
- 你买入的远月期权时间价值损耗较慢；  

这两者之间形成一个时间价值的“净差”。

### 2. 赌“波动率期限结构的变化”

在波动率维度，你的仓位是：

- 做多长期隐含波动率（Long Long-term IV）；  
- 做空短期隐含波动率（Short Short-term IV）。

当市场从短期恐慌中冷却下来，或者短期被过度压制而长端保持韧性时：

- 期限结构会发生形变；  
- 你在短端和长端的 IV 头寸，就会产生价值变化；  

你赚的不只是时间价值，还包括“波动率曲线重新定价”的那部分钱。

### 3. 对价格方向的敏感度有限但并非零

日历价差一般在价格接近执行价附近时最舒服：

- 如果价格长期维持在执行价附近：  
  - 近月的衰减会最有利于你；  
  - 远月仍然保留较多时间价值；  

- 如果价格暴走：  
  - 大幅远离执行价，  
  - 日历结构可能变得不那么理想，  
  - 最极端情况是方向错得太离谱，组合也会亏损。

所以日历价差不是完全 Delta 中性，只是“相对方向敏感度较低”，并重点把赌注放在时间与波动率结构上。

---

## 五、给用户看的结构示例（概念层面）

可以在玩法里用非常克制的公式式描述（不过多数学细节）：

- 标的：BTC  
- 当前价格：60,000  
- 构造一个看涨日历价差：

1. 买入：  
   - BTC 60,000 行权价  
   - 30 天后到期的看涨期权（Long Call 远期）

2. 卖出：  
   - BTC 60,000 行权价  
   - 7 天后到期的看涨期权（Short Call 近期）

期望场景：

- 接下来 7 天内，BTC 大致在 58,000 - 62,000 区间震荡；  
- 7 天到期时：  
  - 短期卖出的 Call 大部分时间价值消耗完；  
  - 长期买入的 Call 依然有 23 天时间价值；  

此时，用户可以选择：

- 平掉整个组合锁定收益；  
- 或者只平掉短期腿，再重新卖出下一期短期 Call，  
  把这个日历结构滚动下去。

---

## 六、Calendar Spread 的优势和适用玩家

在玩法卡片中，可以用表的方式总结：

- 优势：

  1. 相比单买期权，成本更低，时间价值损耗由卖出腿部分对冲；  
  2. 相比裸卖期权，风险更可控，因为有远期多头作为保护；  
  3. 对方向不需要极精准预测，更看重价格大致停留在某一中枢附近；  
  4. 可以不断滚动短期期权，形成“收租”节奏。

- 劣势/限制：

  1. 结构较为复杂，对新手不够友好；  
  2. 需要理解期权定价、隐含波动率和 Theta 的基本概念；  
  3. 不适合极端单边大趋势行情，可能表现不佳；  
  4. 交易成本、点差和滑点对整体收益影响较大。

适合的玩家画像：

- 已经玩过简单的买入看涨/看跌；  
- 对波动率和时间价值有一些感知；  
- 想从“价格思维”升级到“结构思维”；  
- 接受“这个月赚的不一定很多，但结构是合理的”这种心态。

---

## 七、风险拆解：日历价差可能踩到的坑

为了避免用户误以为这是“高级又安全”的万能策略，需要在文案中清晰写出风险点：

1. 极端单边行情  
   - 如果标的在短时间内远离执行价，例如连续暴涨或暴跌，  
   - 日历结构可能在短期内出现不利情形：  
     例如短期期权被深度实值，而长期期权还没来得及体现优势。  

2. 波动率错误定价  
   - 你以为短期波动率太高，想通过卖出短期波动率赚一笔；  
   - 结果后面连续爆发黑天鹅，短端波动率继续拉升，  
   - 你的“做空短期波动率”会遭受压力。

3. 交易成本与流动性  
   - 如果期权市场流动性不佳，  
   - 买入和卖出的价差很大，  
   - 实际执行出来的结果可能与理论值偏差很大。

4. 时间窗口判断错误  
   - 你以为接下来几天会平静，但市场忽然被消息点燃；  
   - 或者你以为波动会来得很慢，结果事件提前引爆。

---

## 八、实战 Checklist（给平台用户的操作清单）

在你的玩法卡片中，可以直接给出一个行动前的简易清单：

在尝试 Calendar Spread 前，请确认：

1. 你已经理解期权的以下基础概念：  
   - 行权价  
   - 到期日  
   - 时间价值  
   - 隐含波动率（IV）

2. 你可以清楚回答：  
   - 你更看好哪一个价格区间会成为未来几周的“重心”；  
   - 你为什么认为短期会比长期更“贵”或者更“便宜”。

3. 你已经查清楚：  
   - 交易所的期权手续费  
   - 相关执行价和期限上的挂单深度  
   - 点差是否过大

4. 你对这笔策略设置了资金上限：  
   - 例如整个日历结构不超过总资金的 5-10%；  
   - 即使短期方向看错也不会影响你整体账户安全。

只有当这些问题都有了明确答案时，  
Calendar Spread 才是真正为你工作的工具，  
而不是一份你看不懂的复杂玩具。

---

## 九、小结：在波动率模块中的定位

在整个「衍生品策略 / volatility」模块中：

- 33.1 更偏向宏观波动率指数与期限结构套利；  
- 33.2 更偏向用 Gamma Scalping 做日内或短期高频波动交易；  
- 33.3（本策略）则是把“时间结构”具体落实到一个相对温和的期权组合上：

它不是最激进的策略，也不是最简单的策略，  
但却是“从方向交易晋级为结构交易”的重要一阶。  

你的平台可以这样给这个卡片打标签：

- 「时间价值套利」  
- 「期限结构玩法」  
- 「适合期权进阶玩家」

帮助用户形成印象：  
这是一种围绕“时间与波动率期限结构”设计的玩法，  
而不是更多的“梭哈一边赌涨跌”。

`
};

/**
 * 33.4 Butterfly Spread 蝶式价差
 *
 * 一级分类: 衍生品策略 (Derivatives Strategies)
 * category_l1: derivatives
 * category: volatility
 * category_l2: volatility
 *
 * 核心：在预期标的价格将围绕某一中枢、整体波动不大的情况下，
 *       使用有限成本的蝶式结构在该价位附近构建“高性价比收益区”，
 *       实现“亏损有限、收益有限但赔率可观”的低成本方向/波动率组合。
 */
const STRATEGY_33_4 = {
  title:
    'Butterfly Spread 蝶式价差 - 在低波动预期下用有限成本构建高赔率价差结构',
  slug: 'butterfly-spread-low-volatility-structure',
  summary:
    'Butterfly Spread（蝶式价差）是一种同时使用三档执行价期权构建的“有限风险、有限收益、高赔率”的组合结构。在预期标的价格将在某一价格区域附近“收敛”或“波动有限”时，通过买入两端远离执行价的期权、卖出中间执行价的两个期权，在目标价附近构建一个峰值明显的盈亏曲线。相比直接买入单腿期权，蝶式价差的成本更低、方向容错更小但赔率更高；同时风险被限制在已知的最大亏损之内，适合作为对特定价位、特定时间窗口的精细化押注玩法。',
  category: 'volatility',
  category_l1: 'derivatives',
  category_l2: 'volatility',
  risk_level: 3,
  apy_min: 10,
  apy_max: 120,
  min_investment: 1000,
  time_commitment:
    '需要在建仓前明确事件窗口与目标价区域，期间适度关注即可，不需要高频操作',
  status: 'published',
  content: `# 33.4 Butterfly Spread 蝶式价差 - 在低波动预期下用有限成本构建高赔率价差结构

---

## 一、策略一句话说明

当你非常明确地认为：

- 某个时间窗口内，  
- 标的价格更大概率会收敛到一个“目标区域”，  
- 且整体波动不至于大幅冲出上下两端；

你可以通过构建蝶式价差（Butterfly Spread）：

- 在那个目标区域附近构建一个“收益峰”；  
- 付出有限的期权成本（最大亏损已知）；  
- 换取在价格收敛到该区域时的高赔率收益。

它就像在价格轴上搭了一个“山峰形状”的收益结构，  
你赌的是价格到最后会停留在这座山峰的附近。

---

## 二、直觉类比：在走钢丝的人脚下画一个“最佳停留区”

可以用一个简单故事向用户解释：

- 想象有个人在 50,000 到 70,000 价格区间之间走钢丝；  
- 你判断，活动结束时，他大概率会停留在 60,000 附近；  
- 同时，你认为他不太可能猛冲到 70,000，也不太可能跌落到 50,000；  

于是你在 60,000 这个位置画了一个“收益最高区”，  
在两端 55,000 和 65,000 画了“保护门槛”。  

当他最终停在 60,000 附近时，你能收获最大的收益；  
当他停在 55,000 或 65,000 附近时，你接近持平或小亏；  
当他跑到更远的位置时，你最多亏损你一开始付出的成本。

这就是蝶式价差的本质：  
用三个执行价，把整个价格区间切成“高收益区、缓冲区和亏损封顶区”。

---

## 三、结构拆解：三档执行价 + 四条期权腿

以看涨蝶式（Call Butterfly）为例，这是最经典的构造方式之一：

- 标的：BTC  
- 当前价格：60,000  
- 你认为到期时更大概率会停留在 60,000 附近  
- 你选择三个执行价：
  - 低执行价：K1 = 55,000  
  - 中执行价：K2 = 60,000  
  - 高执行价：K3 = 65,000  

构造方式（标准对称蝶式）：

1. 买入 1 张 55,000 行权价看涨期权（Long Call K1）  
2. 卖出 2 张 60,000 行权价看涨期权（Short 2 Calls K2）  
3. 买入 1 张 65,000 行权价看涨期权（Long Call K3）

特点：

- 整体成本：通常为一个有限的净权利金支出（Net Debit），  
  即两个多头减去两个空头之后的净支出；  
- 最大亏损：限制在你初始支付的净权利金；  
- 最大收益：发生在价格接近 K2（中间执行价）时；  
- 当价格远低于 K1 或远高于 K3 时，  
  组合最终会接近价值为 0 或某个固定值，  
  你的亏损被锁在有限范围内。

你也可以构建看跌蝶式（Put Butterfly），  
逻辑是一样的，只是换成看跌期权。

---

## 四、盈亏轮廓：一座“山峰型”的收益结构

可以在玩法中用文字描述 P/L 曲线的形状，让用户有画面感：

- 当到期价在 K1 以下：  
  所有看涨期权实值程度有限或全部虚值，  
  整体组合最终价值接近 0，  
  你亏掉的是初始净支出（最大亏损）。

- 当到期价在 K1 与 K2 之间：  
  K1 的多头看涨开始实值，  
  K2 的空头看涨也开始实值，  
  两者之间的差值构成你的收益，  
  收益逐渐上升，在 K2 附近达到顶峰。

- 当到期价正好等于 K2：  
  整个蝶式价差达到理论最大收益，  
  此时多空腿之间的价值差最大化。

- 当到期价在 K2 与 K3 之间：  
  K2 的空头腿逐步深入实值，  
  K3 的多头腿尚未完全发挥，  
  收益再次从峰值回落。

- 当到期价在 K3 以上：  
  两个端点多头和中位空头之间的差值趋于固定，  
  整体组合回到接近 0 或某个固定值，  
  你最终承担的仍然是初始成本。

这种“中间高，两边低”的形状，就是蝴蝶（Butterfly）名称的由来：  
从侧面看像一只张开翅膀的蝴蝶中间最厚，两边变薄。

---

## 五、适用场景：低波动、价格收敛、明确目标价

蝶式价差适用的典型场景包括：

1. 事件前后，预期“冲高回落”或“快速收敛”  
   - 例如重要公告、数据公布、升级完成之后，  
   - 你认为价格会在某个时间点前后收敛到一个中枢区域。

2. 没有超大趋势预期，但有相对明确的区间判断  
   - 你不相信价格会大幅走出区间，  
   - 也不想为此付出单腿期权过高的权利金，  
   - 希望用一个低成本结构来捕捉中间区域的机会。

3. 对隐含波动率有一定看法  
   - 在隐含波动率整体不算特别便宜，但你仍想押注特定价位时，  
   - 蝶式可以降低成本，同时把风险限制在确定的区间内。

---

## 六、与简单买入期权相比：成本更低，方向容错更小

对用户而言，可以用一段对比来强化认知：

- 直接买入看涨期权：  
  - 成本较高，  
  - 只要标的上涨到某个幅度以上你就赚钱，  
  - 但如果不上涨，时间价值损耗会让你亏掉大部分权利金。  

- 使用蝶式看涨价差：  
  - 成本更低，因为你同时卖出了中位执行价的两个期权来抵消部分成本；  
  - 价格必须比较精确地落在中位附近，你才有较大收益；  
  - 一旦价格偏离太多，无论是太高还是太低，你的盈亏都会接近初始成本水平。

可以总结为：

- “高容差 + 高成本”的是简单买入期权；  
- “低容差 + 低成本 + 高赔率”的是蝶式价差。

---

## 七、风控与参数选择：如何避免“一次赌错输光兴趣”

为了让这个玩法对用户可控并且不劝退，需要强调几个风控要点：

1. 资金配比  
   - 单一蝶式结构不建议超过总资金的 5%  
   - 让它成为你组合中的一个“战术工具”，而不是全部押注

2. 执行价选择  
   - 中位执行价 K2 选在你认为“收敛概率最高的位置”  
   - K1 与 K3 则根据你对波动范围的判断来设置  
   - 间距越近：  
     盈亏曲线更尖锐，收益区更窄  
   - 间距越宽：  
     盈亏曲线更平缓，成本可能更高

3. 时间窗口选择  
   - 不要选过远的到期日，时间价值会稀释你的赔率优势  
   - 通常与事件窗口（例如 7、14、30 天）对齐

4. 事件与消息面  
   - 在可能存在黑天鹅事件、监管消息、链上重大安全事件时，  
   - 避免轻率构建低波动预期的蝶式结构

---

## 八、给用户的简化执行流程建议

可以在玩法卡片中，用步骤列表的方式给出行动模板：

1. 明确目标  
   - 你认为 BTC/ETH 在未来 X 天后更可能停留在哪个价格区间？  
   - 例如：60,000 附近，上下浮动 5%

2. 设计结构  
   - 选择一个中位执行价（例如 60,000）  
   - 向上和向下分别设置一个等距执行价（例如 55,000 和 65,000）  
   - 构建标准看涨蝶式或看跌蝶式

3. 检查成本与最大亏损  
   - 计算你支付的净成本  
   - 明确这是最大可能亏损，并在心理和资金上做好准备

4. 上线策略  
   - 在交易所中下单构建此组合  
   - 确认所有腿都已成功成交且数量一致

5. 期间管理  
   - 不需要日内高频操作  
   - 定期检查价格是否仍围绕你的目标区间  
   - 若提前达到满意收益，可选择提前平仓而不一定等到期

6. 到期前决策  
   - 根据当时标的位置与剩余时间价值，  
   - 决定是持有到期，还是提前平掉部分或全部头寸  
   - 避免临近到期流动性极差、点差变大的阶段执行大额操作

---

## 九、在玩法库中的标签与定位

在你的「衍生品 / volatility」策略模块中，可以为 33.4 蝶式价差打上这样的标签：

- 风险：有限、可见、事先设定  
- 收益：有限、高赔率、适合精准观点  
- 使用场景：事件前后、价格收敛预期、低波环境  
- 用户画像：  
  - 已经理解期权基本逻辑，  
  - 愿意为“特定价位观点”付出少量成本，  
  - 不想承担无限风险的玩家。

可以在卡片上写一句总结式文案：

> “当你对‘最终会收敛到哪里’有明确看法，  
>  又不愿意为此付出高昂单腿权利金时，  
>  蝶式价差是一种既便宜、又有明确赔率和止损边界的玩法。”

这样，用户对这个策略就会有一个清晰的、结构化的、可落地的整体印象。

`
};

/**
 * 上传 33.3 & 33.4 策略到 Directus
 */
async function uploadStrategies() {
  const DIRECTUS_URL = 'http://localhost:8055';

  console.log(
    '开始上传策略 33.3 (Calendar Spread 日历价差) 和 33.4 (Butterfly Spread 蝶式价差)...\n'
  );

  try {
    const { execSync } = require('child_process');
    const tokenOutput = execSync('./get-new-directus-token.sh').toString();
    const tokenMatch = tokenOutput.match(/DIRECTUS_ADMIN_TOKEN=(.+)/);

    if (!tokenMatch) {
      throw new Error('Failed to get admin token');
    }

    const ADMIN_TOKEN = tokenMatch[1].trim();

    const headers = {
      Authorization: `Bearer ${ADMIN_TOKEN}`,
      'Content-Type': 'application/json'
    };

    console.log('上传策略 33.3: Calendar Spread 日历价差...');
    await axios.post(`${DIRECTUS_URL}/items/strategies`, STRATEGY_33_3, {
      headers
    });
    console.log('✅ 策略 33.3 上传成功\n');

    console.log('上传策略 33.4: Butterfly Spread 蝶式价差...');
    await axios.post(`${DIRECTUS_URL}/items/strategies`, STRATEGY_33_4, {
      headers
    });
    console.log('✅ 策略 33.4 上传成功\n');

    const response = await axios.get(
      `${DIRECTUS_URL}/items/strategies?limit=1&meta=total_count`,
      { headers }
    );
    console.log(
      `✅ 数据库中现有策略总数: ${response.data.meta.total_count}`
    );
  } catch (error) {
    console.error('❌ 上传失败:', error.response?.data || error.message);
    process.exit(1);
  }
}

// 若需要在 Node 中直接执行本文件写入策略，请解除下一行注释：
uploadStrategies();
