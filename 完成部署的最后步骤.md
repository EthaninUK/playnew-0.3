
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  🎉 自动化部署已完成! 
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 已完成的工作:

1. ✅ 代码已推送到 GitHub  
2. ✅ 服务器初始化完成
   - Docker已安装
   - Nginx已安装  
   - Certbot已安装
   - 2GB Swap已创建
   - 防火墙已配置
3. ✅ 代码已部署到服务器 /var/www/playnew

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 现在需要你手动完成剩余步骤:

这些步骤需要交互式操作,无法自动化。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

第 1 步: 配置域名 DNS (5 分钟)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

登录你的域名管理面板,添加以下 A 记录:

记录类型  主机记录    记录值             TTL
------   --------   ---------------    ----
A        @          13.158.222.72      600
A        www        13.158.222.72      600
A        api        13.158.222.72      600
A        search     13.158.222.72      600
A        n8n        13.158.222.72      600

⏱️ 等待 DNS 生效 (通常 5-30 分钟)

验证命令:
  nslookup playnew.ai
  nslookup api.playnew.ai


第 2 步: 连接服务器 (使用便捷脚本)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

本地执行:
  ./connect-server.sh

或直接 SSH:
  ssh -i "LightsailDefaultKey-ap-northeast-1 (2).pem" ubuntu@13.158.222.72


第 3 步: 生成密钥 (在服务器上执行)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

cd /var/www/playnew

# 生成3个密钥并记录下来:
openssl rand -base64 32  # 这是 DIRECTUS_KEY
openssl rand -base64 32  # 这是 DIRECTUS_SECRET  
openssl rand -base64 32  # 这是 MEILISEARCH_MASTER_KEY


第 4 步: 配置环境变量 (在服务器上执行)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

A. 根目录配置:

cp .env.production.example .env.production
nano .env.production

填入:
  DIRECTUS_KEY=刚才生成的第1个
  DIRECTUS_SECRET=刚才生成的第2个
  MEILISEARCH_MASTER_KEY=刚才生成的第3个

保存: Ctrl+O, 回车, Ctrl+X


B. 前端配置:

cp frontend/.env.production.example frontend/.env.production
nano frontend/.env.production

重要修改:
  1. 所有 localhost 改为实际域名:
     NEXT_PUBLIC_DIRECTUS_URL=https://api.playnew.ai
     NEXT_PUBLIC_MEILISEARCH_HOST=https://search.playnew.ai
     NEXT_PUBLIC_APP_URL=https://playnew.ai

  2. ⚠️ Stripe 改为生产密钥 (不是测试密钥!):
     NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
     STRIPE_SECRET_KEY=sk_live_...
     STRIPE_WEBHOOK_SECRET=whsec_生产环境的

  3. 填入刚才生成的密钥:
     DIRECTUS_ADMIN_TOKEN=生成一个新的或使用现有的
     MEILISEARCH_API_KEY=刚才生成的MEILISEARCH_MASTER_KEY

保存: Ctrl+O, 回车, Ctrl+X


第 5 步: 获取 SSL 证书 (在服务器上执行)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 确保 DNS 已生效后再执行!

# 停止 Nginx
sudo systemctl stop nginx

# 获取证书 (一条命令获取所有域名)
sudo certbot certonly --standalone \
  -d playnew.ai \
  -d www.playnew.ai \
  -d api.playnew.ai \
  -d search.playnew.ai \
  -d n8n.playnew.ai

输入你的邮箱,同意条款即可。


第 6 步: 配置 Nginx (在服务器上执行)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 复制配置文件
sudo cp nginx/playnew.ai.conf /etc/nginx/sites-available/

# 创建软链接
sudo ln -s /etc/nginx/sites-available/playnew.ai.conf /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 如果测试通过,启动 Nginx
sudo systemctl start nginx


第 7 步: 部署应用 (在服务器上执行)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 确保在项目目录
cd /var/www/playnew

# 运行部署脚本
./deploy.sh

这会:
  • 拉取最新代码 (如果有更新)
  • 检查环境变量
  • 构建 Docker 镜像
  • 启动所有容器
  • 进行健康检查

⏱️ 第一次部署需要 5-10 分钟 (构建 Next.js 镜像)


第 8 步: 验证部署 (在服务器上执行)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 查看容器状态
docker-compose -f docker-compose.prod.yml ps

应该看到 4 个容器都在运行:
  • playnew-directus
  • playnew-meilisearch
  • playnew-n8n
  • playnew-frontend

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f


第 9 步: 访问网站
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在浏览器访问:
  • 主站: https://playnew.ai
  • API 健康检查: https://api.playnew.ai/server/health
  • 搜索健康检查: https://search.playnew.ai/health
  • Directus 后台: https://api.playnew.ai
  • n8n 自动化: https://n8n.playnew.ai

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📚 完整文档参考:

• DEPLOYMENT.md - 最详细的部署指南
• DEPLOYMENT-CHECKLIST.md - 完整检查清单  
• QUICK-DEPLOY.md - 快速部署参考

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 常见问题:

1. SSL 证书获取失败?
   • 确保 DNS 已完全生效
   • 确保防火墙开放了 80/443 端口
   • 使用 nslookup 验证 DNS

2. 容器启动失败?
   • 检查环境变量是否正确配置
   • 查看日志: docker-compose -f docker-compose.prod.yml logs
   • 2GB RAM可能不够,考虑升级

3. 前端无法连接 API?
   • 检查 frontend/.env.production 中的 URL 配置
   • 确保所有 URL 都是 https://

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 完成后你将拥有:

• 完整的生产网站
• 全站 HTTPS 加密
• 自动 SSL 证书续期
• Docker 容器化部署
• 完整的备份方案

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

现在开始吧! 从第 1 步配置 DNS 开始。

有问题随时问我! 🚀

