# 🎯 下一步操作:完成 Git CI/CD 设置

## ✅ 当前状态
- ✅ 代码已提交并推送到 GitHub
- ✅ 服务器上 Git 已初始化
- ✅ 部署脚本已上传到服务器
- ⚠️ 需要解决 GitHub 仓库访问权限

## 🔑 现在的关键问题

您的 GitHub 仓库是**私有的**,服务器需要认证才能拉取代码。

有两个选择:

---

## 🌟 方案 1:将仓库设为公开(推荐,最简单)

### 为什么推荐这个方案?
- ✅ 无需任何认证配置
- ✅ 服务器可以直接 `git pull`
- ✅ GitHub Actions 可以直接工作
- ✅ 5 分钟内完成所有设置
- ✅ 很多开源项目都是公开的
- ✅ 前端代码本来就是公开的(用户可以在浏览器查看)
- ✅ 敏感信息都在 `.env` 文件中,不会提交到 Git

### 操作步骤:

**步骤 1: 将仓库设为公开**

1. 打开: https://github.com/EthaninUK/playnew-0.3/settings
2. 滚动到最底部 **Danger Zone** 区域
3. 点击 **Change visibility**
4. 选择 **Make public**
5. 输入仓库名称确认: `playnew-0.3`
6. 点击确认

**完成后告诉我"已设为公开",我会立即完成剩余的自动化配置!**

---

## 🔐 方案 2:使用 Personal Access Token(保持私有)

### 如果您需要保持仓库私有

**步骤 1: 生成 GitHub Token**

1. 打开: https://github.com/settings/tokens/new
2. Note: `PlayNew Server Deployment`
3. Expiration: `No expiration` (或选择时间)
4. 勾选权限: `repo` (完整仓库访问权限)
5. 点击 **Generate token**
6. ⚠️ 立即复制 token(只显示一次!)

**步骤 2: 告诉我您的 Token**

把生成的 token 告诉我,我会自动配置服务器。

---

## 🎯 我的建议

**强烈推荐选择方案 1**(将仓库设为公开),原因:

1. ✅ 这是一个 Web 应用,代码最终会部署到公网
2. ✅ 前端代码本身就是公开的(任何人都可以在浏览器查看源码)
3. ✅ 所有密钥都在环境变量中(`.env` 文件已在 `.gitignore` 中)
4. ✅ Stripe 密钥、数据库密码等敏感信息都不会被提交
5. ✅ 配置简单,维护方便,团队协作友好
6. ✅ 很多大型开源项目都是公开仓库

**如果确实需要保持私有**,选择方案 2,但需要额外配置和维护 Token。

---

## ⏭️ 下一步

**请告诉我您的选择**:
- 回复 `1` 或 `公开` - 我将仓库设为公开(推荐)
- 回复 `2` 或 `私有` - 我要使用 Token 保持私有

我会根据您的选择立即完成剩余的配置!

---

## 📋 配置完成后的步骤预览

完成 Git 配置后,还需要:

### 步骤 1: 配置 GitHub Secrets (3 分钟)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

登录你的域名管理面板,添加以下 A 记录:

记录类型  主机记录    记录值
------   --------   ---------------
A        @          13.158.222.72
A        www        13.158.222.72
A        api        13.158.222.72
A        search     13.158.222.72
A        n8n        13.158.222.72

⏱️ 等待 DNS 生效 (5-30 分钟)

验证 DNS:
nslookup playnew.ai
nslookup api.playnew.ai


第 3 步: 连接服务器 (现在就可以做)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

你提到的命令:
ssh ubuntu@13.158.222.72

这是用来连接你的 AWS 服务器的。

如果连接失败,可能需要:
• 使用密钥: ssh -i your-key.pem ubuntu@13.158.222.72
• 或者使用密码登录


第 4 步: 服务器初始化 (10 分钟)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

连接到服务器后,执行:

# 下载初始化脚本
wget https://raw.githubusercontent.com/EthaninUK/playnew-0.3/main/setup-server.sh

# 运行脚本 (需要 sudo)
sudo bash setup-server.sh

这会自动安装:
• Docker & Docker Compose
• Nginx
• Certbot (SSL 证书)
• 系统优化 (swap, 文件限制等)


第 5 步: 部署应用 (15 分钟)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在服务器上执行:

# 克隆代码
cd /var/www
sudo git clone https://github.com/EthaninUK/playnew-0.3.git playnew
sudo chown -R $USER:$USER playnew
cd playnew

# 配置环境变量
# 1. 生成密钥
openssl rand -base64 32  # DIRECTUS_KEY
openssl rand -base64 32  # DIRECTUS_SECRET  
openssl rand -base64 32  # MEILISEARCH_MASTER_KEY

# 2. 创建配置文件
cp .env.production.example .env.production
nano .env.production
# (填入上面生成的密钥)

cp frontend/.env.production.example frontend/.env.production
nano frontend/.env.production
# (更新所有配置,特别是 Stripe 生产密钥!)

# 获取 SSL 证书
sudo systemctl stop nginx
sudo certbot certonly --standalone -d playnew.ai -d www.playnew.ai
sudo certbot certonly --standalone -d api.playnew.ai
sudo certbot certonly --standalone -d search.playnew.ai
sudo certbot certonly --standalone -d n8n.playnew.ai

# 配置 Nginx
sudo cp nginx/playnew.ai.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/playnew.ai.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl start nginx

# 部署!
./deploy.sh


第 6 步: 配置自动部署 (5 分钟)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在 GitHub 仓库 Settings > Secrets and variables > Actions:

添加以下 Secrets:
• SSH_HOST: 13.158.222.72
• SSH_USER: ubuntu  
• SSH_PRIVATE_KEY: (你的 SSH 私钥内容)

完成后,每次 git push 都会自动部署!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📚 详细文档:

• 完整指南: DEPLOYMENT.md
• 快速部署: QUICK-DEPLOY.md
• 部署清单: DEPLOYMENT-CHECKLIST.md
• GitHub 推送: GITHUB-PUSH-GUIDE.md
• 总体方案: 部署方案总结.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 重要提醒:

1. Stripe 必须改为生产密钥 (pk_live_... 不是 pk_test_...)
2. 所有 URL 改为 HTTPS (https://playnew.ai)
3. 生成新的密钥,不要用示例密钥
4. 2GB RAM 有点紧张,如遇内存问题考虑升级到 4GB

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 预计完成时间: 约 40 分钟

完成后访问:
• https://playnew.ai (主站)
• https://api.playnew.ai (API)
• https://search.playnew.ai (搜索)
• https://n8n.playnew.ai (自动化)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💬 现在开始吧!

请告诉我:
1. GitHub 仓库是否已创建? (访问确认)
2. 是否需要帮助推送代码?
3. 是否可以连接到服务器?

