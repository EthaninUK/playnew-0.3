# 🎯 PlayNew 0.3 部署方案总结

## ✅ 已完成准备工作

### 1. Git 仓库初始化
- ✅ Git 仓库已初始化
- ✅ 所有文件已提交 (422 个文件, 97,807 行代码)
- ⏳ 等待推送到 GitHub

### 2. 部署配置文件
| 文件 | 用途 | 状态 |
|------|------|------|
| `.gitignore` | 忽略敏感文件和大文件 | ✅ |
| `.env.production.example` | 生产环境变量模板 | ✅ |
| `frontend/.env.production.example` | 前端生产配置 | ✅ |
| `docker-compose.prod.yml` | 生产环境 Docker | ✅ |
| `frontend/Dockerfile.prod` | 前端生产镜像 | ✅ |
| `nginx/playnew.ai.conf` | Nginx 配置 | ✅ |
| `setup-server.sh` | 服务器初始化 | ✅ |
| `deploy.sh` | 自动化部署 | ✅ |
| `.github/workflows/deploy.yml` | CI/CD 自动部署 | ✅ |

### 3. 文档
| 文档 | 内容 | 状态 |
|------|------|------|
| `DEPLOYMENT.md` | 完整部署指南 | ✅ |
| `QUICK-DEPLOY.md` | 快速部署步骤 | ✅ |
| `READY-TO-DEPLOY.md` | 就绪说明 | ✅ |
| `DEPLOYMENT-CHECKLIST.md` | 部署清单 | ✅ |

---

## 📊 项目架构

### 前端
- **框架**: Next.js 14 (App Router)
- **部署**: Docker standalone 模式
- **URL**: https://playnew.ai

### 后端服务
| 服务 | 技术 | 端口 | URL |
|------|------|------|-----|
| API/CMS | Directus | 8055 | https://api.playnew.ai |
| 搜索 | Meilisearch | 7700 | https://search.playnew.ai |
| 自动化 | n8n | 5678 | https://n8n.playnew.ai |

### 数据库
- **类型**: PostgreSQL
- **提供商**: Supabase (云端)
- **备份**: Supabase 自动备份

### 反向代理
- **技术**: Nginx
- **SSL**: Let's Encrypt (自动续期)

---

## 🚀 部署方案: Git + Docker Compose + GitHub Actions

### 优势
1. ✅ **版本控制**: Git 管理所有代码
2. ✅ **一键部署**: `./deploy.sh` 自动化部署
3. ✅ **持续集成**: 每次 `git push` 自动部署
4. ✅ **环境一致**: Docker 保证开发/生产一致
5. ✅ **易于维护**: 代码更新简单快速

### 工作流程
```
本地修改代码
    ↓
git commit & push
    ↓
GitHub Actions 触发
    ↓
SSH 连接服务器
    ↓
拉取最新代码
    ↓
运行 deploy.sh
    ↓
重启 Docker 容器
    ↓
部署完成
```

---

## 🖥️ 服务器信息

- **IP**: 13.158.222.72
- **配置**: 2GB RAM, 2 vCPU, 60GB SSD
- **位置**: 东京, 区域 A
- **优化**: 
  - 2GB Swap 交换空间
  - 内存限制优化
  - 文件句柄提升

---

## 📝 下一步操作 (按顺序)

### 第 1 步: 推送到 GitHub (5 分钟)
```bash
# 1. 在 GitHub 创建私有仓库
# 访问: https://github.com/new
# 仓库名: playnew-0.3
# 设置为: Private

# 2. 推送代码
git remote add origin git@github.com:YOUR_USERNAME/playnew-0.3.git
git push -u origin main
```

### 第 2 步: 配置域名 DNS (5 分钟)
添加以下 A 记录:
```
@ -> 13.158.222.72
www -> 13.158.222.72
api -> 13.158.222.72
search -> 13.158.222.72
n8n -> 13.158.222.72
```

### 第 3 步: 服务器初始化 (10 分钟)
```bash
# SSH 连接
ssh ubuntu@13.158.222.72

# 运行初始化脚本
wget https://raw.githubusercontent.com/YOUR_USERNAME/playnew-0.3/main/setup-server.sh
sudo bash setup-server.sh
```

### 第 4 步: 部署代码 (15 分钟)
```bash
# 克隆仓库
cd /var/www
sudo git clone git@github.com:YOUR_USERNAME/playnew-0.3.git playnew
sudo chown -R $USER:$USER playnew
cd playnew

# 配置环境变量
cp .env.production.example .env.production
nano .env.production  # 填入密钥

cp frontend/.env.production.example frontend/.env.production
nano frontend/.env.production  # 更新配置

# 获取 SSL 证书
sudo systemctl stop nginx
sudo certbot certonly --standalone -d playnew.ai -d www.playnew.ai
sudo certbot certonly --standalone -d api.playnew.ai
sudo certbot certonly --standalone -d search.playnew.ai
sudo certbot certonly --standalone -d n8n.playnew.ai

# 配置 Nginx
sudo cp nginx/playnew.ai.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/playnew.ai.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl start nginx

# 部署!
./deploy.sh
```

### 第 5 步: 配置自动部署 (5 分钟)
在 GitHub Settings > Secrets 添加:
- `SSH_HOST`: `13.158.222.72`
- `SSH_USER`: `ubuntu`
- `SSH_PRIVATE_KEY`: 你的 SSH 私钥

---

## ⚠️ 重要提醒

### 必须修改的配置
1. **生成新密钥** (不要用示例密钥!)
   ```bash
   openssl rand -base64 32  # DIRECTUS_KEY
   openssl rand -base64 32  # DIRECTUS_SECRET
   openssl rand -base64 32  # MEILISEARCH_MASTER_KEY
   ```

2. **Stripe 改为生产密钥**
   - 测试密钥: `pk_test_...` ❌
   - 生产密钥: `pk_live_...` ✅

3. **所有 URL 改为 HTTPS**
   - `http://localhost:3000` ❌
   - `https://playnew.ai` ✅

### 服务器性能注意
- 2GB RAM 比较紧张,已做优化
- 如果遇到内存不足,建议升级到 4GB RAM
- 已启用 2GB Swap 缓解压力

---

## 📚 文档参考

- **完整指南**: [DEPLOYMENT.md](./DEPLOYMENT.md)
- **快速部署**: [QUICK-DEPLOY.md](./QUICK-DEPLOY.md)  
- **部署清单**: [DEPLOYMENT-CHECKLIST.md](./DEPLOYMENT-CHECKLIST.md)
- **就绪说明**: [READY-TO-DEPLOY.md](./READY-TO-DEPLOY.md)

---

## 🎉 预计时间

| 步骤 | 时间 |
|------|------|
| 推送到 GitHub | 5 分钟 |
| 配置 DNS | 5 分钟 (等待生效 5-30 分钟) |
| 服务器初始化 | 10 分钟 |
| 部署应用 | 15 分钟 |
| 配置自动部署 | 5 分钟 |
| **总计** | **约 40 分钟** (不含 DNS 等待时间) |

---

## ✨ 完成后你将拥有

- 🌐 完整的生产网站: https://playnew.ai
- 🔐 全站 HTTPS 加密
- 🚀 自动化部署 (git push 即部署)
- 📊 完整的监控和日志
- 🔄 自动 SSL 证书续期
- 💾 数据备份方案

---

**开始部署吧! 🎯**
