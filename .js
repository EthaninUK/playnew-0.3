// 策略 30.3 和 30.4: 分叉与快照捕获套利 + 结构性产品溢折价套利

const axios = require('axios');

/**
 * 30.3 分叉与快照捕获套利
 */
const STRATEGY_30_3 = {
  title: '分叉与快照捕获套利 - 用“复制币”和空投做低风险增厚',
  slug: 'fork-snapshot-capture-arbitrage',
  summary:
    '围绕区块链分叉和项目快照事件，在快照前配置底层资产，在分叉链或空投资产到账后迅速了结，赚取“复制出的额外筹码”带来的收益。典型包括比特币分叉币、L1/L2 空投、治理代币发放等。适合能跟进公告、有多链钱包基础的玩家。',
  category: 'structural-event-arbitrage',
  category_l1: 'arbitrage',
  category_l2: 'structural-event-arbitrage',
  risk_level: 3,
  apy_min: 15,
  apy_max: 80,
  min_investment: 2000,
  time_commitment: '每周 2-5 小时（事件期更多）',
  status: 'published',
  content: `# 分叉与快照捕获套利 - 用“复制币”和空投做低风险增厚

## 💰 策略概览

| 参数 | 数值 |
|------|------|
| **起投资金** | $2,000 - $30,000 |
| **时间投入** | 每周 2-5 小时（事件前后会集中一点） |
| **预期年化收益** | 15-80%（取决于事件频率与执行效率） |
| **风险等级** | ⚠️⚠️⚠️ 中等 (3/5) |
| **难度等级** | 中级 |
| **适合人群** | 会用多链钱包、懂基本签名与转账、能看公告和快照规则的玩家 |

---

## 📖 开场故事：一次“白送”的分叉币，9 天额外赚了 28%

2017 年，比特币出现了著名的一次链上分叉事件：  
> 所有在某个区块高度之前持有 BTC 的用户，都能 1:1 获得一份新的分叉币。

交易者 Ray 当时做的事情极其“无聊”：

1. 分叉公告出炉后，他确认了几个核心信息：
   - **快照高度**：H  
   - **映射规则**：1 BTC → 1 分叉币  
   - **支持的托管方式**：链上自托管地址 & 少数交易所

2. 他选择在分叉前一周，将自己原本散落在不同平台的比特币，**全部集中到 2 个自己掌控私钥的钱包地址** 中。

3. 在快照区块高度到达之后，他什么也没做，只是耐心等待分叉链成熟、交易所上架新币。

4. 分叉币上线后，一开始价格极不稳定，波动巨大：
   - 开盘高点非常夸张  
   - 后续迅速回落，但依然有不低的价格区间

Ray 实际的操作：

- 在分叉币上线后的前两天，把所有分叉币分批卖掉（不恋战）  
- 并 **完全不动原来的 BTC 仓位**

计算下来，这一轮操作给他带来额外收益：

\`\`\`
期初：持有 10 BTC，成本约 $3,000/BTC
期末：
  - 仍然持有 10 BTC 不动
  - 分叉币卖出收入 ≈ 价值 2.8 BTC

相当于：
  你的 BTC 仓位多产生了 28% 的“复制收益”，
  且期间几乎没有增加额外价格风险（只多了操作和对手风险）。
\`\`\`

这就是**分叉与快照捕获套利**的典型逻辑：  
> 用一次性的“系统快照”，把你已有或短期配置的资产复制出一份额外筹码，用来增厚长期投资回报。

---

## 🧠 核心逻辑：为什么分叉 & 快照会产生套利空间？

### 1. 快照 = 某个时刻的“身份登记”

- 对项目方来说：快照是决定 **“谁有资格拿新东西”** 的机制  
  - 新链分叉币  
  - 治理代币空投  
  - NFT 白名单、积分奖励等等
- 对玩家来说：只要在快照时刻之前把资产准备到位，就可以**分享这份“登记权”**。

### 2. 分叉 = 把老资产克隆出一份

- 对于 UTXO 链（比特币等）分叉，**你的私钥在两条链上都有效**：  
  - 原链：照常保持原样  
  - 新链：新币以同样的余额出现在新网络  
- 分叉后的新币，一旦有交易所上架或有一定市场共识，就具备独立价格：  
  > 原资产没少，凭白多了一份可以抛售或继续持有的资产。

### 3. 快照空投 = 把忠诚度变成筹码

- 很多 L1/L2 项目会通过快照方式给：
  - 长期持有者（HODL）  
  - 链上活跃用户（交互/质押/LP）  
- 你提前根据规则调整行为（多交互、多质押），在快照后需要做的只是：
  - 领取空投  
  - 在合适价位交易它（卖出换成主资产，或多元化持有）

---

## 🔍 子策略拆解：两种典型玩法

### 模式 A：分叉币捕获（Fork Capture）

> 在已知的链分叉前，尽可能多持有基础资产，并放在可以参与分叉的托管方式中，待分叉币可交易后卖出。

**核心要素：**

1. **确认分叉的可信度**  
   - 是否有一定社区支持  
   - 是否有开发团队、路线图  
   - 是否有交易所计划上架（哪怕是中小所）

2. **确认快照规则**  
   - 快照高度/时间？  
   - 哪些地址/托管方式认可（自托管？哪些交易所？）  
   - 是否有额外要求（锁仓、质押等）

3. **资金准备**  
   - 你是否本来就想持有这类资产（例如 BTC）？  
   - 是否可以接受在快照前后价格波动？  
   - 是否有其他替代机会成本？

**优势：**

- 对于本来就长期持仓的人，属于纯增厚收益  
- 对于短期为分叉而买入的人，只要控制好时间与风险，也可以是相对可控的事件型操作

---

### 模式 B：快照空投捕获（Snapshot Airdrop Capture）

> 围绕某个项目的“历史快照 + 空投规则”，提前设计交互与持仓，从而获得尽可能多的空投筹码。

常见类型：

- L1 / L2 协议空投（链上交互、桥接、质押节点）  
- DeFi 协议空投（提供流动性、借贷、交易量）  
- NFT / 积分系统空投（做任务、完成任务数/等级）

**一般流程：**

1. **规则收集**  
   - 官方文档 / 推特 / Discord 公告  
   - 社区分析（但要警惕谣言）  
   - 核心关注：哪些行为被记录？权重如何？是否明确快照时间？

2. **行为设计**  
   - 如果是交易/交互：控制 Gas / 手续费成本  
   - 如果是质押/借贷：考虑智能合约风险 + 清算风险  
   - 尽量做到：**用最少的资金做尽可能有效的行为路径**

3. **快照前后节奏**  
   - 避免在快照临近时 FOMO 重金冲进去  
   - 有时候太明显的临时行为会被规则惩罚（权重降低）  
   - 更好是在规则刚出来或还没完全火爆时，做“日常化”的交互

4. **空投落地后**  
   - 第一次开盘往往波动巨大  
   - 采取分批卖出策略（预设几个价格档位）  
   - 若对项目极有信心，可以保留部分长期持有

---

## 🛠️ 快照 & 分叉事件监控脚本示意

下面这个简化版脚本，用来：

- 轮询几个“分叉/空投快讯源”  
- 抓取含有关键词的推文/公告  
- 初步生成一个事件候选列表

\`\`\javascript
class ForkSnapshotMonitor {
  constructor() {
    this.sources = [
      {
        name: 'AirdropNewsBot',
        api: 'https://api.airdropnews.example.com/feeds'
      },
      {
        name: 'ChainForkTracker',
        api: 'https://api.chainforks.example.com/upcoming'
      }
      // 你可以自己加 Twitter / RSS / 自建聚合服务
    ];

    this.keywords = ['fork', 'snapshot', 'airdrop', '分叉', '快照', '空投'];
  }

  async fetchSource(source) {
    const res = await axios.get(source.api);
    return res.data.items || [];
  }

  matchKeywords(text) {
    const lower = text.toLowerCase();
    return this.keywords.some((k) => lower.includes(k.toLowerCase()));
  }

  async scan() {
    const events = [];

    for (const src of this.sources) {
      try {
        const items = await this.fetchSource(src);
        for (const item of items) {
          if (!item.title && !item.summary) continue;
          const text = \`\${item.title || ''} \${item.summary || ''}\`;
          if (!this.matchKeywords(text)) continue;

          events.push({
            source: src.name,
            title: item.title,
            summary: item.summary,
            url: item.url,
            timestamp: item.timestamp
          });
        }
      } catch (e) {
        console.error(\`❌ 获取 \${src.name} 源失败:\`, e.message);
      }
    }

    return events;
  }

  async run() {
    const events = await this.scan();
    console.log('📡 监控到的分叉/快照相关事件：');
    events.forEach((e) => {
      console.log(
        \`- [\${e.source}] \${e.title} | 时间: \${new Date(
          e.timestamp
        ).toISOString()} | 链接: \${e.url}\`
      );
    });
  }
}

// 使用示例：
// const monitor = new ForkSnapshotMonitor();
// monitor.run().catch(console.error);
\`\`\`

> 在你的真实系统里，可以把 events 写入数据库，打上“可信度/优先级”标签，再进入人工研究与操作决策链条。

---

## 📊 风险管理与参数

\`\`\javascript
const FORK_SNAPSHOT_RISK = {
  MAX_CAPITAL_RATIO: 0.3,        // 所有分叉/快照事件总资金不超过净资产的 30%
  MAX_PER_EVENT_RATIO: 0.1,      // 单事件不超过净资产的 10%
  MAX_LEVERAGE: 1,               // 原则上不用杠杆
  SNAPSHOT_BUFFER_BLOCKS: 10,    // 快照区块预留缓冲，避免“卡块”
  WITHDRAW_BEFORE_SNAPSHOT: true // 优先把筹码从 CEX 提到自托管钱包
};
\`\`\`

### 典型风险 & 应对

| 风险类型 | 描述 | 应对方案 |
|---------|------|----------|
| **假分叉/假快照骗局** | 某些“分叉”纯粹是钓鱼网站或恶意合约 | 永远从官方渠道核验；避免在陌生合约上签奇怪交易 |
| **操作风险** | 区块高度判断错误、忘记转币、搞错地址 | 提前多预留几天、记录清单、使用多重确认流程 |
| **对手方风险** | 把币放在不支持分叉/空投的交易所，最后领不到 | 优先使用自托管钱包或明确宣布支持的 CEX |
| **价格波动风险** | 为了分叉，短期重仓基础资产，但价格刚好大跌 | 严格控制单事件资金比例，将其视为长期仓的“增厚”而非纯短线 |
| **Gas & 手续费成本** | 多链交互频繁导致成本吃掉小额空投收益 | 为小额资金用户设置最低操作规模阈值，避免为几百美元空投花几百美元 Gas |

---

## 🎯 实战 Checklist

### 1️⃣ 准备期

- [ ] 选好主要链上的自托管钱包（BTC、ETH、L2 等）  
- [ ] 在 2-3 家主流交易所留一部分资产用于流动性安排  
- [ ] 订阅若干可靠的空投/分叉资讯源（官方+第三方）  
- [ ] 搭一张“事件看板”：项目 / 快照时间 / 规则概要 / 可信度 / 预计收益

### 2️⃣ 事件期 - 分叉玩法

- [ ] 在分叉前 3-7 天，完成筹码整理与归集  
- [ ] 确认快照高度和安全冗余（提前一定区块）  
- [ ] 分叉链上线后，优先关注 **安全的声明方式**（避免私钥直接导入陌生钱包）  
- [ ] 分叉币价格出现合理区间时，**分批卖出**，不恋战

### 3️⃣ 事件期 - 快照空投玩法

- [ ] 根据规则设计行为序列（交互、质押、交易量）  
- [ ] 控制单链 Gas 总成本，避免“刷到亏本”  
- [ ] 快照前不做太过明显的“临时刷量动作”以免被项目方降权  
- [ ] 空投发布后，第一时间确认真假与安全，再考虑提币或交易

### 4️⃣ 复盘期

- [ ] 记录每个事件的：成本、收益、投入时间  
- [ ] 总结哪些类型活动 ROI 更高（L2？DeFi？NFT？）  
- [ ] 调整之后的筛选标准与最低参与金额门槛

---

## ✅ 小结

**分叉与快照捕获套利** 的本质是：

- 利用“系统层面给老用户分红”的机会，做一个**有纪律的“薅羊毛”玩家**；  
- 对长期持仓来说，是几乎免费附加的收益增强器；  
- 对事件型玩家来说，是一套有门槛但可以高度程式化、模板化的玩法。

你要做的不是满世界追各种“可能有空投”的传言，而是：

- 建立自己的信息过滤与评分体系；  
- 选择最值得做的 10-20% 事件深挖；  
- 配合稳健仓位管理，把这块变成你的“中风险增厚模块”之一。

`
};

/**
 * 30.4 结构性产品溢折价套利
 */
const STRATEGY_30_4 = {
  title: '结构性产品溢折价套利 - GBTC/ETF 溢价与折价的制度级机会',
  slug: 'structural-product-premium-discount-arbitrage',
  summary:
    '利用 GBTC、封闭式基金、加密相关 ETF 等结构性产品的申赎限制与市场情绪，做溢价（Premium）与折价（Discount）之间的价差套利。包括早期 GBTC 高溢价套利、折价回归套利、以及现货 ETF 与期货/现货之间的结构性价差玩法。适合了解传统金融、能接触特定机构渠道或理解组合构建的玩家。',
  category: 'structural-event-arbitrage',
  category_l1: 'arbitrage',
  category_l2: 'structural-event-arbitrage',
  risk_level: 4,
  apy_min: 10,
  apy_max: 60,
  min_investment: 10000,
  time_commitment: '每周 3-6 小时（需要长期跟踪）',
  status: 'published',
  content: `# 结构性产品溢折价套利 - GBTC/ETF 溢价与折价的制度级机会

## 💰 策略概览

| 参数 | 数值 |
|------|------|
| **起投资金** | $10,000 - $1,000,000（部分玩法需要更高门槛） |
| **时间投入** | 每周 3-6 小时（以研究和监控为主） |
| **预期年化收益** | 10-60%（事件型，视市场结构而定） |
| **风险等级** | ⚠️⚠️⚠️⚠️ 中高 (4/5) |
| **难度等级** | 高级（偏机构化玩法） |
| **适合人群** | 理解传统金融、能接触券商/基金产品、有一定资金规模的玩家或机构 |

---

## 📖 开场故事：早期 GBTC 溢价套利的“准无风险时代”

在 2020-2021 年前后，加密圈流传着一种“传奇套利”：

> 只要你能参与 GBTC 的私募申购，锁 6 个月，就可以几乎“无风险”拿到 20-40% 的收益，甚至更高。

以当年的某轮操作为例（简化版）：

1. 市场上 GBTC 这个比特币信托在二级市场上**长期以 20-40% 的溢价交易**：  
   - GBTC 每份份额对应的 BTC 面值：假设为 \$40  
   - 但在公开市场上，GBTC 价格却是 \$48-56  
   - 溢价率 = (市场价 - 净值) / 净值 ≈ 20-40%

2. 一些合格投资者/机构拥有**参与 GBTC 新份额申购**的资格：  
   - 他们可以按**接近净值（NAV）**的价格把 BTC 存入信托  
   - 换取等值 GBTC 份额  
   - 但该份额有 **锁定期**（例如 6 个月）

3. 套利结构示意（溢价期）：

   - T 日：  
     - 投入 100 BTC 进入 GBTC 信托，按 NAV 换成相应数量的 GBTC 份额  
     - 同时在二级市场做空等价值 GBTC（或做对冲）  
   - T+180 日（解锁）：  
     - 锁定份额可以在公开市场出售  
     - 套利者用解锁的 GBTC 回补空头，或直接在二级卖出  
     - 利润主要来自这 6 个月间存在的 **持续溢价**

4. 在溢价持续、信托规模扩张、资金持续流入的时期，这类套利一度被认为是：

> “带杠杆的制度红利，只要结构不塌，就很难亏钱。”

当然，后面的故事大家也知道：当 GBTC 从溢价转为长期折价时，这种“无风险”结构立刻变成了**深坑**，大量参与者被困其中。

这背后的逻辑，就是**结构性产品的溢价与折价**——一旦理解这种结构，你就能在某些时刻跳到正确的一侧。

---

## 🧠 核心逻辑：结构性产品为什么会出现溢价/折价？

### 1. 产品形态 & 申赎机制

以 GBTC 或部分封闭式基金为例：

- 投资者向基金/信托**申购份额**，将 BTC 或法币换成相应的基金份额  
- 份额通常有 **锁定期**  
- 产品设计上可能只允许“申购 → 二级市场卖出”，**不允许反向赎回成 BTC**  
- 结果：
  - 如果市场需求很高（大家都想通过 GBTC 间接持有 BTC）  
  - 但基础资产不能被赎回 → **二级市场供给无法充分扩张**  
  - 二级市场价格就容易高于 NAV（溢价）

反之，当市场风险偏好下降时：

- 大家都想卖出 GBTC，避免持有折价产品  
- 但基金不能自动回购或赎回，供给过剩  
- 二级市场价格会低于 NAV（折价）

### 2. 目标客群的约束与错配

很多结构性产品的目标客群，并不是 Crypto Native 玩家，而是：

- 受限于合规框架、只能买证券产品的机构（养老金、家族办公室等）  
- 不方便直接配置 BTC，但可以购买“比特币信托/ETF”的机构或高净值用户

当这类客群的资金流入或流出发生剧烈变化时，  
二级市场的供需失衡会被**放大**：

- 牛市中：大量资金想要快速买 GBTC → 溢价扩大  
- 熊市中：大家一拥而上想卖出 → 折价扩大

### 3. 溢折价回归 = 可套利区间

只要一个产品的内在 NAV 是可计算的，且：

- 长期来看，市场参与者相信溢价/折价不可能无限偏离  
- 产品结构存在某种“软约束”促进回归（新资金/赎回机制/转换为 ETF 等）

那么你就有机会：

> 在溢价极高时建立“做空溢价”的结构，等待溢价回归  
> 或在折价极深时建立“做多折价”的结构，等待折价回归

---

## 🔍 子策略拆解：溢价套利 vs 折价套利

### 模式 A：溢价期结构性套利（Premium Capture）

> 在产品以高溢价交易时，通过“低成本创造份额 + 二级市场对冲”赚取溢价。

**本质结构：**

1. 通过合格渠道向信托/基金申购新份额，价格接近 NAV  
2. 同时在二级市场：
   - 卖出对应数量的产品份额（若允许卖空）  
   - 或通过其它工具对冲方向性风险  
3. 锁定期结束后，交割份额，赚取溢价空间

**限制：**

- 需要机构账户/合格投资人身份才能参与私募或申购  
- 锁定期内存在产品结构风险与基础资产价格路径风险  
- 一旦市场环境逆转（例如需求消失），溢价可能急剧收窄甚至转折价

> 这类操作，在普通散户层面更多是“理解结构，避免冲在最贵的那一边”，而不一定能完整跑一遍机构级套利闭环。

---

### 模式 B：折价期回归套利（Discount Mean-Reversion）

> 在封闭式产品深度折价时买入，博取折价缩窄的收益，同时做一定的基础资产对冲。

**示例逻辑：**

- 某 BTC 信托产品当前：
  - 每份 NAV = 1 BTC = \$40,000（按实时 BTC 价算）  
  - 二级市场价格只值 \$32,000  
  - 折价率 = (价格 - NAV) / NAV = -20%

你认为：

- 长期（1-3 年）内，折价不太可能一直保持 -20%  
- 有可能因为：
  - 产品结构调整、开放赎回  
  - 转换为 ETF  
  - 新资金进入等因素，折价缩窄至 -5% 或回到合理区间

**典型交易结构：**

1. 在二级市场买入一定数量信托份额  
2. 同时，用期货/永续合约对冲 BTC 的方向性风险：  
   - 做空等名义价值 BTC  
   - 让整个组合对 BTC 价格涨跌相对中性
3. 持有一段时间等待折价缩窄：
   - 例如从 -20% 缩窄到 -5%  
   - 这期间，即使 BTC 价格来回大幅波动，只要对冲做得还行  
   - 你主要赚的是折价变化的那一块

**收益示意：**

\`\`\`
初始：
  NAV = $40,000
  市价 = $32,000
  折价 = -20%

你买入 10 份，成本 = $320,000
同时做空等价值 BTC 名义仓位

若过一段时间：
  NAV ≈ $40,000（假设 BTC 价格整体变化不大）
  市价提升至 $38,000
  折价 = -5%

你在 $38,000 卖出 10 份信托：
  卖出所得 = $380,000
  买入成本 = $320,000
  毛价差 = $60,000
  对冲仓位的盈亏 ≈ 0（简化）

这 $60,000 就是折价回归带来的结构性收益。
\`\`\`

---

## 🛠️ 溢折价监控与打分脚本示意

下面是一个简化版脚本，用来：

- 从一个假想的 NAV 数据源拉取产品净值  
- 从市场报价源抓取实时价格  
- 计算溢价/折价与历史分位  
- 生成潜在套利机会列表

\`\`\javascript
class StructProductArbScanner {
  constructor() {
    this.products = [
      { symbol: 'GBTC', navApi: 'https://api.nav.example.com/gbtc', priceApi: 'https://api.price.example.com/gbtc' },
      { symbol: 'ETHE', navApi: 'https://api.nav.example.com/ethe', priceApi: 'https://api.price.example.com/ethe' }
      // 你可以扩展更多封闭式基金、ETF、信托产品
    ];
  }

  async fetchNav(navApi) {
    const res = await axios.get(navApi);
    return res.data.nav; // 假设返回结构 { nav: number }
  }

  async fetchPrice(priceApi) {
    const res = await axios.get(priceApi);
    return res.data.price; // 假设返回结构 { price: number }
  }

  calcPremiumDiscount(nav, price) {
    if (!nav || nav <= 0) return 0;
    return (price - nav) / nav;
  }

  async scan() {
    const results = [];

    for (const p of this.products) {
      try {
        const [nav, price] = await Promise.all([
          this.fetchNav(p.navApi),
          this.fetchPrice(p.priceApi)
        ]);

        const pd = this.calcPremiumDiscount(nav, price);

        results.push({
          symbol: p.symbol,
          nav,
          price,
          premiumDiscount: pd
        });
      } catch (e) {
        console.error(\`❌ 获取 \${p.symbol} 数据失败:\`, e.message);
      }
    }

    return results;
  }

  async run() {
    const list = await this.scan();

    console.log('📊 当前结构性产品溢折价情况：');
    list.forEach((item) => {
      console.log(
        \`- \${item.symbol}: 价格=\${item.price.toFixed(2)}, NAV=\${item.nav.toFixed(2)}, 溢折价=\${(
          item.premiumDiscount * 100
        ).toFixed(2)}%\`
      );
    });

    // 你可以在这里进一步打分：例如溢价>20% 或折价<-20% 时发出信号
    return list;
  }
}

// 使用示例：
// const scanner = new StructProductArbScanner();
// scanner.run().catch(console.error);
\`\`\`

---

## 📊 风险参数与风控框架

\`\`\javascript
const STRUCT_PRODUCT_RISK = {
  MAX_CAPITAL_RATIO: 0.4,         // 所有结构性产品套利占净资产不超过 40%
  MAX_SINGLE_PRODUCT_RATIO: 0.2,  // 单一产品不超过 20%
  TARGET_PREMIUM_OPEN: 0.2,       // 溢价套利开仓阈值，例如 >20%
  TARGET_DISCOUNT_OPEN: -0.2,     // 折价套利开仓阈值，例如 <-20%
  TARGET_CLOSE_LEVEL: -0.05,      // 折价套利平仓时折价回到 -5%左右
  MAX_HOLDING_DAYS: 365,          // 最大持仓周期 1 年
  MAX_LEVERAGE: 1,                // 原则上不用杠杆或极低杠杆
  STRESS_TEST_DROP: -0.5          // 需要承受 NAV/BTC 下跌 50% 的压力测试
};
\`\`\`

### 典型风险 & 思路

| 风险类型 | 描述 | 对策 |
|---------|------|------|
| **结构性制度变更** | 产品突然改变申赎规则、监管政策变化 | 要随时跟踪基金公告与法律环境，不做“只能涨不能跌”的假设 |
| **折价长期化** | 折价持续多年，不按你预期回归 | 用很保守的仓位，控制持仓时间，不押上全部资金 |
| **无法对冲或对冲失效** | 对冲工具流动性不足，或相关性下降 | 优先选择流动性极好的期货/永续产品，定期评估对冲效率 |
| **平台与托管风险** | 产品发行方或托管机构出现问题 | 分散产品与平台，不把所有结构性套利资金压在单一信托上 |
| **利率与融资成本风险** | 若使用杠杆或融券，利率波动会侵蚀收益 | 能不用杠杆尽量不用，必须用时，严格测算利率成本与最坏情形 |

---

## 🎯 实战执行流程（偏“研究型/机构味”）

### 1️⃣ 数据与研究准备

- [ ] 确定你要覆盖的结构性产品清单（GBTC、ETHE、加密 ETF、封闭式基金等）  
- [ ] 搭建定期更新的 NAV + 价格数据源（可以用公开 API + 自建服务）  
- [ ] 计算每只产品的：
  - 溢折价时间序列  
  - 历史分位（当前溢折价在历史上的第几百分位）  
- [ ] 用简单模型统计：
  - 哪些产品的溢折价更容易回归  
  - 回归时间分布（平均需要多久）

### 2️⃣ 策略规则设定

- [ ] 定义开仓阈值：  
  - 如：折价 < -20% 且历史分位 < 10% 才考虑开多  
- [ ] 定义平仓规则：  
  - 折价回到 -5% 或持仓满 12 个月，择机退出  
- [ ] 定义资金分配：  
  - 单产品不超过总资金的 X%  
  - 所有结构性套利不超过总资金的 Y%

### 3️⃣ 执行与对冲

- [ ] 开仓前，先验证能否方便地做 BTC/ETH 等基础资产对冲：  
  - 合约深度是否足够  
  - 手续费和资金费率是否合理  
- [ ] 建仓时同步开对冲头寸，尽量做到：
  - 方向性 Delta 接近 0  
  - 主要暴露在“溢折价变化”上
- [ ] 定期（如每周）检查：
  - 溢折价是否明显变化  
  - 对冲仓位是否需要调整（例如 NAV 变化、资金费率变化）

### 4️⃣ 退出与复盘

- [ ] 折价回归到目标区间或出现重大制度性变化时，优先考虑退出  
- [ ] 对每个案例记录：
  - 起始折价、结束折价、持有期  
  - 实际收益、对冲成本、机会成本  
- [ ] 统计哪些类型产品/市场环境下，此类套利最有优势

---

## 🧩 与其他策略的组合

- 与 **期货基差/永续资金费率套利** 结合：  
  - 结构性产品表层 = 传统世界对 BTC/ETH 的间接持仓  
  - 期货/永续 = Crypto 原生世界的价格预期  
  - 两者之间的关系，经常蕴含更深层次的风险偏好信息

- 与 **宏观与周期策略** 结合：  
  - 牛市前中期，溢价型套利机会更多（资金想冲进来）  
  - 熊市或后期，折价型套利机会更多（大家想撤出去）

---

## ✅ 小结

**结构性产品溢折价套利** 是一个非常“制度化”“偏机构”的玩法：

- 你赚的不是短线 K 线形态，而是 **产品形态 + 资金错配**；  
- 真正的 alpha 在于：  
  - 理解什么样的溢价/折价是“短期情绪波动”，  
  - 以及什么样的溢价/折价是结构性、长期化甚至永不修复的。

对普通玩家来说：

- 也许你无法完整参与 GBTC 那种“私募申购+锁仓”的套利闭环；  
- 但理解这些结构，至少可以让你在看到某产品“贵得离谱或便宜得离谱”时，  
  **站在对的一侧，而不是成为别人套利的对象**。

对更专业的你或你的平台来说，这一块可以被包装成：

- 针对高净值/机构用户的“结构性套利模块”；  
- 与其他事件策略（解锁、上线、分叉等）共同构成  
  一套**多维度、跨市场的结构性套利组合**。

`
};

/**
 * 上传 30.3 和 30.4 策略到 Directus
 */
async function uploadStrategies() {
  const DIRECTUS_URL = 'http://localhost:8055';

  console.log('开始上传策略 30.3 和 30.4...\\n');

  try {
    // 获取新的管理员令牌
    const { execSync } = require('child_process');
    const tokenOutput = execSync('./get-new-directus-token.sh').toString();
    const tokenMatch = tokenOutput.match(/DIRECTUS_ADMIN_TOKEN=(.+)/);

    if (!tokenMatch) {
      throw new Error('Failed to get admin token');
    }

    const ADMIN_TOKEN = tokenMatch[1].trim();

    const headers = {
      Authorization: `Bearer ${ADMIN_TOKEN}`,
      'Content-Type': 'application/json'
    };

    // 上传策略 30.3
    console.log('上传策略 30.3: 分叉与快照捕获套利...');
    await axios.post(`${DIRECTUS_URL}/items/strategies`, STRATEGY_30_3, {
      headers
    });
    console.log('✅ 策略 30.3 上传成功\\n');

    // 上传策略 30.4
    console.log('上传策略 30.4: 结构性产品溢折价套利...');
    await axios.post(`${DIRECTUS_URL}/items/strategies`, STRATEGY_30_4, {
      headers
    });
    console.log('✅ 策略 30.4 上传成功\\n');

    // 验证总数
    const response = await axios.get(
      `${DIRECTUS_URL}/items/strategies?limit=1&meta=total_count`,
      { headers }
    );
    console.log(
      `✅ 数据库中现有策略总数: ${response.data.meta.total_count}`
    );
  } catch (error) {
    console.error('❌ 上传失败:', error.response?.data || error.message);
    process.exit(1);
  }
}

uploadStrategies();
