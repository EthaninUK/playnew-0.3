{
  "name": "å¸åœˆå…«å¦Telegramç›‘æ§ - ä¼˜åŒ–ç‰ˆ (Best Practices)",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "channel_post",
          "message"
        ],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegramæ¶ˆæ¯ç›‘å¬",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "telegram-gossip-webhook-optimized",
      "credentials": {
        "telegramApi": {
          "id": "PLACEHOLDER",
          "name": "Telegram Bot"
        }
      },
      "notes": "å®æ—¶ç›‘å¬Telegramé¢‘é“/ç¾¤ç»„æ¶ˆæ¯"
    },
    {
      "parameters": {
        "jsCode": "// è§£æå’Œåˆæ­¥è¿‡æ»¤Telegramæ¶ˆæ¯\nconst message = $input.first().json.message || $input.first().json.channel_post;\n\nif (!message || !message.text) {\n  console.log('âš ï¸  è·³è¿‡ï¼šéæ–‡æœ¬æ¶ˆæ¯');\n  return [];\n}\n\nconst text = message.text;\nconst chat = message.chat;\nconst from = message.from || {};\n\n// å¸åœˆå…«å¦å…³é”®è¯æ£€æµ‹ï¼ˆåˆ†çº§ï¼‰\nconst keywords = {\n  critical: {\n    zh: ['è·‘è·¯', 'å·æ¬¾', 'æš´é›·', 'å´©ç›˜', 'ç ´äº§', 'æ¸…ç®—', 'è¢«æ•', 'é»‘å®¢', 'è¢«ç›—'],\n    en: ['rug pull', 'exit scam', 'hack', 'exploit', 'arrest', 'bankrupt', 'liquidation'],\n    score: -15\n  },\n  high: {\n    zh: ['ä¼ é—»', 'çˆ†æ–™', 'æ®æ‚‰', 'æ¶ˆæ¯', 'å†…å¹•', 'ç‹¬å®¶', 'æ³„éœ²'],\n    en: ['rumor', 'allegedly', 'sources', 'insider', 'exclusive', 'leak'],\n    score: -10\n  },\n  medium: {\n    zh: ['ç¦»èŒ', 'è¾èŒ', 'å†…è®§', 'åˆ†è£‚', 'è§£æ•£', 'è£å‘˜', 'æŠ›å”®'],\n    en: ['resign', 'fired', 'dispute', 'split', 'shutdown', 'layoff', 'dump'],\n    score: -5\n  },\n  low: {\n    zh: ['äº‰è®®', 'è´¨ç–‘', 'æ‰¹è¯„', 'æ‹…å¿§', 'è­¦å‘Š'],\n    en: ['controversy', 'criticism', 'concern', 'doubt', 'warn'],\n    score: -2\n  }\n};\n\n// æ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®è¯\nlet matches = [];\nlet gossipScore = 0;\nlet gossipLevel = 'none';\n\nfor (const [level, data] of Object.entries(keywords)) {\n  const allKeywords = [...data.zh, ...data.en];\n  const levelMatches = allKeywords.filter(kw => \n    text.toLowerCase().includes(kw.toLowerCase())\n  );\n  \n  if (levelMatches.length > 0) {\n    matches.push(...levelMatches);\n    gossipScore += data.score;\n    if (gossipLevel === 'none') gossipLevel = level;\n  }\n}\n\n// å¦‚æœæ²¡æœ‰å…«å¦å…³é”®è¯ï¼Œè·³è¿‡\nif (matches.length === 0) {\n  console.log(`âš ï¸  è·³è¿‡ï¼šæ— å…«å¦å…³é”®è¯ - ${chat.title || chat.username}`);\n  return [];\n}\n\n// è®¡ç®—å¯ä¿¡åº¦\nlet credibility = 60; // TelegramåŸºç¡€å¯ä¿¡åº¦ï¼ˆä¸­ç­‰ï¼‰\n\n// 1. é¢‘é“ç±»å‹å› ç´ \nconst isChannel = chat.type === 'channel';\nconst isGroup = chat.type === 'group' || chat.type === 'supergroup';\nif (isChannel) credibility += 10; // é¢‘é“æ¯”ç¾¤ç»„å¯ä¿¡\nelse if (isGroup) credibility += 5;\n\n// 2. å…«å¦å…³é”®è¯å½±å“\ncredibility += gossipScore;\n\n// 3. æ¶ˆæ¯è´¨é‡å› ç´ \nconst textLength = text.length;\nif (textLength > 1000) credibility += 10;\nelse if (textLength > 500) credibility += 8;\nelse if (textLength > 200) credibility += 5;\nelse if (textLength < 50) credibility -= 10; // å¤ªçŸ­ä¸å¯ä¿¡\n\n// 4. åª’ä½“å†…å®¹ï¼ˆæœ‰è¯æ®ï¼‰\nif (message.photo) credibility += 8;\nif (message.video) credibility += 8;\nif (message.document) credibility += 5;\n\n// 5. é“¾æ¥ï¼ˆæœ‰æ¥æºï¼‰\nconst hasUrls = message.entities?.some(e => e.type === 'url' || e.type === 'text_link');\nif (hasUrls) credibility += 10;\n\n// 6. è½¬å‘æ¶ˆæ¯ï¼ˆäºŒæ‰‹ä¿¡æ¯ï¼‰\nif (message.forward_from || message.forward_from_chat) {\n  credibility -= 5;\n}\n\n// 7. å›å¤æ¶ˆæ¯ï¼ˆè®¨è®ºä¸­ï¼‰\nif (message.reply_to_message) {\n  credibility += 3;\n}\n\n// é™åˆ¶èŒƒå›´\ncredibility = Math.max(25, Math.min(90, credibility));\n\n// è‡ªåŠ¨åˆ†ç±»\nlet category = 'æœªåˆ†ç±»';\nlet tags = [];\n\nconst lowerText = text.toLowerCase();\n\nif (lowerText.match(/(é¡¹ç›®|project|protocol|token)/i)) {\n  category = 'é¡¹ç›®ä¼ é—»';\n  tags.push('é¡¹ç›®');\n}\nif (lowerText.match(/(äº¤æ˜“æ‰€|exchange|binance|okx|bybit)/i)) {\n  category = 'äº¤æ˜“æ‰€å…«å¦';\n  tags.push('äº¤æ˜“æ‰€');\n}\nif (lowerText.match(/(èèµ„|investment|funding|raise)/i)) {\n  category = 'èèµ„æ¶ˆæ¯';\n  tags.push('èèµ„');\n}\nif (lowerText.match(/(é»‘å®¢|hack|exploit|attack)/i)) {\n  category = 'å®‰å…¨äº‹ä»¶';\n  tags.push('å®‰å…¨');\n}\nif (lowerText.match(/(ç›‘ç®¡|regulation|sec)/i)) {\n  category = 'ç›‘ç®¡åŠ¨æ€';\n  tags.push('ç›‘ç®¡');\n}\nif (lowerText.match(/(defi|dex|swap)/i)) {\n  tags.push('DeFi');\n}\nif (lowerText.match(/(nft|opensea)/i)) {\n  tags.push('NFT');\n}\nif (lowerText.match(/(airdrop|ç©ºæŠ•)/i)) {\n  tags.push('ç©ºæŠ•');\n}\n\n// åŸºç¡€æ ‡ç­¾\ntags.push('Telegram', chat.title || chat.username || 'Private', 'å®æ—¶çˆ†æ–™');\nif (matches[0]) tags.push(matches[0]);\n\n// æå–åª’ä½“ä¿¡æ¯\nlet mediaInfo = [];\nif (message.photo) {\n  mediaInfo.push({\n    type: 'photo',\n    count: message.photo.length,\n    file_id: message.photo[message.photo.length - 1].file_id\n  });\n}\nif (message.video) {\n  mediaInfo.push({\n    type: 'video',\n    file_id: message.video.file_id,\n    duration: message.video.duration\n  });\n}\nif (message.document) {\n  mediaInfo.push({\n    type: 'document',\n    file_name: message.document.file_name,\n    file_id: message.document.file_id\n  });\n}\n\n// æå–é“¾æ¥\nlet urls = [];\nif (message.entities) {\n  urls = message.entities\n    .filter(e => e.type === 'url' || e.type === 'text_link')\n    .map(e => e.url || text.substring(e.offset, e.offset + e.length));\n}\n\nconsole.log(`âœ… æ£€æµ‹åˆ°å…«å¦: [${credibility}åˆ†] ${chat.title || chat.username} - ${text.substring(0, 50)}...`);\n\nreturn [{\n  json: {\n    // åŸºæœ¬ä¿¡æ¯\n    messageId: message.message_id,\n    text: text,\n    textLength: textLength,\n    \n    // èŠå¤©ä¿¡æ¯\n    chatId: chat.id,\n    chatTitle: chat.title || chat.username || 'Private',\n    chatType: chat.type,\n    chatUsername: chat.username || null,\n    \n    // å‘é€è€…ä¿¡æ¯\n    author: from.username || from.first_name || 'Anonymous',\n    authorId: from.id || null,\n    authorFirstName: from.first_name || null,\n    authorLastName: from.last_name || null,\n    \n    // æ—¶é—´ä¿¡æ¯\n    timestamp: new Date(message.date * 1000).toISOString(),\n    messageDate: message.date,\n    \n    // åª’ä½“å†…å®¹\n    hasPhoto: !!message.photo,\n    hasVideo: !!message.video,\n    hasDocument: !!message.document,\n    hasAudio: !!message.audio,\n    hasVoice: !!message.voice,\n    mediaInfo: mediaInfo,\n    \n    // é“¾æ¥\n    hasLinks: hasUrls,\n    urls: urls,\n    \n    // æ¶ˆæ¯ç‰¹å¾\n    forwardFrom: message.forward_from?.username || null,\n    forwardFromChat: message.forward_from_chat?.title || null,\n    replyTo: message.reply_to_message?.message_id || null,\n    \n    // å…«å¦è¯„ä¼°\n    credibilityScore: Math.floor(credibility),\n    gossipLevel: gossipLevel,\n    gossipKeywords: [...new Set(matches)].slice(0, 5),\n    category: category,\n    tags: [...new Set(tags)].slice(0, 8),\n    \n    // åŸå§‹æ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n    rawMessage: JSON.stringify(message).substring(0, 5000)\n  }\n}];"
      },
      "id": "parse-filter",
      "name": "è§£æå’Œè¿‡æ»¤æ¶ˆæ¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300],
      "notes": "æ™ºèƒ½è¿‡æ»¤å’Œè¯„åˆ†"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "slug",
              "name": "slug",
              "value": "=tg-{{ $json.chatId }}-{{ $json.messageId }}-{{ $now.toFormat('yyyyMMdd') }}",
              "type": "string"
            },
            {
              "id": "telegram-url",
              "name": "telegramUrl",
              "value": "={{ $json.chatUsername ? 'https://t.me/' + $json.chatUsername + '/' + $json.messageId : 'https://t.me/c/' + String($json.chatId).replace('-100', '') + '/' + $json.messageId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "generate-meta",
      "name": "ç”Ÿæˆå…ƒæ•°æ®",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [640, 300],
      "notes": "ç”Ÿæˆslugå’ŒTelegramé“¾æ¥"
    },
    {
      "parameters": {
        "jsCode": "// æ„å»ºå¯Œæ–‡æœ¬å†…å®¹\nconst data = $input.first().json;\n\nlet content = `# Telegram å®æ—¶å…«å¦\\n\\n`;\n\n// æ¥æºä¿¡æ¯\ncontent += `## ğŸ“± æ¥æºä¿¡æ¯\\n\\n`;\ncontent += `- **é¢‘é“/ç¾¤ç»„**: ${data.chatTitle}\\n`;\nif (data.chatUsername) {\n  content += `- **ç”¨æˆ·å**: @${data.chatUsername}\\n`;\n}\ncontent += `- **ç±»å‹**: ${data.chatType === 'channel' ? 'é¢‘é“' : data.chatType === 'supergroup' || data.chatType === 'group' ? 'ç¾¤ç»„' : 'ç§èŠ'}\\n`;\ncontent += `- **å‘é€è€…**: @${data.author}\\n`;\ncontent += `- **æ—¶é—´**: ${new Date(data.timestamp).toLocaleString('zh-CN')}\\n`;\ncontent += `\\n`;\n\n// å†…å®¹ç‰¹å¾\nif (data.hasPhoto || data.hasVideo || data.hasDocument || data.hasLinks) {\n  content += `## ğŸ¯ å†…å®¹ç‰¹å¾\\n\\n`;\n  if (data.hasPhoto) content += `- ğŸ“· åŒ…å«å›¾ç‰‡\\n`;\n  if (data.hasVideo) content += `- ğŸ¬ åŒ…å«è§†é¢‘\\n`;\n  if (data.hasDocument) content += `- ğŸ“ åŒ…å«æ–‡ä»¶\\n`;\n  if (data.hasLinks) {\n    content += `- ğŸ”— åŒ…å«é“¾æ¥:\\n`;\n    data.urls.forEach(url => {\n      content += `  - ${url}\\n`;\n    });\n  }\n  content += `\\n`;\n}\n\n// å…«å¦è¯„ä¼°\ncontent += `## ğŸ² å…«å¦è¯„ä¼°\\n\\n`;\ncontent += `- **å¯ä¿¡åº¦**: ${data.credibilityScore}/100\\n`;\ncontent += `- **ç­‰çº§**: ${data.gossipLevel === 'critical' ? 'ğŸ”´ ä¸¥é‡' : data.gossipLevel === 'high' ? 'ğŸŸ  é«˜' : data.gossipLevel === 'medium' ? 'ğŸŸ¡ ä¸­' : 'ğŸŸ¢ ä½'}\\n`;\ncontent += `- **ç±»åˆ«**: ${data.category}\\n`;\nif (data.gossipKeywords.length > 0) {\n  content += `- **å…³é”®è¯**: ${data.gossipKeywords.join(', ')}\\n`;\n}\ncontent += `\\n`;\n\n// åŸæ–‡\ncontent += `## ğŸ“ æ¶ˆæ¯åŸæ–‡\\n\\n`;\ncontent += data.text;\n\nif (data.forwardFrom || data.forwardFromChat) {\n  content += `\\n\\n---\\n\\n`;\n  content += `**ğŸ”€ è½¬å‘è‡ª**: ${data.forwardFromChat || '@' + data.forwardFrom}\\n`;\n}\n\nreturn [{\n  json: {\n    ...data,\n    richContent: content,\n    summary: data.text.substring(0, 300)\n  }\n}];"
      },
      "id": "build-content",
      "name": "æ„å»ºå¯Œæ–‡æœ¬å†…å®¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 300],
      "notes": "ç”Ÿæˆç»“æ„åŒ–çš„Markdownå†…å®¹"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.DIRECTUS_URL || 'http://host.docker.internal:8055' }}/items/news",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.DIRECTUS_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": {{ JSON.stringify($json.text.substring(0, 150)) }},\n  \"summary\": {{ JSON.stringify($json.summary) }},\n  \"content\": {{ JSON.stringify($json.richContent) }},\n  \"ai_summary\": {{ JSON.stringify($json.text.substring(0, 200)) }},\n  \"source\": {{ JSON.stringify('Telegram ' + $json.chatTitle) }},\n  \"source_type\": \"telegram\",\n  \"url\": {{ JSON.stringify($json.telegramUrl) }},\n  \"slug\": {{ JSON.stringify($json.slug) }},\n  \"news_type\": \"gossip\",\n  \"credibility_score\": {{ $json.credibilityScore }},\n  \"verification_status\": \"unverified\",\n  \"gossip_tags\": {{ JSON.stringify($json.tags) }},\n  \"likes_count\": 0,\n  \"comments_count\": 0,\n  \"status\": {{ $json.credibilityScore >= 60 ? '\"published\"' : '\"draft\"' }},\n  \"category\": \"crypto-general\",\n  \"content_published_at\": {{ JSON.stringify($json.timestamp) }},\n  \"published_at\": {{ JSON.stringify(new Date().toISOString()) }}\n}",
        "options": {}
      },
      "id": "publish-directus",
      "name": "å‘å¸ƒåˆ°Directus",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1040, 300],
      "continueOnFail": true,
      "onError": "continueRegularOutput",
      "notes": "å‘å¸ƒï¼Œè‡ªåŠ¨å¤„ç†é‡å¤"
    },
    {
      "parameters": {
        "jsCode": "// å¤„ç†ç»“æœå¹¶è®°å½•æ—¥å¿—\nconst item = $input.first().json;\n\nlet status = 'unknown';\nlet message = '';\n\nif (item.id || item.data?.id) {\n  status = 'success';\n  const data = item.data || item;\n  message = `âœ… å‘å¸ƒæˆåŠŸ: [${data.credibility_score || item.credibilityScore}åˆ†] ${data.title?.substring(0, 50) || 'æ— æ ‡é¢˜'}...`;\n  \n  console.log(message);\n  console.log(`   æ¥æº: ${data.source || item.chatTitle}`);\n  console.log(`   é“¾æ¥: ${data.url || item.telegramUrl}`);\n  console.log(`   çŠ¶æ€: ${data.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}`);\n  \n} else if (item.error?.message?.toLowerCase().includes('duplicate') || \n           item.errors?.[0]?.message?.toLowerCase().includes('duplicate') ||\n           item.errors?.[0]?.extensions?.code === 'RECORD_NOT_UNIQUE') {\n  status = 'duplicate';\n  message = `âš ï¸  é‡å¤æ¶ˆæ¯: ${item.text?.substring(0, 50) || item.title?.substring(0, 50)}...`;\n  console.log(message);\n  \n} else if (item.error || item.errors) {\n  status = 'failed';\n  const error = item.error?.message || item.errors?.[0]?.message || 'æœªçŸ¥é”™è¯¯';\n  message = `âŒ å‘å¸ƒå¤±è´¥: ${error}`;\n  console.error(message);\n  console.error(`   å†…å®¹: ${item.text?.substring(0, 50)}...`);\n  \n} else {\n  status = 'unknown';\n  message = `âš ï¸  æœªçŸ¥çŠ¶æ€`;\n  console.warn(message);\n}\n\nreturn [{\n  json: {\n    status: status,\n    message: message,\n    timestamp: new Date().toISOString(),\n    original: item\n  }\n}];"
      },
      "id": "log-result",
      "name": "è®°å½•ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 300],
      "notes": "è¯¦ç»†çš„æ—¥å¿—è®°å½•"
    }
  ],
  "connections": {
    "Telegramæ¶ˆæ¯ç›‘å¬": {
      "main": [
        [
          {
            "node": "è§£æå’Œè¿‡æ»¤æ¶ˆæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æå’Œè¿‡æ»¤æ¶ˆæ¯": {
      "main": [
        [
          {
            "node": "ç”Ÿæˆå…ƒæ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç”Ÿæˆå…ƒæ•°æ®": {
      "main": [
        [
          {
            "node": "æ„å»ºå¯Œæ–‡æœ¬å†…å®¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºå¯Œæ–‡æœ¬å†…å®¹": {
      "main": [
        [
          {
            "node": "å‘å¸ƒåˆ°Directus",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘å¸ƒåˆ°Directus": {
      "main": [
        [
          {
            "node": "è®°å½•ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-01-06T00:00:00.000Z",
      "updatedAt": "2025-01-06T00:00:00.000Z",
      "id": "crypto-gossip",
      "name": "å¸åœˆå…«å¦"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-01-06T00:00:00.000Z",
  "versionId": "2.0"
}
