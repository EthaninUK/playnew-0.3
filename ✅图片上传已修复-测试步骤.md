# ✅ 图片上传已修复 - 测试步骤

## 🎉 修复内容

已完成以下修复：

1. ✅ **字段类型**: 已配置为 `uuid` 类型
2. ✅ **界面配置**: 已设置为 `file-image` 界面
3. ✅ **特殊标记**: 已添加 `["file"]` 标记
4. ✅ **关系配置**: 已创建与 `directus_files` 的 many-to-one 关系
5. ✅ **Directus 重启**: 已重启服务，配置已生效

---

## 🧪 立即测试

### 测试 1：在 Directus 后台上传和设置封面

1. **刷新 Directus 后台**
   - 按 `Cmd/Ctrl + Shift + R` 强制刷新
   - 或关闭标签页重新打开: http://localhost:8055

2. **进入 Strategies 集合**
   - 点击左侧菜单的 "Strategies"

3. **编辑任意策略**
   - 点击列表中的任意策略

4. **设置封面图片**
   - 找到 "Cover Image" 字段
   - 点击 "Choose File from Library"
   - 应该会弹出文件选择器
   - 选择任意一个图片文件
   - **点击右上角的 ✓ 保存按钮**

5. **验证保存**
   - 保存后刷新页面
   - 检查 Cover Image 字段是否显示了图片缩略图
   - 如果显示了图片，说明保存成功！✅

### 测试 2：上传新图片

1. **进入文件库**
   - 点击左侧的 "Files" 图标

2. **上传图片**
   - 点击右上角 "+ Upload Files"
   - 选择一张图片（推荐 1200x630 px）
   - 上传成功后会在列表中显示

3. **设置为策略封面**
   - 返回 Strategies
   - 编辑任意策略
   - 在 Cover Image 中选择刚上传的图片
   - 保存

### 测试 3：验证图片可访问

1. **获取图片 URL**
   - 在策略列表中，如果配置了图片字段显示，应该能看到图片
   - 或在编辑页面，点击图片可以预览

2. **测试公开访问**（如果需要前端显示）
   - 复制文件 ID
   - 在浏览器新标签页访问：
     ```
     http://localhost:8055/assets/{文件ID}
     ```
   - 如果显示 403 错误，需要配置公共访问权限（见下方）

---

## 🔐 配置公共访问权限（可选，用于前端显示）

如果需要在前端网站显示图片，需要配置公共访问权限：

1. **进入权限设置**
   - 点击左上角 ⚙️ 设置
   - 选择 "Access Control"

2. **配置 Public 角色**
   - 找到 "Public" 角色并点击
   - 找到 "Directus Files" 行

3. **启用读取权限**
   - 勾选 "Read" ✅
   - 确保设置为：
     - Access: "All Items"
     - Fields: "All Fields"

4. **保存**
   - 点击右上角 "Save"

5. **测试**
   - 在无痕浏览器窗口访问图片 URL
   - 应该能直接看到图片（无需登录）

---

## 📊 预期结果

### ✅ 成功标志

1. **后台编辑页面**
   - Cover Image 字段显示文件选择器
   - 可以选择文件
   - 选择后显示图片缩略图
   - 保存后图片保持显示（不会消失）

2. **策略列表页面**
   - 如果配置了图片列显示，能看到图片缩略图

3. **API 访问**
   - 查询策略时返回 `cover_image` 字段值
   - 值是文件 ID（UUID 格式）

4. **前端显示**（需要配置公共权限）
   - 可以通过 `http://localhost:8055/assets/{fileId}` 访问图片
   - 返回 200 状态码
   - 显示图片内容

---

## 🚨 如果测试失败

### 问题 1：选择文件后保存，刷新后消失

**可能原因**: 浏览器缓存或 Directus 配置未完全加载

**解决方案**:
```bash
# 再次重启 Directus
docker-compose restart directus

# 等待 20 秒后刷新浏览器
```

### 问题 2：无法选择文件，点击无反应

**可能原因**: 浏览器 JavaScript 错误

**解决方案**:
1. 按 F12 打开开发者工具
2. 查看 Console 标签的错误信息
3. 清除浏览器缓存
4. 使用无痕模式测试

### 问题 3：文件访问返回 403

**可能原因**: 缺少公共访问权限

**解决方案**:
- 按照上面"配置公共访问权限"章节操作
- 或参考：[🔧图片上传快速修复.md](🔧图片上传快速修复.md)

### 问题 4：上传的图片不在文件选择器中

**可能原因**: 文件上传失败或权限问题

**解决方案**:
1. 检查 Directus 日志：
   ```bash
   docker-compose logs directus --tail=50 | grep -i error
   ```
2. 确保你的角色有 directus_files 的 Create 权限
3. 检查文件大小是否超过限制（默认 100MB）

---

## 🧰 诊断脚本

### 快速诊断
```bash
node diagnose-cover-image-issue.js
```

应该显示：
- ✅ 字段类型正确
- ✅ 关系配置存在
- ✅ 可以更新封面
- ✅ 封面更新成功

### 测试文件上传
```bash
node test-file-upload.js
```

应该显示：
- ✅ 上传成功
- ✅ 可以设置为封面
- ✅ 验证通过

---

## 📱 在前端显示图片

### 更新 Directus 查询

确保查询时包含文件信息：

```typescript
// frontend/lib/directus.ts
const strategies = await directus.request(
  readItems('strategies', {
    filter: { status: { _eq: 'published' } },
    fields: [
      '*',
      'cover_image.id',
      'cover_image.title',
      'cover_image.width',
      'cover_image.height',
      'cover_image.type'
    ]
  })
);
```

### 在组件中显示

```typescript
// 策略卡片组件
{strategy.cover_image && (
  <img
    src={`http://localhost:8055/assets/${strategy.cover_image.id}`}
    alt={strategy.title}
    className="w-full h-48 object-cover rounded-t-lg"
  />
)}
```

或使用 Next.js Image：

```typescript
import Image from 'next/image';

{strategy.cover_image && (
  <Image
    src={`http://localhost:8055/assets/${strategy.cover_image.id}?width=800&height=400&fit=cover`}
    alt={strategy.title}
    width={800}
    height={400}
    className="rounded-t-lg"
  />
)}
```

---

## 🎯 下一步

图片上传功能正常后：

1. ✅ 为已创建的 5 个指南添加封面
2. 📸 准备更多图片素材
3. 🎨 统一封面图片风格
4. 🖼️ 更新前端代码显示封面
5. 📝 在 Markdown 内容中插入图片

---

## 💡 图片最佳实践

### 封面图片规格
- **尺寸**: 1200x630 px（最佳）
- **格式**: JPG（照片）或 PNG（图标、透明背景）
- **大小**: < 500KB（优化后）
- **比例**: 16:9 或 1.91:1

### 图片命名
- 使用英文和连字符
- 描述性命名
- 例如：`lending-guide-cover.jpg`

### 图片优化
使用在线工具压缩：
- TinyPNG: https://tinypng.com
- Squoosh: https://squoosh.app

---

## ✅ 验证清单

在完成测试后，确认以下所有项：

- [ ] 可以在 Directus 后台上传文件
- [ ] 文件库中能看到上传的文件
- [ ] 可以在编辑策略时选择封面
- [ ] 选择后能看到图片缩略图
- [ ] 保存后图片不会消失
- [ ] 刷新页面后图片仍然显示
- [ ] （可选）可以无需登录访问图片 URL
- [ ] （可选）前端页面可以显示图片

---

**所有步骤完成！如果有任何问题，请查看上面的故障排除部分或运行诊断脚本。** 🎉

最后更新: 2025-10-27
