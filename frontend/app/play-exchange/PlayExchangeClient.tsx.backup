'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Sparkles, Gift, Users, FileText, Send, Copy, Check, TrendingUp, Award, Clock, Loader2, ArrowUpRight } from 'lucide-react';
import { getCategoryGroups, type CategoryGroup } from '@/lib/directus';
import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';

interface Play {
  id: string;
  title: string;
  slug: string;
  summary: string;
  category: string;
  risk_level: number;
  apy_min: number;
  apy_max: number;
  cover_image: string | null;
  card_index: number;
}

interface UserInfo {
  user_id: string;
  email: string;
  credits: number;
  first_draw_used: boolean;
  referral_code: string;
  total_plays: number;
  my_plays: string[];
}

interface Submission {
  id: string;
  title: string;
  category: string;
  status: 'pending' | 'approved' | 'rejected';
  credits_awarded: number;
  review_notes: string;
  created_at: string;
  reviewed_at: string;
}

export default function PlayExchangeClient() {
  const router = useRouter();
  const { user: authUser, loading: authLoading, supabase } = useAuth();

  // ç”¨æˆ·çŠ¶æ€
  const [userInfo, setUserInfo] = useState<UserInfo | null>(null);
  const [pageLoading, setPageLoading] = useState(true);

  // åˆ†ç±»æ•°æ®
  const [categoryGroups, setCategoryGroups] = useState<CategoryGroup[]>([]);
  const [allCategories, setAllCategories] = useState<Array<{ name: string; slug: string; icon?: string }>>([]);

  // ä»Šæ—¥ç²¾é€‰
  const [dailyFeatured, setDailyFeatured] = useState<{
    date: string;
    theme_label: string;
    plays: Play[];
  } | null>(null);

  // ç¿»ç‰ŒçŠ¶æ€
  const [isDrawing, setIsDrawing] = useState(false);
  const [flippedCards, setFlippedCards] = useState([false, false, false]);
  const [selectedIndex, setSelectedIndex] = useState<number | null>(null);
  const [showResult, setShowResult] = useState(false);
  const [selectedPlay, setSelectedPlay] = useState<Play | null>(null);

  // æäº¤è®°å½•
  const [submissions, setSubmissions] = useState<Submission[]>([]);
  const [submissionForm, setSubmissionForm] = useState({
    title: '',
    category: '',
    content: '',
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  // é‚€è¯·çŠ¶æ€
  const [referralInfo, setReferralInfo] = useState<any>(null);
  const [linkCopied, setLinkCopied] = useState(false);

  // åˆå§‹åŒ–ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    checkAuth();
    loadCategories();
    loadDailyFeatured();
  }, []);

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  async function checkAuth() {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      console.log('ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€:', session ? 'å·²ç™»å½•' : 'æœªç™»å½•', session?.user?.email);

      if (session?.user) {
        setUser(session.user);
        await loadUserInfo(session.access_token);
        await loadSubmissions(session.access_token);
        await loadReferralInfo(session.access_token);
      } else {
        console.log('âš ï¸ æœªæ£€æµ‹åˆ°ç”¨æˆ·ä¼šè¯');
      }
    } catch (error) {
      console.error('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  }

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  async function loadUserInfo(token: string) {
    try {
      const res = await fetch('/api/play-exchange/user-info', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        setUserInfo(data.data);
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  // åŠ è½½åˆ†ç±»æ•°æ®
  async function loadCategories() {
    const groups = await getCategoryGroups();
    setCategoryGroups(groups);

    const allCats: Array<{ name: string; slug: string; icon?: string }> = [];
    groups.forEach(group => {
      group.children.forEach(child => {
        allCats.push({
          name: child.name,
          slug: child.slug,
          icon: child.icon
        });
      });
    });
    setAllCategories(allCats);
  }

  // åŠ è½½ä»Šæ—¥ç²¾é€‰
  async function loadDailyFeatured() {
    try {
      const res = await fetch('/api/play-exchange/daily-featured');
      const data = await res.json();
      if (data.success) {
        setDailyFeatured(data.data);
      }
    } catch (error) {
      console.error('åŠ è½½ä»Šæ—¥ç²¾é€‰å¤±è´¥:', error);
    }
  }

  // åŠ è½½æäº¤è®°å½•
  async function loadSubmissions(token: string) {
    try {
      const res = await fetch('/api/play-exchange/submit', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        setSubmissions(data.data.submissions);
      }
    } catch (error) {
      console.error('åŠ è½½æäº¤è®°å½•å¤±è´¥:', error);
    }
  }

  // åŠ è½½é‚€è¯·ä¿¡æ¯
  async function loadReferralInfo(token: string) {
    try {
      const res = await fetch('/api/play-exchange/referral', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        setReferralInfo(data.data);
      }
    } catch (error) {
      console.error('åŠ è½½é‚€è¯·ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  // ç¿»ç‰Œ
  async function handleFlipCard(index: number) {
    if (!user) {
      toast.error('è¯·å…ˆç™»å½•');
      router.push('/auth/login');
      return;
    }

    if (selectedIndex !== null || isDrawing) return;

    setIsDrawing(true);
    setSelectedIndex(index);

    // ç¿»ç‰ŒåŠ¨ç”»
    const newFlipped = [false, false, false];
    newFlipped[index] = true;
    setFlippedCards(newFlipped);

    // å»¶è¿Ÿæ˜¾ç¤ºç»“æœ
    setTimeout(async () => {
      const play = dailyFeatured?.plays[index];
      if (!play) return;

      setSelectedPlay(play);

      // è°ƒç”¨ API è¿›è¡Œäº¤æ¢
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch('/api/play-exchange/draw', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session?.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            card_index: index,
            play_id: play.id
          })
        });

        const data = await res.json();
        if (data.success) {
          toast.success(data.data.message);
          setShowResult(true);
          // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
          await loadUserInfo(session!.access_token);
        } else {
          toast.error(data.error);
          setIsDrawing(false);
          setSelectedIndex(null);
          setFlippedCards([false, false, false]);
        }
      } catch (error) {
        console.error('ç¿»ç‰Œå¤±è´¥:', error);
        toast.error('ç¿»ç‰Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        setIsDrawing(false);
        setSelectedIndex(null);
        setFlippedCards([false, false, false]);
      }
    }, 800);
  }

  // é‡ç½®ç¿»ç‰Œ
  function handleReset() {
    setIsDrawing(false);
    setFlippedCards([false, false, false]);
    setSelectedIndex(null);
    setShowResult(false);
    setSelectedPlay(null);
    loadDailyFeatured();
  }

  // æäº¤ç©æ³•
  async function handleSubmitPlay() {
    if (!user) {
      toast.error('è¯·å…ˆç™»å½•');
      router.push('/auth/login');
      return;
    }

    if (!submissionForm.title || !submissionForm.category || !submissionForm.content) {
      toast.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      return;
    }

    setIsSubmitting(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      const res = await fetch('/api/play-exchange/submit', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session?.access_token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(submissionForm)
      });

      const data = await res.json();
      if (data.success) {
        toast.success(data.data.message);
        setSubmissionForm({ title: '', category: allCategories[0]?.slug || '', content: '' });
        await loadSubmissions(session!.access_token);
      } else {
        toast.error(data.error);
      }
    } catch (error) {
      console.error('æäº¤å¤±è´¥:', error);
      toast.error('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      setIsSubmitting(false);
    }
  }

  // å¤åˆ¶é‚€è¯·é“¾æ¥
  function handleCopyLink() {
    if (referralInfo?.referral_link) {
      navigator.clipboard.writeText(referralInfo.referral_link);
      setLinkCopied(true);
      toast.success('é‚€è¯·é“¾æ¥å·²å¤åˆ¶');
      setTimeout(() => setLinkCopied(false), 2000);
    }
  }

  // å½“åˆ†ç±»åŠ è½½å®Œæˆåï¼Œè®¾ç½®é»˜è®¤åˆ†ç±»
  useEffect(() => {
    if (allCategories.length > 0 && !submissionForm.category) {
      setSubmissionForm(prev => ({
        ...prev,
        category: allCategories[0].slug
      }));
    }
  }, [allCategories]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-emerald-500" />
      </div>
    );
  }

  return (
    <div className="min-h-screen relative overflow-hidden bg-gradient-to-br from-slate-950 via-slate-900 to-emerald-950">
      {/* èƒŒæ™¯è£…é¥° */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-0 left-1/4 w-96 h-96 bg-emerald-500/10 rounded-full blur-3xl" />
        <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl" />
      </div>

      <div className="relative z-10 container mx-auto px-4 py-12 max-w-7xl">
        {/* æ ‡é¢˜åŒºåŸŸ */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-12"
        >
          <div className="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-full mb-4">
            <Sparkles className="w-4 h-4 text-emerald-400" />
            <span className="text-sm text-emerald-300">æ¯æ—¥ä¸€æ¬¡å…è´¹ç¿»ç‰Œæœºä¼š</span>
          </div>
          <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-emerald-400 via-teal-300 to-cyan-400 bg-clip-text text-transparent">
            ç©æ³•äº¤æ¢ç³»ç»Ÿ
          </h1>
          <p className="text-lg text-slate-400">ç¿»ç‰Œè·å–ç‹¬å®¶ç­–ç•¥ Â· æäº¤ç©æ³•èµšç§¯åˆ† Â· é‚€è¯·å¥½å‹å…±æˆé•¿</p>

          {/* ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º */}
          {user && userInfo && (
            <div className="mt-6 inline-flex items-center gap-4 px-6 py-3 bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl">
              <div className="flex items-center gap-2">
                <Gift className="w-5 h-5 text-amber-400" />
                <span className="text-slate-300">ç§¯åˆ†ä½™é¢:</span>
                <span className="text-2xl font-bold text-amber-400">{userInfo.credits}</span>
              </div>
              <div className="w-px h-6 bg-slate-700" />
              <div className="flex items-center gap-2">
                <TrendingUp className="w-5 h-5 text-emerald-400" />
                <span className="text-slate-300">å·²è·å¾—:</span>
                <span className="text-lg font-semibold text-emerald-400">{userInfo.total_plays}</span>
                <span className="text-slate-500 text-sm">ä¸ªç©æ³•</span>
              </div>
            </div>
          )}
        </motion.div>

        {!user && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            className="max-w-2xl mx-auto mb-12 p-6 bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl text-center"
          >
            <p className="text-slate-300 mb-4">è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ç©æ³•äº¤æ¢åŠŸèƒ½</p>
            <button
              onClick={() => router.push('/auth/login')}
              className="px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl transition-colors"
            >
              ç«‹å³ç™»å½•
            </button>
          </motion.div>
        )}

        {/* ä»Šæ—¥ç²¾é€‰åŒºåŸŸ */}
        {user && dailyFeatured && (
          <motion.section
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="mb-12"
          >
            <div className="bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-3xl p-8">
              {/* æ ‡é¢˜ */}
              <div className="text-center mb-8">
                <div className="inline-flex items-center gap-2 px-4 py-2 bg-purple-500/10 border border-purple-500/20 rounded-full mb-4">
                  <Gift className="w-4 h-4 text-purple-400" />
                  <span className="text-sm text-purple-300">
                    {dailyFeatured.theme_label || 'ä»Šæ—¥ç²¾é€‰'}
                  </span>
                </div>
                <h2 className="text-3xl font-bold mb-2 text-white">
                  ç¿»å¼€ä½ çš„é­”æ³•å¡
                </h2>
                <p className="text-slate-400">
                  {userInfo?.first_draw_used
                    ? 'æ¯æ¬¡ç¿»ç‰Œæ¶ˆè€— 1 ç§¯åˆ† Â· é€‰æ‹©ä¸€å¼ å¡ç‰‡è·å–ç‹¬å®¶ç­–ç•¥'
                    : 'é¦–æ¬¡ç¿»ç‰Œå…è´¹ Â· é€‰æ‹©ä¸€å¼ å¡ç‰‡è·å–ç‹¬å®¶ç­–ç•¥'
                  }
                </p>
              </div>

              {/* é­”æ³•å¡ */}
              <div className="flex justify-center gap-8 mb-8">
                {dailyFeatured.plays.map((play, index) => (
                  <MagicCard
                    key={index}
                    index={index}
                    play={play}
                    isFlipped={flippedCards[index]}
                    isSelected={selectedIndex === index}
                    onClick={() => handleFlipCard(index)}
                    disabled={isDrawing || showResult}
                  />
                ))}
              </div>

              {/* ç¿»ç‰Œç»“æœ */}
              <AnimatePresence>
                {showResult && selectedPlay && (
                  <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0 }}
                    className="text-center"
                  >
                    <div className="inline-block px-8 py-6 bg-gradient-to-r from-emerald-500/20 to-teal-500/20 border-2 border-emerald-500/50 rounded-2xl backdrop-blur-sm mb-6">
                      <p className="text-xl font-bold mb-2 text-white flex items-center justify-center gap-2">
                        <Award className="w-6 h-6 text-yellow-400" />
                        æ­å–œ!ä½ è·å¾—äº†:
                      </p>
                      <p className="text-2xl font-bold text-emerald-400 mb-1">
                        {selectedPlay.title}
                      </p>
                      <p className="text-sm text-slate-400">
                        {selectedPlay.category}
                      </p>
                    </div>

                    <div className="flex gap-4 justify-center">
                      <button
                        onClick={handleReset}
                        className="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-colors"
                      >
                        é‡æ–°ç¿»ç‰Œ
                      </button>
                      <button
                        onClick={() => router.push(`/strategies/${selectedPlay.slug}`)}
                        className="px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl transition-colors flex items-center gap-2"
                      >
                        æŸ¥çœ‹è¯¦æƒ…
                        <ArrowUpRight className="w-4 h-4" />
                      </button>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          </motion.section>
        )}

        {/* åŠŸèƒ½åŒºåŸŸ */}
        {user && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
            {/* æäº¤ç©æ³•åŒºåŸŸ */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.2 }}
              className="bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-3xl p-8"
            >
              <div className="flex items-center gap-3 mb-6">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center">
                  <FileText className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h3 className="text-2xl font-bold text-white">æäº¤ç©æ³•</h3>
                  <p className="text-sm text-slate-400">åˆ†äº«ä½ çš„ç‹¬å®¶ç­–ç•¥è·å¾—ç§¯åˆ†</p>
                </div>
              </div>

              {/* æäº¤è¡¨å• */}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    ç©æ³•æ ‡é¢˜ *
                  </label>
                  <input
                    type="text"
                    value={submissionForm.title}
                    onChange={(e) => setSubmissionForm({ ...submissionForm, title: e.target.value })}
                    className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-emerald-500 transition-colors"
                    placeholder="ä¾‹å¦‚: LayerZero ç©ºæŠ•å®Œå…¨æ”»ç•¥"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    ç©æ³•ç±»åˆ« *
                  </label>
                  <select
                    value={submissionForm.category}
                    onChange={(e) => setSubmissionForm({ ...submissionForm, category: e.target.value })}
                    className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-emerald-500 transition-colors"
                  >
                    {allCategories.map((cat) => (
                      <option key={cat.slug} value={cat.slug}>
                        {cat.icon} {cat.name}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    è¯¦ç»†å†…å®¹ *
                  </label>
                  <textarea
                    value={submissionForm.content}
                    onChange={(e) => setSubmissionForm({ ...submissionForm, content: e.target.value })}
                    className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-emerald-500 transition-colors resize-none"
                    rows={6}
                    placeholder="è¯¦ç»†æè¿°ä½ çš„ç©æ³•ç­–ç•¥ï¼ŒåŒ…æ‹¬æ­¥éª¤ã€æ”¶ç›Šé¢„æœŸã€é£é™©æç¤ºç­‰..."
                  />
                </div>

                {/* æç¤ºä¿¡æ¯ */}
                <div className="p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl">
                  <p className="text-sm text-amber-300 flex items-start gap-2">
                    <Sparkles className="w-4 h-4 mt-0.5 shrink-0" />
                    <span>
                      å†…å®¹è¶Šè¯¦ç»†ï¼Œé€šè¿‡ç‡è¶Šé«˜ã€‚å®¡æ ¸é€šè¿‡åå°†è·å¾— 1-100 ç§¯åˆ†å¥–åŠ±
                    </span>
                  </p>
                </div>

                <button
                  onClick={handleSubmitPlay}
                  disabled={isSubmitting}
                  className="w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {isSubmitting ? (
                    <>
                      <Loader2 className="w-5 h-5 animate-spin" />
                      æäº¤ä¸­...
                    </>
                  ) : (
                    <>
                      <Send className="w-5 h-5" />
                      ç«‹å³æäº¤æ¢å–ç§¯åˆ†
                    </>
                  )}
                </button>
              </div>
            </motion.section>

            {/* é‚€è¯·å¥½å‹åŒºåŸŸ */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
              className="bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-3xl p-8"
            >
              <div className="flex items-center gap-3 mb-6">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                  <Users className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h3 className="text-2xl font-bold text-white">é‚€è¯·å¥½å‹</h3>
                  <p className="text-sm text-slate-400">æ¯é‚€è¯·1äººæ³¨å†Œè·å¾—1ç§¯åˆ†</p>
                </div>
              </div>

              {referralInfo && (
                <>
                  {/* é‚€è¯·é“¾æ¥ */}
                  <div className="mb-6">
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                      ä½ çš„ä¸“å±é‚€è¯·é“¾æ¥
                    </label>
                    <div className="flex gap-2">
                      <div className="flex-1 px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-emerald-400 font-mono text-sm overflow-x-auto">
                        {referralInfo.referral_link}
                      </div>
                      <button
                        onClick={handleCopyLink}
                        className="px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl transition-colors flex items-center gap-2 shrink-0"
                      >
                        {linkCopied ? (
                          <>
                            <Check className="w-5 h-5" />
                            å·²å¤åˆ¶
                          </>
                        ) : (
                          <>
                            <Copy className="w-5 h-5" />
                            å¤åˆ¶
                          </>
                        )}
                      </button>
                    </div>
                  </div>

                  {/* é‚€è¯·ç»Ÿè®¡ */}
                  <div className="grid grid-cols-3 gap-4 mb-6">
                    <div className="p-4 bg-slate-900/30 border border-slate-700/50 rounded-xl text-center">
                      <div className="text-2xl font-bold text-purple-400 mb-1">
                        {referralInfo.stats?.total_invited || 0}
                      </div>
                      <div className="text-xs text-slate-400">å·²é‚€è¯·</div>
                    </div>
                    <div className="p-4 bg-slate-900/30 border border-slate-700/50 rounded-xl text-center">
                      <div className="text-2xl font-bold text-emerald-400 mb-1">
                        {referralInfo.stats?.total_registered || 0}
                      </div>
                      <div className="text-xs text-slate-400">å·²æ³¨å†Œ</div>
                    </div>
                    <div className="p-4 bg-slate-900/30 border border-slate-700/50 rounded-xl text-center">
                      <div className="text-2xl font-bold text-amber-400 mb-1">
                        {referralInfo.stats?.credits_earned || 0}
                      </div>
                      <div className="text-xs text-slate-400">è·å¾—ç§¯åˆ†</div>
                    </div>
                  </div>

                  {/* æœ€è¿‘é‚€è¯·è®°å½• */}
                  {referralInfo.recent_referrals && referralInfo.recent_referrals.length > 0 && (
                    <div>
                      <h4 className="text-sm font-semibold text-slate-300 mb-3">æœ€è¿‘é‚€è¯·</h4>
                      <div className="space-y-2 max-h-60 overflow-y-auto">
                        {referralInfo.recent_referrals.map((ref: any) => (
                          <div
                            key={ref.id}
                            className="p-3 bg-slate-900/30 border border-slate-700/50 rounded-lg flex items-center justify-between"
                          >
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-sm font-bold">
                                {ref.username ? ref.username[0].toUpperCase() : 'U'}
                              </div>
                              <div>
                                <p className="text-sm font-medium text-white">
                                  {ref.username || 'ç”¨æˆ·'}
                                </p>
                                <p className="text-xs text-slate-500">
                                  {new Date(ref.registered_at).toLocaleDateString()}
                                </p>
                              </div>
                            </div>
                            {ref.credit_awarded && (
                              <div className="text-emerald-400 text-sm font-semibold">
                                +1 ç§¯åˆ†
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </>
              )}
            </motion.section>
          </div>
        )}

        {/* æˆ‘çš„æäº¤è®°å½• */}
        {user && submissions.length > 0 && (
          <motion.section
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
            className="mb-12"
          >
            <div className="bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-3xl p-8">
              <div className="flex items-center gap-3 mb-6">
                <FileText className="w-6 h-6 text-emerald-400" />
                <h3 className="text-2xl font-bold text-white">
                  æˆ‘çš„æäº¤è®°å½•
                  <span className="ml-2 text-lg text-slate-400">({submissions.length})</span>
                </h3>
              </div>

              <div className="space-y-4">
                {submissions.map((submission) => (
                  <div
                    key={submission.id}
                    className="p-6 bg-slate-900/30 border border-slate-700/50 rounded-xl hover:border-slate-600/50 transition-colors"
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <h4 className="text-lg font-semibold text-white mb-1">
                          {submission.title}
                        </h4>
                        <div className="flex items-center gap-3 text-sm text-slate-400">
                          <span>{submission.category}</span>
                          <span>Â·</span>
                          <span>{new Date(submission.created_at).toLocaleString()}</span>
                        </div>
                      </div>
                      <div>
                        {submission.status === 'pending' && (
                          <span className="inline-flex items-center gap-2 px-3 py-1 bg-amber-500/10 border border-amber-500/20 rounded-full text-amber-400 text-sm">
                            <Clock className="w-4 h-4" />
                            å®¡æ ¸ä¸­
                          </span>
                        )}
                        {submission.status === 'approved' && (
                          <span className="inline-flex items-center gap-2 px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full text-emerald-400 text-sm">
                            <Check className="w-4 h-4" />
                            å·²é€šè¿‡
                          </span>
                        )}
                        {submission.status === 'rejected' && (
                          <span className="inline-flex items-center gap-2 px-3 py-1 bg-red-500/10 border border-red-500/20 rounded-full text-red-400 text-sm">
                            âœ• å·²æ‹’ç»
                          </span>
                        )}
                      </div>
                    </div>

                    {submission.status === 'approved' && (
                      <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
                        <div className="flex items-center gap-2 text-emerald-400">
                          <Gift className="w-5 h-5" />
                          <span className="font-semibold">
                            è·å¾—ç§¯åˆ†: +{submission.credits_awarded} ğŸ’
                          </span>
                        </div>
                        {submission.review_notes && (
                          <p className="mt-2 text-sm text-slate-300">
                            å¤‡æ³¨: {submission.review_notes}
                          </p>
                        )}
                      </div>
                    )}

                    {submission.status === 'pending' && (
                      <p className="text-sm text-slate-400">
                        ç®¡ç†å‘˜æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...
                      </p>
                    )}

                    {submission.status === 'rejected' && submission.review_notes && (
                      <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
                        <p className="text-sm text-red-300">
                          åŸå› : {submission.review_notes}
                        </p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </motion.section>
        )}

        {/* æˆ‘å·²è·å¾—çš„ç©æ³• */}
        {user && userInfo && userInfo.my_plays && userInfo.my_plays.length > 0 && (
          <motion.section
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
            className="mb-12"
          >
            <div className="bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-3xl p-8">
              <div className="flex items-center gap-3 mb-6">
                <TrendingUp className="w-6 h-6 text-emerald-400" />
                <h3 className="text-2xl font-bold text-white">
                  æˆ‘å·²è·å¾—çš„ç©æ³•
                  <span className="ml-2 text-lg text-slate-400">({userInfo.my_plays.length})</span>
                </h3>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {userInfo.my_plays.map((playId: string) => {
                  const play = dailyFeatured?.plays.find(p => p.id === playId);
                  if (!play) return null;

                  return (
                    <button
                      key={playId}
                      onClick={() => router.push(`/strategies/${play.slug}`)}
                      className="p-6 bg-slate-900/30 border border-slate-700/50 rounded-xl hover:border-emerald-500/50 transition-all group text-left"
                    >
                      <div className="flex items-start gap-4">
                        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-2xl shrink-0">
                          {play.category === 'ç©ºæŠ•' && 'ğŸ'}
                          {play.category === 'DeFi' && 'ğŸ’°'}
                          {play.category === 'å¥—åˆ©' && 'âš¡'}
                          {!['ç©ºæŠ•', 'DeFi', 'å¥—åˆ©'].includes(play.category) && 'ğŸ“Š'}
                        </div>
                        <div className="flex-1 min-w-0">
                          <h4 className="text-lg font-semibold text-white mb-1 line-clamp-2 group-hover:text-emerald-400 transition-colors">
                            {play.title}
                          </h4>
                          <p className="text-sm text-slate-400">
                            {play.category}
                          </p>
                          {play.apy_min && play.apy_max && (
                            <p className="text-sm text-emerald-400 mt-2">
                              æ”¶ç›Š: {play.apy_min}-{play.apy_max}%
                            </p>
                          )}
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          </motion.section>
        )}

        {/* æ¸©é¦¨æç¤º */}
        {user && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.6 }}
            className="max-w-4xl mx-auto p-6 bg-amber-500/10 border border-amber-500/20 rounded-2xl"
          >
            <h4 className="font-bold mb-3 text-amber-400 flex items-center gap-2">
              <Sparkles className="w-5 h-5" />
              æ¸©é¦¨æç¤º
            </h4>
            <ul className="text-sm text-slate-300 space-y-2">
              <li className="flex items-start gap-2">
                <span className="text-amber-400 mt-0.5">â€¢</span>
                <span>é¦–æ¬¡ç¿»ç‰Œå…è´¹ï¼Œä¹‹åæ¯æ¬¡ç¿»ç‰Œæ¶ˆè€— 1 ç§¯åˆ†</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-amber-400 mt-0.5">â€¢</span>
                <span>æäº¤ä¼˜è´¨ç©æ³•å¯è·å¾— 1-100 ç§¯åˆ†ï¼Œå†…å®¹è¶Šè¯¦ç»†å¥–åŠ±è¶Šé«˜</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-amber-400 mt-0.5">â€¢</span>
                <span>é‚€è¯·å¥½å‹æ³¨å†Œå¯è·å¾—ç§¯åˆ†ï¼Œæ¯æˆåŠŸé‚€è¯·1äººè·å¾—1ç§¯åˆ†</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-amber-400 mt-0.5">â€¢</span>
                <span>æ‰€æœ‰è·å¾—çš„ç©æ³•éƒ½ä¼šä¿å­˜åœ¨"æˆ‘çš„ç©æ³•"ä¸­ï¼Œå¯éšæ—¶æŸ¥çœ‹</span>
              </li>
            </ul>
          </motion.div>
        )}
      </div>
    </div>
  );
}

// Magic Card Component
interface MagicCardProps {
  index: number;
  play: Play;
  isFlipped: boolean;
  isSelected: boolean;
  onClick: () => void;
  disabled: boolean;
}

function MagicCard({
  index,
  play,
  isFlipped,
  isSelected,
  onClick,
  disabled,
}: MagicCardProps) {
  const getCategoryIcon = (category: string) => {
    if (category.includes('ç©ºæŠ•')) return 'ğŸ';
    if (category.includes('DeFi')) return 'ğŸ’°';
    if (category.includes('å¥—åˆ©')) return 'âš¡';
    if (category.includes('è´¨æŠ¼')) return 'ğŸ”’';
    if (category.includes('æŒ–çŸ¿')) return 'â›ï¸';
    return 'ğŸ“Š';
  };

  const getCategoryColor = () => {
    const colors = [
      'from-blue-500 to-blue-600',
      'from-purple-500 to-purple-600',
      'from-emerald-500 to-emerald-600',
    ];
    return colors[index % colors.length];
  };

  const getBorderColor = () => {
    const borders = [
      'border-blue-400',
      'border-purple-400',
      'border-emerald-400',
    ];
    return borders[index % borders.length];
  };

  return (
    <motion.div
      className="relative"
      style={{ perspective: '1000px' }}
      whileHover={!disabled && !isFlipped ? { y: -10 } : {}}
      onClick={!disabled ? onClick : undefined}
    >
      <motion.div
        className="relative w-56 h-80 cursor-pointer"
        animate={{ rotateY: isFlipped ? 180 : 0 }}
        transition={{ duration: 0.6, ease: 'easeInOut' }}
        style={{ transformStyle: 'preserve-3d' }}
      >
        {/* Card Back */}
        <div
          className="absolute w-full h-full rounded-xl"
          style={{
            backfaceVisibility: 'hidden',
            transform: 'rotateY(0deg)',
          }}
        >
          <div className="w-full h-full bg-gradient-to-br from-purple-600 via-purple-700 to-indigo-800 rounded-xl border-4 border-purple-400/50 shadow-2xl flex flex-col items-center justify-center relative overflow-hidden">
            {/* Animated Background Pattern */}
            <motion.div
              className="absolute inset-0 opacity-20"
              animate={{
                backgroundPosition: ['0% 0%', '100% 100%'],
              }}
              transition={{
                duration: 3,
                repeat: Infinity,
                repeatType: 'reverse',
              }}
              style={{
                backgroundImage:
                  'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px)',
              }}
            />

            {/* Mystery Symbol */}
            <motion.div
              className="text-8xl mb-4"
              animate={{
                scale: [1, 1.1, 1],
                rotate: [0, 5, -5, 0],
              }}
              transition={{
                duration: 2,
                repeat: Infinity,
              }}
            >
              â“
            </motion.div>

            <div className="text-2xl font-bold text-white/90">ç¥ç§˜å¡</div>

            {/* Hover Glow */}
            {!disabled && !isFlipped && (
              <motion.div
                className="absolute inset-0 bg-white/0 hover:bg-white/10 rounded-xl transition-all duration-300"
                whileHover={{ boxShadow: '0 0 30px rgba(167, 139, 250, 0.6)' }}
              />
            )}
          </div>
        </div>

        {/* Card Front */}
        <div
          className="absolute w-full h-full rounded-xl"
          style={{
            backfaceVisibility: 'hidden',
            transform: 'rotateY(180deg)',
          }}
        >
          <div
            className={`w-full h-full rounded-xl border-4 ${getBorderColor()} shadow-2xl relative overflow-hidden bg-gradient-to-br ${getCategoryColor()}`}
          >
            {/* Category Badge */}
            <div className="absolute top-4 right-4 px-3 py-1 bg-black/40 backdrop-blur-sm rounded-full text-xs font-bold border border-white/30">
              {play.category}
            </div>

            {/* Risk Level */}
            <div className="absolute top-4 left-4 px-3 py-1 bg-black/40 backdrop-blur-sm rounded-full text-xs font-bold border border-white/30">
              é£é™©: {play.risk_level}/5
            </div>

            {/* Card Content */}
            <div className="relative h-full flex flex-col items-center justify-center p-6 text-white">
              <div className="text-center mb-4">
                <div className="text-6xl mb-4">
                  {getCategoryIcon(play.category)}
                </div>

                <h3 className="text-xl font-bold mb-3 leading-tight line-clamp-2">
                  {play.title}
                </h3>

                <p className="text-sm text-white/80 mb-4 line-clamp-3">
                  {play.summary}
                </p>

                {play.apy_min && play.apy_max && (
                  <div className="inline-block px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-sm font-semibold mb-3">
                    æ”¶ç›Š: {play.apy_min}-{play.apy_max}%
                  </div>
                )}
              </div>

              {/* Selected Indicator */}
              {isSelected && (
                <motion.div
                  initial={{ opacity: 0, scale: 0.8 }}
                  animate={{ opacity: 1, scale: 1 }}
                  className="absolute bottom-6 left-0 right-0 text-center"
                >
                  <div className="inline-block px-6 py-2 bg-emerald-500 rounded-full font-bold text-white shadow-lg">
                    âœ“ å·²é€‰æ‹©
                  </div>
                </motion.div>
              )}

              {/* Not Selected Overlay */}
              {!isSelected && isFlipped && (
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center rounded-xl">
                  <span className="text-xl font-bold text-white/70">
                    æœªé€‰æ‹©
                  </span>
                </div>
              )}
            </div>

            {/* Particles Effect for Selected Card */}
            {isSelected && isFlipped && <ParticleEffect />}
          </div>
        </div>
      </motion.div>
    </motion.div>
  );
}

// Particle Effect Component
function ParticleEffect() {
  return (
    <div className="absolute inset-0 pointer-events-none overflow-hidden">
      {[...Array(15)].map((_, i) => (
        <motion.div
          key={i}
          className="absolute w-2 h-2 bg-yellow-400 rounded-full"
          initial={{
            x: '50%',
            y: '50%',
            scale: 0,
            opacity: 1,
          }}
          animate={{
            x: `${Math.random() * 100}%`,
            y: `${Math.random() * 100}%`,
            scale: [0, 1, 0],
            opacity: [1, 1, 0],
          }}
          transition={{
            duration: 1,
            delay: i * 0.05,
            ease: 'easeOut',
          }}
        />
      ))}
    </div>
  );
}
