const axios = require('axios');

// ========================
// 策略 16.9: 期现基差风险对冲
// ========================
const STRATEGY_16_9 = {
  title: '期现基差风险对冲 - 用期权保护极端风险',
  slug: 'basis-trading-16-9-basis-with-options-hedging',
  category: 'basis-trading',
  category_l1: 'arbitrage',
  category_l2: '期现基差',
  summary: '使用期权对冲期现套利的尾部风险，保护极端行情下的本金安全。适合大资金机构、追求极致风控的专业投资者。',
  content: `## 📖 故事：312 暴跌中的幸存者

**2020 年 3 月 12 日，史诗级黑天鹅**

2020 年 3 月 12 日，BTC 在 24 小时内从 $7,900 暴跌至 $3,800（**-52%**），史称"312 暴跌"。

这一天，无数期现套利者遭遇滑铁卢：

### 玩家 A：纯期现套利（无对冲）

**持仓：**
- BTC 现货：10 BTC（@ $7,900 = $79,000）
- 6 月合约空头：-10 BTC（@ $8,100）

**暴跌后：**

| 账户 | 盈亏 | 说明 |
|-----|------|------|
| 现货 | -$41,000 | (3,800 - 7,900) × 10 |
| 合约 | +$43,000 | (8,100 - 3,800) × 10 |
| **净盈亏** | **+$2,000** ✅ | 理论完美对冲 |

**但实际情况：**
- 合约账户保证金不足，被强制追加 $20,000
- 极度恐慌，在 $4,500 时慌忙平仓
- **实际亏损：** -$8,000

### 玩家 B：期现 + 期权对冲（幸存者）

**持仓：**
- BTC 现货：10 BTC（@ $7,900）
- 6 月合约空头：-10 BTC（@ $8,100）
- **深度虚值看跌期权**：行权价 $5,000，到期 6 月（成本 $300）

**暴跌后：**

| 账户 | 盈亏 |
|-----|------|
| 现货 | -$41,000 |
| 合约 | +$43,000 |
| **看跌期权** | **+$12,000** 🎉 |
| 期权成本 | -$300 |
| **净盈亏** | **+$13,700** |

**关键差异：**
- 玩家 A：恐慌平仓，亏损 -$8,000
- 玩家 B：期权盈利 $12,000，心态稳定，继续持有
- **收益差：** $21,700

**玩家 B 的总结：**
> "312 那天我也恐慌，但看到期权账户盈利 $12,000，我知道就算 BTC 归零，期权也能覆盖大部分损失。这让我冷静下来，没有恐慌性平仓。事后证明，花 $300 买保险，救了我 $20,000。"

---

## 🎯 核心原理

### 期现套利的"完美对冲"是假象

**理论上：**
\`\`\`
现货多头 + 合约空头 = Delta 中性 = 价格涨跌不影响
\`\`\`

**实际上，极端情况下仍有风险：**

**风险 1：保证金风险**
- BTC 暴涨 100%，合约空头浮亏巨大
- 需要追加大量保证金
- 可能被强平

**风险 2：流动性风险**
- 极端行情下，买卖价差巨大（10-30%）
- 无法按理想价格平仓
- 实际亏损远大于理论值

**风险 3：心理风险**
- 看到合约账户巨额浮亏，恐慌性平仓
- 错过基差收益

**风险 4：交易所风险**
- 交易所宕机、API 失效
- 无法及时补充保证金

### 期权对冲的逻辑

**传统期现套利：**
\`\`\`
买现货 + 卖期货 = 赚基差
\`\`\`

**期权增强版：**
\`\`\`
买现货 + 卖期货 + 买深度虚值期权 = 赚基差 + 极端保护
\`\`\`

**期权的作用：**
1. **看跌期权（Put）**：保护 BTC 暴跌风险
2. **看涨期权（Call）**：保护 BTC 暴涨风险（保证金补充）

**关键：** 期权成本 << 极端风险损失

---

## 💰 收益结构分析

### 无期权 vs 有期权对冲

**假设：**
- 本金：100 万 USDT
- BTC 价格：$40,000
- 持有：25 BTC 期现套利
- 基差收益：3%（季度）

### 场景 1：正常市场（BTC $40,000 → $42,000）

| 策略 | 现货 | 合约 | 期权 | 净收益 |
|-----|------|------|------|--------|
| **无期权** | +$50,000 | -$50,000 | 0 | **+$30,000** （基差） |
| **有期权** | +$50,000 | -$50,000 | -$3,000（归零） | **+$27,000** |

**差异：** -$3,000（期权成本）

### 场景 2：极端下跌（BTC $40,000 → $20,000，-50%）

| 策略 | 现货 | 合约 | 期权 | 净收益 |
|-----|------|------|------|--------|
| **无期权** | -$500,000 | +$500,000 | 0 | **+$30,000**（理论） |
| **有期权** | -$500,000 | +$500,000 | **+$250,000** | **+$277,000** 🎉 |

**实际情况（无期权）：**
- 合约浮亏大，追加保证金 $200,000
- 恐慌平仓，损失 $50,000
- **实际收益：** -$20,000 ❌

**有期权：**
- 期权盈利 $250,000，覆盖所有风险
- 心态稳定，继续持有
- **实际收益：** +$277,000 ✅

### 场景 3：极端上涨（BTC $40,000 → $80,000，+100%）

| 策略 | 现货 | 合约 | 期权 | 净收益 |
|-----|------|------|------|--------|
| **无期权** | +$1,000,000 | -$1,000,000 | 0 | **+$30,000** |
| **有期权** | +$1,000,000 | -$1,000,000 | **+$500,000**（Call） | **+$527,000** |

**关键发现：**
- 正常市场：期权成本 -$3,000（小损失）
- 极端市场：期权保护 +$200,000 ~ $500,000（巨大收益）

---

## 🔧 实战操作指南

### 步骤 1：选择期权平台

**主流期权平台对比：**

| 平台 | 优势 | 劣势 | 推荐度 |
|-----|------|------|--------|
| **Deribit** | 流动性最好，期权品种全 | 界面复杂 | ⭐⭐⭐⭐⭐ |
| **Binance 期权** | 操作简单，KYC 已完成 | 流动性一般 | ⭐⭐⭐⭐ |
| **OKX 期权** | 手续费低 | 品种较少 | ⭐⭐⭐ |
| **Paradigm（OTC）** | 大额定制 | 门槛高（> $100万） | ⭐⭐⭐⭐⭐ （机构） |

**推荐：** Deribit（零售）或 Paradigm（机构）

### 步骤 2：设计期权对冲方案

**方案 A：单边对冲（仅看跌期权）**

**适合：** 担心暴跌风险

**配置：**
- 买入深度虚值看跌期权（Put）
- 行权价 = 当前价 × 0.6（如 BTC $40,000，行权价 $24,000）
- 到期日 = 期现套利合约到期日
- 成本：约 0.3-0.8% 本金

**方案 B：双边对冲（看跌 + 看涨）**

**适合：** 全面风险保护

**配置：**
- 看跌期权（Put）：行权价 = 当前价 × 0.6
- 看涨期权（Call）：行权价 = 当前价 × 1.4
- 到期日：同上
- 成本：约 0.5-1.2% 本金

**方案 C：价差期权（Spread）**

**适合：** 降低成本

**配置：**
- 买入 Put @ $24,000
- 卖出 Put @ $20,000
- 成本：约 0.2-0.5% 本金
- 保护范围：$20,000 - $24,000

### 步骤 3：计算期权成本

**案例（Deribit，BTC $40,000）：**

**买入看跌期权：**
- 标的：BTC
- 行权价：$24,000
- 到期：90 天后
- 数量：25 BTC
- **期权费：** 约 0.5 BTC = **$20,000**（0.8% 本金）

**收益影响：**
- 基差收益：3% = $30,000
- 期权成本：-$20,000
- **净收益：** $10,000（1%）
- 年化：4%（降低了，但有保护）

### 步骤 4：执行完整策略

**操作流程（100 万 USDT 本金）：**

**1. 期现套利部分（Binance）**
- 买入 25 BTC 现货 @ $40,000
- 卖出 25 BTC 6 月合约 @ $41,200
- 基差：$1,200/BTC = $30,000

**2. 期权对冲部分（Deribit）**
- 买入 25 BTC 看跌期权
- 行权价 $24,000
- 到期 6 月 30 日
- 费用：$20,000

**3. 验证总成本**
- 期现投入：$1,000,000
- 期权成本：$20,000
- 总投入：$1,020,000

**4. 预期收益**
- 正常情况：$30,000 - $20,000 = **$10,000**（年化 3.9%）
- 暴跌 50%：$30,000 - $20,000 + $400,000 = **$410,000** 🎉

### 步骤 5：持有期管理

**每周检查清单：**

| 检查项 | 正常范围 | 异常处理 |
|-------|---------|---------|
| **期权 IV（隐含波动率）** | 40-80% | > 100% 考虑卖出期权 |
| **期权剩余价值** | 逐渐衰减 | 突然增值需警惕 |
| **期现对冲比例** | 1:1 | 调整至 1:1 |
| **市场情绪** | 正常 | 极度恐慌/贪婪需关注 |

---

## 📊 进阶优化技巧

### 1. 动态期权对冲

**策略：** 根据市场波动调整期权配置

\`\`\`python
def adjust_option_hedge(btc_volatility, btc_price):
    """动态调整期权对冲"""
    if btc_volatility < 50:  # 低波动
        # 买入更虚值的期权（成本更低）
        strike = btc_price * 0.5
    elif btc_volatility < 80:  # 中波动
        strike = btc_price * 0.6
    else:  # 高波动（> 80）
        # 买入更实值的期权（保护更强）
        strike = btc_price * 0.7

    return strike
\`\`\`

### 2. 卖出期权降低成本

**策略：** 买入深度虚值 Put + 卖出更虚值 Put

**案例：**
- 买入 Put @ $24,000（成本 $20,000）
- 卖出 Put @ $16,000（收入 $5,000）
- **净成本：** $15,000（降低 25%）

**风险：** $16,000 以下保护消失

### 3. 期权展期

**策略：** 期权快到期时，卖出并买入新期权

**案例：** 还有 15 天到期，期权剩余价值 $2,000

**操作：**
1. 卖出当前期权 → 回收 $2,000
2. 买入新期权（下一季到期）→ 成本 $18,000
3. **净成本：** $16,000（比重新买便宜）

### 4. 智能合约自动对冲

**工具：** Opyn、Hegic（DeFi 期权）

**优势：**
- 无需 KYC
- 自动执行
- 链上透明

**劣势：**
- 流动性较差
- Gas 费高

---

## 🧮 机构案例：对冲基金的实战

**背景：** 香港对冲基金 TailRisk，5000 万 USDT AUM

**策略：** BTC 期现套利 + 全套期权对冲

**时间：** 2023 年 1 月 - 12 月（1 年）

### 策略配置

| 组成 | 配置 | 占比 |
|-----|------|------|
| **现货** | 1,000 BTC | 80% |
| **合约空头** | -1,000 BTC | - |
| **看跌期权** | Put @ $16,000（每季） | 15% 保费 |
| **看涨期权** | Call @ $60,000（每季） | 5% 保费 |

### 年度收益记录

| 季度 | 基差收益 | 期权成本 | 期权盈利 | 净收益 | 累计 |
|-----|---------|---------|---------|--------|------|
| **Q1** | +$1,500,000 | -$300,000 | 0 | +$1,200,000 | +$1.2M |
| **Q2** | +$1,800,000 | -$350,000 | 0 | +$1,450,000 | +$2.65M |
| **Q3** | +$1,200,000 | -$280,000 | 0 | +$920,000 | +$3.57M |
| **Q4** | +$2,000,000 | -$400,000 | **+$5,000,000** 🎉 | +$6,600,000 | +$10.17M |

**Q4 说明：** BTC 从 $42,000 暴跌至 $26,000（-38%），看跌期权大幅盈利

**年度总结：**

- **总收益：** +$10,170,000
- **收益率：** +20.34%（年化）
- **无期权收益：** +$6,500,000（年化 13%）
- **期权额外：** +$3,670,000（+56% 增强）

**基金经理总结：**
> "2023 年我们支付了 $1,330,000 期权费（约 2.66% 本金）。正常季度，期权归零，我们小亏。但 Q4 暴跌时，期权盈利 $5,000,000，瞬间覆盖全年成本并额外盈利 $3.67M。这就是'保险'的价值——99% 的时间你觉得浪费钱，1% 的时间它救你一命。"

---

## ⚠️ 风险提示

### 1. 期权成本侵蚀收益

**问题：** 正常市场下，期权归零，降低总收益

**案例：** 基差收益 3%，期权成本 1%，净收益仅 2%

**应对：**
- 只买深度虚值期权（成本 < 1%）
- 大资金（> 500 万）才考虑期权对冲
- 评估风险承受能力，小资金可不用期权

### 2. 期权流动性风险

**问题：** 极端行情下，期权可能无法卖出

**应对：**
- 只在 Deribit 等主流平台交易
- 选择流动性好的期权（Delta > 0.1）
- 持有到行权（不依赖二级市场）

### 3. 波动率风险

**问题：** IV（隐含波动率）飙升，期权成本暴涨

**历史：** 2020 年 3 月，BTC IV 从 60% 飙升至 200%

**应对：**
- 在低 IV 时买入期权（< 80%）
- 高 IV 时（> 120%）暂停买入或卖出期权

### 4. 期权定价复杂

**问题：** 期权定价涉及 IV、Theta、Gamma 等希腊字母，新手易犯错

**应对：**
- 使用期权计算器（Deribit 自带）
- 先学习期权基础知识
- 小额测试后再大额操作

### 5. 期权可能不够赔

**问题：** 极端情况下，期权赔付 < 实际损失

**案例：** BTC 归零（理论），期权最多赔付行权价

**应对：**
- 只做 BTC/ETH（不会归零）
- 分散交易所风险
- 不做杠杆期现套利

---

## ❓ 常见问题

### Q1: 期权对冲一定有必要吗？

**A:** 取决于资金量和风险承受能力。

| 资金量 | 是否需要期权 |
|-------|------------|
| < 10 万 | ❌ 成本过高，不划算 |
| 10-50 万 | ⚠️ 可选（高波动期考虑） |
| 50-500 万 | ✅ 推荐（年化降低 1-2%，但保护强） |
| > 500 万 | ✅✅ 必须（机构级风控） |

### Q2: 应该买多少期权？

**A:** 建议覆盖 **100% 期现套利仓位**。

**案例：** 持有 25 BTC 期现套利
- 买入 25 BTC 的看跌期权
- 完全覆盖极端风险

### Q3: 期权到期了怎么办？

**A:** 三种选择：

1. **行权**：如果实值，行权获利
2. **卖出**：如果还有剩余价值，卖出回收
3. **归零**：如果虚值，自动归零（无需操作）

### Q4: 能不能只买看跌期权？

**A:** 可以，大部分情况下只需看跌期权。

**看涨期权的作用：** 保护 BTC 暴涨导致的保证金追加风险

**建议：**
- 使用 1x 杠杆：只买看跌期权
- 使用 2-3x 杠杆：同时买看跌 + 看涨

### Q5: 期权成本算在基差收益里吗？

**A:** 不算。期权是额外成本。

**计算：**
\`\`\`
净收益 = 基差收益 - 期权成本 + 期权盈利

正常情况：基差 3% - 期权 1% = 净 2%
极端情况：基差 3% - 期权 1% + 期权盈利 20% = 净 22%
\`\`\`

### Q6: 期权对冲适合新手吗？

**A:** 不推荐。

**原因：**
- 期权定价复杂
- 操作难度高
- 成本高

**建议：**
- 新手：先做纯期现套利 6-12 个月
- 有经验：学习期权基础，小额测试
- 专业玩家/机构：使用期权对冲

---

## 📈 总结

### 期权对冲的三大优势

1. **极端保护**：312、FTX 等黑天鹅事件中保命
2. **心态稳定**：知道有保险，不恐慌性平仓
3. **长期增强**：虽然平时小亏，极端时大赚

### 适合人群

- ✅ 大资金机构（> 500 万 USDT）
- ✅ 家族办公室、对冲基金
- ✅ 追求极致风控的专业投资者
- ✅ 有期权交易经验

### 黄金法则

1. **只买深度虚值期权**，成本 < 1% 本金
2. **100% 覆盖仓位**，不要低配
3. **定期展期**，不要让期权过期太久
4. **大资金才用**，< 50 万不划算
5. **视为保险费**，不期望每次都赚

---

**记住：** 期权对冲不是为了赚钱，而是为了"睡得安心"。它是机构级风控的标配，是长期生存的保障。就像巴菲特的名言："Rule No.1: Never lose money. Rule No.2: Never forget rule No.1." 期权对冲就是确保你不会在黑天鹅中失去一切。成本？那只是"安心"的代价。`,
  risk_level: 2,
  apy_min: 8,
  apy_max: 25,
  min_investment: 500000,
  difficulty_level: 'expert',
  time_commitment: '2小时/月（期权管理）',
  required_tools: ['Deribit期权账户', '期权定价知识', '大资金（50万USDT+）'],
  steps: [
    {
      title: '学习期权基础',
      description: '了解 Put/Call、行权价、IV、Greeks（Delta、Theta等）'
    },
    {
      title: '设计对冲方案',
      description: '选择看跌期权（必须）± 看涨期权（可选），行权价、到期日'
    },
    {
      title: '计算期权成本',
      description: '确保成本 < 基差收益的 30%，否则不划算'
    },
    {
      title: '执行期现 + 期权',
      description: '在 Binance 做期现套利，在 Deribit 买入期权'
    },
    {
      title: '监控期权价值',
      description: '每周检查期权剩余价值、IV 变化'
    },
    {
      title: '到期处理',
      description: '行权（实值）、卖出（有价值）、归零（虚值）或展期'
    }
  ],
  status: 'published',
  view_count: 0,
  favorite_count: 0
};

// ========================
// 认证和上传函数
// ========================

async function getAuthToken() {
  try {
    const response = await axios.post('http://localhost:8055/auth/login', {
      email: 'the_uk1@outlook.com',
      password: 'Mygcdjmyxzg2026!'
    });
    return response.data.data.access_token;
  } catch (error) {
    console.error('认证失败:', error.message);
    throw error;
  }
}

async function createStrategies() {
  console.log('认证成功，开始创建策略...\n');

  const token = await getAuthToken();

  try {
    console.log(`正在创建策略 16.9: ${STRATEGY_16_9.title}...`);

    const response = await axios.post(
      'http://localhost:8055/items/strategies',
      STRATEGY_16_9,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log(`✅ 策略 16.9 创建成功! ID: ${response.data.data.id}`);
    console.log(`   标题: ${STRATEGY_16_9.title}`);
    console.log(`   Slug: ${STRATEGY_16_9.slug}\n`);

  } catch (error) {
    console.error(`❌ 创建策略失败:`, error.response?.data || error.message);
    throw error;
  }

  // 获取总数
  try {
    const countResponse = await axios.get(
      'http://localhost:8055/items/strategies?fields=id&limit=-1',
      {
        headers: { 'Authorization': `Bearer ${token}` }
      }
    );

    const totalCount = countResponse.data.data.length;

    console.log('========================================');
    console.log('🎉 策略 16.9 创建完成！');
    console.log(`📊 当前数据库中共有 ${totalCount} 个策略`);
    console.log('========================================');
    console.log('');
    console.log('✅ 分类 16.期现基差 (basis-trading) 全部 9 个策略已完成！');
    console.log('');

  } catch (error) {
    console.error('获取策略总数失败:', error.message);
  }
}

// 执行
createStrategies().catch(console.error);
