const axios = require('axios');

const DIRECTUS_URL = 'http://localhost:8055';

/**
 * 建议生产环境使用环境变量
 * const DIRECTUS_EMAIL = process.env.DIRECTUS_EMAIL
 * const DIRECTUS_PASSWORD = process.env.DIRECTUS_PASSWORD
 */

const GUIDE_CONFIG = {
  // ===== 基本信息 =====
  title: '加密货币风险管理与税务合规完全指南',
  slug: 'crypto-risk-compliance-complete-guide',
  summary:
    '全方位风控与合规攻略：投资组合风险监控、止损熔断机制、黑天鹅对冲、税务申报（美国/欧盟/中国）、成本基础计算、洗售规则、审计追踪、KYC/AML合规、跨境申报（FBAR/FATCA）、工具对比（Koinly/CoinTracker）。',

  // 使用 slug 作为分类标识（与前端 directus.ts 中的定义保持一致）
  category: 'risk-compliance',

  // 站内一级/二级分类
  category_l1: 'tools',
  category_l2: '风险与合规',

  // ===== 元数据 =====
  difficulty_level: 4,           // 1-5
  risk_level: 5,                 // 税务处罚/监管打击/资产冻结/刑事风险
  apy_min: 0,
  apy_max: 0,

  // 资金/时间/技术门槛
  threshold_capital: '0–2,000 USD（税务软件年费+专业咨询费）',
  threshold_capital_min: 0,
  time_commitment: '税季集中20–50小时，日常每周1–2小时记录',
  time_commitment_minutes: 120,
  threshold_tech_level: 'intermediate',

  // ===== 可读性强的 Markdown 正文 =====
  content: `> **适用人群**：希望**合法合规**参与加密投资、**正确申报税务**、**管理投资风险**、**避免监管处罚**的所有加密货币投资者
> **阅读时间**：≈ 35–50 分钟
> **关键词**：Risk Management / Tax Reporting / IRS / FBAR / FATCA / Capital Gains / Cost Basis / Wash Sale / KYC/AML / Portfolio Monitoring / Stop Loss / Audit Trail / Koinly / CoinTracker

---

## 🧭 TL;DR
- **风险管理核心**：**仓位控制**（单币种≤20%）、**止损纪律**（-15%熔断）、**分散投资**（10+资产）、**定期再平衡**（月度/季度）、**黑天鹅对冲**（看跌期权/稳定币储备）。
- **税务铁律**：**每笔交易都是应税事件**（币币交易/NFT购买/DeFi收益）、**成本基础追踪**（FIFO/LIFO/Specific ID）、**及时申报**（逃税=刑事犯罪）、**保留证据**（7年交易记录）。
- **合规要点**：**KYC实名认证**（主流交易所必需）、**大额申报**（美国>$10K需FBAR）、**跨境申报**（FATCA/CRS）、**反洗钱**（避免混币器/暗网关联）。
- **工具推荐**：**税务软件**（Koinly/CoinTracker，$50–$300/年）、**投资组合监控**（DeBank/Zapper，免费）、**审计追踪**（Excel+区块链浏览器）。

---

## 🗂 目录
1. [风险管理基础：为什么需要风控](#风险管理基础为什么需要风控)
2. [投资组合风险监控](#投资组合风险监控)
3. [仓位管理与再平衡](#仓位管理与再平衡)
4. [止损与熔断机制](#止损与熔断机制)
5. [黑天鹅事件对冲](#黑天鹅事件对冲)
6. [交易所与协议风险](#交易所与协议风险)
7. [税务基础：加密货币如何纳税](#税务基础加密货币如何纳税)
8. [美国税务详解（IRS规则）](#美国税务详解irs规则)
9. [欧盟税务概览](#欧盟税务概览)
10. [中国大陆税务与合规](#中国大陆税务与合规)
11. [成本基础计算方法](#成本基础计算方法)
12. [税务软件使用指南](#税务软件使用指南)
13. [KYC/AML合规要求](#kycaml合规要求)
14. [跨境申报：FBAR与FATCA](#跨境申报fbar与fatca)
15. [审计应对与证据保留](#审计应对与证据保留)
16. [FAQ](#faq)
17. [一页执行清单](#一页执行清单)

---

## 🛡️ 风险管理基础：为什么需要风控

### 加密市场的独特风险

❌ **极端波动**：
- 单日涨跌±30%–50%常见
- 2022年LUNA归零（从$119跌至$0.00001）
- 2023年FTX崩盘（$32B资产蒸发）

❌ **24/7无休**：
- 周末/节假日照常交易
- 无涨跌停板限制
- 睡觉时可能错过暴跌

❌ **监管不确定**：
- 各国政策频繁变化
- 交易所突然关闭/限制提现
- 资产可能被冻结/没收

❌ **技术风险**：
- 智能合约漏洞（Hack/Exploit）
- 私钥丢失（永久损失）
- 钓鱼攻击/诈骗

---

### 风险管理的核心原则

✅ **资本保护优先**：
- 第一目标：不亏钱
- 第二目标：记住第一目标
- 收益是结果，风控是过程

✅ **概率思维**：
- 没有100%确定的交易
- 用期望值指导决策：期望值 = 胜率 × 盈利 - 败率 × 亏损
- 接受小概率黑天鹅（但要对冲）

✅ **纪律执行**：
- 计划交易，交易计划
- 止损不犹豫（机器执行优于人工）
- 定期复盘（每月/季度）

---

## 📊 投资组合风险监控

### 核心指标

#### 1. 投资组合价值（Portfolio Value）
```
总价值 = Σ(持仓数量 × 当前价格)

示例：
- BTC: 1 × $30,000 = $30,000
- ETH: 10 × $2,000 = $20,000
- USDT: 10,000 × $1 = $10,000
总计：$60,000
```

**监控工具**：
- **DeBank**（https://debank.com）：自动聚合钱包+DeFi仓位
- **Zapper**（https://zapper.xyz）：实时净资产追踪
- **Delta/Blockfolio**：移动端App

---

#### 2. 最大回撤（Max Drawdown）
```
最大回撤 = (峰值 - 谷值) / 峰值

示例：
- 投资组合峰值：$100,000（2021年11月）
- 谷值：$30,000（2022年11月）
- 最大回撤：70%

解读：
- <20%：优秀（防守型策略）
- 20%–50%：可接受（平衡型）
- >50%：高风险（激进型，需调整）
```

---

#### 3. 夏普比率（Sharpe Ratio）
```
夏普比率 = (年化收益率 - 无风险利率) / 收益率标准差

示例：
- 年化收益：60%
- 无风险利率：5%（美债）
- 收益率标准差：40%
- 夏普比率 = (60% - 5%) / 40% = 1.375

解读：
- >2：优秀（高收益低波动）
- 1–2：良好
- <1：风险调整后收益不佳
```

---

#### 4. 波动率（Volatility）
```
波动率 = 收益率标准差 × √252（年化）

日收益率示例：
Day 1: +5%, Day 2: -3%, Day 3: +2%...

计算标准差 → 年化

解读：
- BTC年化波动率：80%–120%
- 股票市场（S&P 500）：15%–20%
- 稳定币策略：5%–10%
```

---

### 监控频率

**日常监控**（每日5分钟）：
- 投资组合总价值
- 单币种涨跌幅（异常波动>±20%）
- 重大新闻扫描（Twitter/Telegram）

**深度复盘**（每周30分钟）：
- 更新交易记录（Excel/Google Sheets）
- 检查止损触发情况
- 评估本周收益与预期偏差

**全面审查**（每月2–3小时）：
- 计算月度收益率与最大回撤
- 再平衡投资组合（见下节）
- 更新投资策略（市场环境变化）

---

## ⚖️ 仓位管理与再平衡

### 仓位分配策略

#### 核心-卫星策略（Core-Satellite）
```
核心仓位（60%–80%）：
- BTC: 40%
- ETH: 30%
- 稳定币: 10%

卫星仓位（20%–40%）：
- 优质山寨币（Top 20）: 15%
- DeFi协议代币: 10%
- NFT/新赛道: 5%
- 现金（应急）: 10%
\`\`\```

**优点**：
- 核心稳定（抗跌）
- 卫星博弈（高收益潜力）
- 灵活调整

---

#### 风险平价策略（Risk Parity）
```
按波动率分配权重（而非市值）

示例：
- BTC波动率：80% → 权重：20%
- ETH波动率：100% → 权重：16%
- 稳定币波动率：5% → 权重：64%

目标：各资产对总波动率贡献相同
```

**适用**：追求低波动稳定收益

---

### 再平衡规则

#### 定期再平衡（Time-based）
```
每月/季度固定时间重新调整至目标配置

示例（目标配置：BTC 50%，ETH 30%，其他20%）：

当前实际：
- BTC涨至60%（超配）
- ETH跌至25%（低配）
- 其他15%

操作：
- 卖出10% BTC
- 买入5% ETH
- 买入5%其他
```

**优点**：纪律性强，自动"低买高卖"

---

#### 阈值再平衡（Threshold-based）
```
当偏离目标超过±5%（或10%）时触发

示例：
目标BTC: 50%
当前BTC: 56%（偏离+6%，触发）

操作：卖出6% BTC买入其他资产
```

**优点**：减少交易频率与手续费

---

### 税务优化的再平衡

**美国投资者注意**：
- 再平衡触发资本利得税
- 策略：
  1. 优先调整长期持有（>1年）资产（税率低）
  2. 利用亏损卖出抵消盈利（Tax Loss Harvesting）
  3. 在IRA/401k等免税账户内再平衡（如适用）

---

## 🚨 止损与熔断机制

### 止损策略

#### 1. 固定百分比止损
```
规则：单币种亏损达-15%立即卖出

示例：
- 买入ETH @ $2,000
- 止损价：$2,000 × (1 - 15%) = $1,700
- 当价格跌至$1,700，自动触发卖出订单
```

**优点**：简单明确
**缺点**：可能被"震出"（假跌破后反弹）

---

#### 2. 移动止损（Trailing Stop）
```
规则：止损价随最高价上移，但不下调

示例：
- 买入BTC @ $30,000，设置10%移动止损
- BTC涨至$35,000，止损价上移至$31,500（$35K × 90%）
- BTC继续涨至$40,000，止损价上移至$36,000
- BTC回调至$36,000，触发止损（锁定$6,000利润）
```

**优点**：保护利润，让利润奔跑
**缺点**：牛市中可能过早止盈

---

#### 3. 技术位止损
```
规则：跌破关键支撑位（MA/趋势线/前低）时止损

示例：
- ETH在200日均线（MA200）上方运行数月
- 当跌破MA200，触发止损
- 理由：技术面破位，趋势反转
\`\`\```

**优点**：结合技术分析，减少假突破
**缺点**：需要技术分析能力

---

### 账户级熔断机制

#### 单日亏损熔断

# 伪代码
if 今日亏损 > 总资产 × 5%:
    停止所有交易
    平仓高风险仓位
    通知用户人工介入
```

**示例**：
- 总资产：$100,000
- 单日亏损阈值：$5,000
- 当日亏损达$5,000时，系统自动停机

---

#### 周期亏损熔断
```
周亏损 > 10% → 暂停1周
月亏损 > 20% → 暂停1个月
季度亏损 > 30% → 全面复盘策略
```

**目的**：避免情绪化追回损失（越亏越赌）

---

## 🌪️ 黑天鹅事件对冲

### 常见黑天鹅

- **2020年3月**：COVID崩盘，BTC单日-50%
- **2022年5月**：Terra/LUNA归零
- **2022年11月**：FTX破产，连锁反应
- **2023年3月**：美国银行业危机（SVB/Signature）

---

### 对冲策略

#### 1. 稳定币储备（现金缓冲）
```
保持20%–30%资产为稳定币（USDT/USDC/DAI）

用途：
- 崩盘时抄底（别人恐慌时贪婪）
- 应急提现（不被迫卖在低点）
- 心理安全垫（降低焦虑）

---

#### 2. 看跌期权（Put Options）
```
购买BTC/ETH看跌期权

示例（Deribit）：
- 当前BTC价格：$30,000
- 购买1个月后行权价$25,000的看跌期权
- 成本：$500（期权费）

如果1个月后BTC跌至$20,000：
- 行权卖出@$25,000（而非市场价$20,000）
- 保护收益：$5,000 - $500 = $4,500

如果BTC涨至$35,000：
- 期权作废，损失$500
- 但BTC持仓盈利$5,000，净盈利$4,500
\`\`\```

**成本**：期权费约本金1%–3%/月
**适用**：大仓位持有者，长期看涨但防范短期暴跌

---

#### 3. 跨资产分散

不要All-in加密货币

建议配置：
- 加密货币：40%–60%
- 股票/ETF：20%–30%
- 贵金属/大宗：10%–20%
- 现金/债券：10%–20%

目的：加密崩盘时，其他资产支撑
```

---

#### 4. 反脆弱策略（Antifragile）
```
小仓位配置"崩盘受益资产"

示例：
- 购买VIX看涨期权（恐慌指数）
- 持有黄金/比特币（避险资产）
- 做空高杠杆山寨币（崩盘时暴涨）

占比：5%–10%资产
逻辑：小成本对冲极端风险


---

## 🏦 交易所与协议风险

### 中心化交易所风险

#### 历史事件
- **Mt.Gox（2014）**：被盗85万BTC，破产
- **QuadrigaCX（2019）**：创始人去世，私钥丢失，$190M消失
- **FTX（2022）**：挪用客户资金，$8B窟窿

---

#### 风险管理

✅ **分散存储**：
```
单个交易所存储 ≤ 20%资产

示例（$100K资产）：
- Binance: $20K
- Coinbase: $20K
- Kraken: $15K
- 冷钱包: $35K
- DeFi: $10K
```

✅ **选择有保险的交易所**：
- Coinbase：FDIC保险（仅法币）+ 私人保险
- Gemini：FDIC + Cyber Insurance
- Binance：SAFU基金（10亿美元）

✅ **定期提现**：
- 短期交易外，资产转至冷钱包
- 不把交易所当"银行"

---

### DeFi协议风险

#### 风险类型
- **智能合约漏洞**：Hack/Exploit（历史损失>$10B）
- **经济模型崩溃**：Terra/LUNA、Iron Finance
- **管理员密钥攻击**：Rug Pull
- **预言机操纵**：闪电贷攻击

---

#### 风险评估清单

✅ **审计状态**：
- 是否经过Certik/PeckShield/Trail of Bits审计？
- 审计报告是否公开？
- 是否有Bug Bounty计划？

✅ **TVL与历史**：
- TVL > $100M（规模越大，风险相对越低）
- 运行时间 > 6个月（经受市场考验）
- 是否经历过黑客攻击？如何应对？

✅ **团队与治理**：
- 团队公开透明（KYC）？
- 智能合约是否去中心化（Timelock/多签）？
- 社区治理活跃度？

✅ **代码开源**：
- GitHub代码公开？
- 是否Fork自成熟协议（Uniswap/Aave）？

---

### 保险协议

**Nexus Mutual / InsurAce**：
- 购买智能合约保险
- 覆盖Hack/Exploit损失
- 成本：年化2%–5%本金

**示例**：
```
在Aave存入$50K USDC
购买InsurAce保险，年费$1,500（3%）
如果Aave被Hack，获得$50K赔付
```

---

## 💰 税务基础：加密货币如何纳税

### 全球税务原则

**大多数国家将加密货币视为**：
- **资产/财产**（Property）：如美国、英国、澳大利亚
- **商品**（Commodity）：如德国、瑞士
- **证券**（Security）：部分代币可能被定性

**税务影响**：
- ✅ 每次交易（币币/币法）触发资本利得税
- ✅ 挖矿/Staking/空投视为收入，需缴所得税
- ✅ 持有不卖不交税（仅纸面盈亏）

---

### 应税事件（Taxable Events）

#### ✅ 需要纳税
1. **卖出加密货币换法币**（如BTC → USD）
2. **币币交易**（如BTC → ETH）
3. **使用加密货币购物**（如用BTC买咖啡）
4. **获得空投/分叉币**（收到时按市价计收入）
5. **挖矿/Staking奖励**（收到时按市价计收入）
6. **DeFi收益**（Yield Farming/利息）
7. **NFT买卖**（每次交易都是应税）

---

#### ❌ 不需要纳税
1. **购买加密货币**（用法币买入）
2. **钱包间转账**（自己转给自己）
3. **单纯持有**（HODL）
4. **赠予**（部分国家有赠与税，但赠予行为本身不触发资本利得）

---

### 税务计算示例

**场景1：简单买卖**
```
1月1日：用$10,000买入1 BTC（成本基础：$10,000）
6月1日：卖出1 BTC，获得$15,000

资本利得 = $15,000 - $10,000 = $5,000
税率（美国短期资本利得）：22%–37%（按收入档）
应缴税：$5,000 × 30% = $1,500
```

---

**场景2：币币交易**
\`\`\```
1月1日：用$10,000买入1 BTC
3月1日：BTC涨至$15,000，用1 BTC换30 ETH（ETH当时$500/枚）

交易1（BTC → ETH）：
- 视为卖出BTC（获得$15,000价值）
- 资本利得：$15,000 - $10,000 = $5,000
- 应缴税：$5,000 × 30% = $1,500

交易2（持有ETH）：
- ETH的成本基础：$15,000（30枚，每枚$500）

6月1日：ETH涨至$2,000/枚，卖出30 ETH，获得$60,000

- 资本利得：$60,000 - $15,000 = $45,000
- 应缴税：$45,000 × 30% = $13,500

总税款：$1,500 + $13,500 = $15,000
\`\`\```

**关键**：每次币币交易都需要计算当时的美元价值！

---

## 🇺🇸 美国税务详解（IRS规则）

### IRS立场

**2014 Notice**：IRS明确加密货币为"财产"（Property）
**2019 Revenue Ruling**：硬分叉/空投需缴税
**2021 Infrastructure Bill**：加强Broker报告要求

---

### 资本利得税率

#### 短期资本利得（持有≤1年）
按**普通收入税率**征税：

| 收入档（2024单身） | 税率 |
|------------------|-----|
| $0 – $11,600 | 10% |
| $11,600 – $47,150 | 12% |
| $47,150 – $100,525 | 22% |
| $100,525 – $191,950 | 24% |
| $191,950 – $243,725 | 32% |
| $243,725 – $609,350 | 35% |
| $609,350+ | 37% |

---

#### 长期资本利得（持有>1年）
优惠税率：

| 收入档（2024单身） | 税率 |
|------------------|-----|
| $0 – $47,025 | 0% |
| $47,025 – $518,900 | 15% |
| $518,900+ | 20% |

**策略**：尽量持有>1年再卖（减税15%–20%）

---

### Wash Sale Rule（洗售规则）

**传统证券规则**：
- 卖出亏损证券后30天内不能买回同一证券
- 否则亏损不能抵税

**加密货币（2023年前）**：
- ✅ 不适用Wash Sale规则
- 可以卖出BTC确认亏损，立即买回

**⚠️ 2024年后可能变化**：
- 拟议法案将加密货币纳入Wash Sale
- 关注IRS最新通知

---

### Tax Loss Harvesting（税损收割）

**策略**：
```
12月31日前（税年结束）：
- 卖出所有亏损仓位，确认资本损失
- 用损失抵消当年资本利得
- 如有净损失，可抵扣$3,000普通收入
- 剩余损失结转至下一年

示例：
- 当年资本利得：$50,000（卖出BTC盈利）
- 卖出亏损的山寨币，确认损失$30,000
- 净利得：$50,000 - $30,000 = $20,000
- 应缴税：$20,000 × 15% = $3,000（节省$4,500税款）
```

---

### 申报表格

**Form 8949**：详细列出每笔交易
- 日期、数量、成本基础、售价、利得/损失

**Schedule D**：汇总资本利得/损失

**Form 1040**：主申报表（第7行填写净资本利得）

**截止日期**：每年4月15日（可申请延期至10月15日）

---

## 🇪🇺 欧盟税务概览

### 各国差异（选取）

#### 德国
- **持有>1年免税**！（个人投资者）
- 持有≤1年按个人所得税（14%–45%）
- Staking奖励持有>10年免税

**策略**：长期持有是王道

---

#### 英国
- 资本利得税：10%–20%（根据收入档）
- 年度免税额：£12,300（2024）
- 超过免税额部分缴税

---

#### 法国
- 统一税率：30%（PFU）
- 或选择累进税率（最高45%）

---

#### 葡萄牙
- **个人投资免税**（非专业交易者）
- 企业/专业交易者需缴税

---

### 欧盟MiCA监管（2024年生效）

**Markets in Crypto-Assets Regulation**：
- 统一加密资产监管框架
- 要求交易所/项目方合规披露
- 稳定币发行受限（储备金要求）

**对投资者影响**：
- 更强消费者保护
- KYC/AML更严格
- 税务透明度提高

---

## 🇨🇳 中国大陆税务与合规

### 政策现状（2024）

**禁令**：
- ❌ 禁止加密货币交易（2021年9月）
- ❌ 禁止挖矿（高能耗）
- ❌ 金融机构不得提供服务

**灰色地带**：
- 持有加密货币不违法（但交易违法）
- 境外交易所账户（VPN访问）
- OTC场外交易（风险高）

---

### 税务处理

**个人所得税法**：
- 加密货币增值收益理论上属于"财产转让所得"
- 税率：20%

**实际情况**：
- 缺乏明确征收机制
- 交易所不在境内，难以追踪
- 银行卡大额入账可能被询问来源

---

### 合规建议

⚠️ **高风险行为（避免）**：
- 使用境内银行卡直接买卖加密货币
- 参与非法集资/传销币
- 大额资金无法解释来源

✅ **相对安全做法**：
- 使用境外合规交易所（Coinbase/Kraken）
- 资金留在境外账户
- 若需回国，小额分批，保留交易记录
- 咨询专业律师（避免触犯刑法）

---

### 香港/新加坡替代方案

**香港**：
- 2024年开放零售投资者交易（持牌交易所）
- 资本利得免税（个人投资）
- 需香港税务居民身份

**新加坡**：
- 个人资本利得免税（非交易性质）
- 专业交易者需缴所得税
- 持牌交易所完善（Bybit/Crypto.com）

---

## 📐 成本基础计算方法

### FIFO（先进先出）

**规则**：最早买入的币最先卖出

**示例**：
\`\`\```
交易1：1月买入1 BTC @ $10,000
交易2：3月买入1 BTC @ $15,000
交易3：6月卖出1 BTC @ $20,000

成本基础：$10,000（1月买入的）
资本利得：$20,000 - $10,000 = $10,000
```

**优点**：简单，IRS默认方法
**缺点**：早期低价买入的币先卖，可能产生高额税

---

### LIFO（后进先出）

**规则**：最近买入的币最先卖出

**示例**（同上）：
```
成本基础：$15,000（3月买入的）
资本利得：$20,000 - $15,000 = $5,000
```

**优点**：减少短期利得（若最近买入）
**缺点**：美国IRS不允许（仅FIFO或Specific ID）

---

### Specific Identification（特定识别）

**规则**：每次卖出时指定卖出哪批买入的币

**示例**：
\`\`\```
持有：
- 批次A：1 BTC @ $10,000
- 批次B：1 BTC @ $15,000
- 批次C：1 BTC @ $18,000

6月卖出1 BTC，选择卖出批次C（$18,000成本）
资本利得：$20,000 - $18,000 = $2,000（最小化税款）
```

**优点**：税务最优化
**缺点**：需详细记录每批买入，交易所需支持

---

### HIFO（最高成本先出）

**规则**：成本最高的币先卖出

**效果**：最小化资本利得税（同Specific ID优化）

**工具**：Koinly/CoinTracker自动计算

---

### 加权平均成本（Weighted Average）

**规则**：所有买入取平均成本

**示例**：
\`\`\```
买入1：1 BTC @ $10,000
买入2：1 BTC @ $15,000
平均成本：($10,000 + $15,000) / 2 = $12,500

卖出1 BTC @ $20,000
资本利得：$20,000 - $12,500 = $7,500
```

**适用**：部分国家允许（如加拿大）

---

## 🛠️ 税务软件使用指南

### 主流工具对比

| 软件 | 价格 | 支持交易所 | 特色功能 | 推荐度 |
|------|------|-----------|---------|--------|
| **Koinly** | $49–$279/年 | 700+ | DeFi支持强 | ★★★★★ |
| **CoinTracker** | $59–$999/年 | 300+ | Portfolio追踪 | ★★★★☆ |
| **TokenTax** | $65–$3,999/年 | 500+ | 企业级审计 | ★★★★☆ |
| **CoinLedger** | $49–$299/年 | 400+ | 简单易用 | ★★★☆☆ |
| **Accointing** | $79–$299/年 | 300+ | 实时追踪 | ★★★☆☆ |
| **ZenLedger** | $49–$999/年 | 400+ | TurboTax集成 | ★★★☆☆ |

---

### Koinly使用教程

#### 步骤1：导入交易数据
\`\`\```
方式A：API连接（推荐）
- 登录Koinly → Add Wallet
- 选择交易所（Binance/Coinbase等）
- 输入API Key（只读权限）
- 自动同步所有历史交易

方式B：CSV文件上传
- 从交易所导出交易记录CSV
- 上传至Koinly
- 手动映射字段（日期/数量/价格）

方式C：钱包地址同步
- 添加以太坊/BTC钱包地址
- 自动抓取链上交易
```

---

#### 步骤2：审查与编辑
```
Koinly自动分类交易：
- Buy（买入）
- Sell（卖出）
- Trade（币币交易）
- Deposit（充值）
- Withdrawal（提现）
- Reward（挖矿/Staking）

手动修正错误：
- 标记钱包间转账（不应税）
- 添加遗漏交易（场外OTC）
- 修正错误价格（历史价格API失效）
```

---

#### 步骤3：生成报税表
```
选择国家：美国/英国/德国等
选择税年：2023
选择成本基础方法：FIFO/Specific ID

生成报告：
- Form 8949（详细交易列表）
- Schedule D（汇总利得损失）
- IRS预填表格

导出PDF/CSV → 提交给会计师或自行申报
\`\`\```

---

#### 步骤4：优化税务
\`\`\```
Koinly "Tax Loss Harvesting"功能：
- 自动识别亏损仓位
- 建议卖出时机（12月31日前）
- 预估节省税款

成本基础优化：
- 切换FIFO/Specific ID对比
- 选择税款最小方案
\`\`\```

---

### 常见问题处理

**问题1：DeFi交易无法识别**
```
解决：
- 手动添加DeFi钱包地址
- 使用Etherscan CSV导出
- 标记Swap/Liquidity提供/收益
\`\`\```

**问题2：交易所API限制**
\`\`\```
解决：
- 分批同步（按季度）
- 使用CSV备份
- 升级软件付费版（更高API额度）
\`\`\```

**问题3：缺失历史价格**
\`\`\```
解决：
- Koinly自动从CoinGecko/CoinMarketCap获取
- 手动输入缺失日期价格
- 使用保守估值（避免高估利得）
\`\`\```

---

## 🆔 KYC/AML合规要求

### KYC（Know Your Customer）

**定义**：交易所/平台验证用户身份的流程

**要求材料**：
- 政府颁发的身份证/护照
- 地址证明（水电费账单/银行对账单）
- 自拍照片（手持身份证）
- 高级KYC：收入证明/资金来源声明

---

### AML（Anti-Money Laundering）

**监管要求**：
- 交易所需监控可疑交易
- 大额交易（>$10K）需报告
- 资金来源不明账户冻结

**投资者影响**：
- 提现延迟（需额外审查）
- 账户冻结（关联黑名单地址）
- 强制KYC升级

---

### 高风险行为（触发AML审查）

❌ **混币器使用**：
- Tornado Cash（已被制裁）
- ChipMixer/Wasabi Wallet

❌ **暗网市场关联**：
- Silk Road等非法市场地址

❌ **被盗资金**：
- 接收来自Hack地址的币

❌ **异常交易模式**：
- 快速大额充值+提现
- 分散小额转账（Structuring）

---

### 合规建议

✅ **主动KYC**：
- 使用有监管牌照的交易所
- 完成高级认证（提高限额）
- 避免代持/借用他人账户

✅ **保留交易证据**：
- 每笔转账备注用途
- 大额资金来源说明（如出售股票/工资储蓄）
- 链上交易截图（Etherscan/区块浏览器）

✅ **使用"干净"地址**：
- 新钱包从合规交易所提现
- 避免与混币器/赌博网站交互
- 定期检查地址标签（Chainalysis）

---

## 🌍 跨境申报：FBAR与FATCA

### FBAR（Report of Foreign Bank and Financial Accounts）

**适用**：美国公民/绿卡持有者

**要求**：
```
如果全年任何时刻，所有境外金融账户总和 > $10,000：
- 需在4月15日前申报FinCEN Form 114
- 包括：境外银行账户、证券账户、加密交易所账户

示例：
- Binance账户：$5,000
- 欧洲银行账户：$6,000
- 总计：$11,000 → 需要申报

处罚：
- 未申报：最高$10,000罚款/年
- 故意违反：$100,000或账户余额50%（取高者），最高可刑事起诉
```

---

### FATCA（Foreign Account Tax Compliance Act）

**适用**：美国公民/绿卡持有者

**要求**：
\`\`\```
如果境外金融资产 > 阈值：
- 单身：$50,000（年末）或$75,000（年内任何时刻）
- 已婚：$100,000或$150,000

需在报税时附上Form 8938

加密货币视为"指定境外金融资产"

处罚：
- 未申报：$10,000罚款
- 持续违反：额外$50,000/年
\`\`\```

---

### CRS（Common Reporting Standard）

**适用**：全球100+国家自动交换金融信息

**机制**：
\`\`\```
A国税务居民在B国开户：
B国银行/交易所自动报告给A国税局

包括：
- 账户余额
- 利息/股息/资本利得
- 加密货币交易（部分国家）

影响：
- 无法通过境外账户逃税
- 跨国税务透明化
\`\`\```

---

### 数字游民（Digital Nomad）税务

**策略**：
\`\`\```
不在任何国家停留超过183天：
- 避免成为税务居民
- 选择低税/免税国（迪拜/葡萄牙/巴拿马）

注意：
- 美国公民仍需全球报税（无论居住地）
- 部分国家按国籍征税（厄立特里亚）
- "税务无住所"可能违法（需合法税务居民身份）
\`\`\```

---

## 📁 审计应对与证据保留

### IRS审计流程

**触发因素**：
- 报告收入与第三方数据不匹配
- 大额资本利得/损失
- 连续多年亏损
- 随机抽查（<1%概率）

---

**审计类型**：
1. **通信审计**（Correspondence Audit）：邮件/在线提交补充文件
2. **办公室审计**（Office Audit）：前往IRS办公室面谈
3. **实地审计**（Field Audit）：IRS到家中/公司检查

---

### 证据保留清单

✅ **交易记录（7年）**：
- 每笔买入/卖出的日期、数量、价格
- 交易所对账单（月度/年度）
- API导出CSV文件

✅ **成本基础证明**：
- 最初购买的银行转账记录
- 交易所购买确认邮件
- 钱包地址链上交易

✅ **收入证明**：
- Staking奖励截图（日期+金额）
- 空投代币接收记录
- DeFi收益Dashboard截图

✅ **转账说明**：
- 钱包间转账备注（"从Coinbase转至硬件钱包"）
- OTC交易合同（场外交易）
- 赠予/继承文件

---

### 审计应对技巧

✅ **合作态度**：
- 及时回复IRS通知（30天内）
- 提供清晰整理的文件
- 不隐瞒、不对抗

✅ **专业协助**：
- 聘请CPA/税务律师（Enrolled Agent）
- 律师特权保护沟通内容
- 费用：$200–$500/小时

✅ **修正申报**：
- 若发现错误，主动提交Amended Return（Form 1040-X）
- 补缴税款+利息（通常3%–5%年化）
- 避免刑事处罚

---

### 常见错误与补救

**错误1：遗漏小额交易**
```
补救：
- 使用税务软件重新计算
- 提交修正申报
- 补缴税款+利息（通常罚款较轻）
\`\`\```

**错误2：错误成本基础**
\`\`\```
补救：
- 提供交易所记录证明实际成本
- 重新计算正确利得
- 申请退税（若多缴）
\`\`\```

**错误3：未申报空投/分叉币**
\`\`\```
补救：
- 确定收到日期与市价
- 补充Schedule 1（其他收入）
- 提交修正申报
\`\`\```

---

## ❓FAQ

**Q1：我只投资了几百美元，还需要报税吗？**
> **是的**！无论金额大小，有应税事件就需要申报。IRS明确要求在Form 1040首页回答"是否交易加密货币"。
> - 小额可能无需缴税（低于标准扣除额）
> - 但必须如实申报交易
> - 未申报可能面临审计风险

**Q2：交易所在境外，IRS怎么知道我的交易？**
> **他们会知道**：
> - FATCA/CRS信息交换
> - 交易所法币出入金（银行报告）
> - 链上地址关联分析（Chainalysis）
> - 举报奖励（IRS Whistleblower Program）
>
> **结论**：诚实申报是唯一安全路径

**Q3：币币交易太多，成千上万笔怎么办？**
> **使用税务软件**：
> - Koinly/CoinTracker自动导入
> - API连接无需手动录入
> - 自动计算成本基础
> - 年费$50–$300，远低于会计师费用

**Q4：可以用加密货币损失抵扣工资收入吗？**
> **部分可以**（美国）：
> - 资本损失优先抵消资本利得
> - 净损失可抵扣$3,000普通收入/年
> - 剩余损失无限期结转至下一年
>
> 示例：
> - 资本损失$50,000，资本利得$0
> - 当年抵扣$3,000工资收入
> - 剩余$47,000结转至明年

**Q5：持有超过1年卖出，如何证明持有时间？**
> **证据**：
> - 购买时的交易所确认邮件（日期戳）
> - 钱包地址链上交易（时间戳不可篡改）
> - 税务软件自动追踪（Koinly显示每批买入日期）
> - 使用Specific ID指定卖出批次

---

## ✅ 一页执行清单

### 风险管理
- [ ] 设置投资组合监控（DeBank/Zapper）
- [ ] 制定仓位分配策略（核心60%+卫星40%）
- [ ] 设置止损规则（单币种-15%，账户-5%/日）
- [ ] 建立稳定币储备（20%–30%总资产）
- [ ] 分散交易所风险（单所≤20%资产）
- [ ] 购买DeFi保险（高额仓位，年化3%）

### 税务准备
- [ ] 选择税务软件（Koinly/CoinTracker）
- [ ] 连接所有交易所API（导入历史交易）
- [ ] 添加所有钱包地址（链上交易同步）
- [ ] 审查并修正交易分类（钱包转账/买卖）
- [ ] 选择成本基础方法（FIFO/Specific ID）
- [ ] 12月31日前执行Tax Loss Harvesting

### 记录保存
- [ ] 创建交易日志（Google Sheets/Excel）
- [ ] 每笔大额转账备注用途
- [ ] 保存交易所月度对账单
- [ ] 截图Staking/空投收益（日期+金额）
- [ ] 云端备份所有文件（Google Drive/Dropbox）
- [ ] 物理备份重要文件（U盘+纸质）

### 合规检查
- [ ] 完成交易所KYC（高级认证）
- [ ] 检查地址是否关联黑名单（Chainalysis）
- [ ] 计算境外账户总额（FBAR阈值$10K）
- [ ] 确认税务居民身份（避免双重征税）
- [ ] 咨询税务专业人士（首次或复杂情况）
- [ ] 设置报税日历提醒（美国4月15日）

### 年度流程
- [ ] **Q1**：整理上一年交易记录，生成税表
- [ ] **Q2**：提交报税（4月15日），支付税款
- [ ] **Q3**：季度投资组合复盘与再平衡
- [ ] **Q4**：执行Tax Loss Harvesting（12月31日前）

---

## 🎓 进阶学习资源

### 税务专业机构
- **AICPA**（美国注册会计师协会）：CPA推荐
- **Gordon Law Group**：专注加密税务律所
- **Crypto Tax Girl**：YouTube税务教育

### 官方资源
- **IRS Cryptocurrency Guide**：https://www.irs.gov/businesses/small-businesses-self-employed/virtual-currencies
- **UK HMRC Cryptoassets Manual**：https://www.gov.uk/hmrc-internal-manuals/cryptoassets-manual
- **Australia ATO**：https://www.ato.gov.au/cryptocurrency

### 工具与社区
- **r/CryptoTax**（Reddit）：税务讨论社区
- **Koinly Blog**：税务指南文章
- **CoinTracker Academy**：视频教程
- **TokenTax Webinar**：免费税务讲座

### 法律咨询
- **FinCEN**（美国金融犯罪执法局）：AML/KYC规定
- **SEC**（证券交易委员会）：证券型代币监管
- **本地税务律师**：复杂情况专业咨询

---

## 🔚 结语

风险管理与税务合规是加密投资的**"保险与地基"**：
- ✅ **风险管理**保护你的本金（活下来才有未来）
- ✅ **税务合规**保护你的自由（逃税=刑事犯罪）

**记住三个原则**：
1. **风险第一，收益第二**：100%亏损无法用200%盈利弥补
2. **诚实申报，合法节税**：Tax Loss Harvesting vs Tax Evasion（逃税）
3. **专业协助，持续学习**：税法每年变化，及时更新知识

**最后提醒**：
- 本指南仅供教育参考，**不构成法律/税务建议**
- 复杂情况请咨询**CPA/税务律师**
- 不同国家法规差异大，以**当地法律为准**

愿你在加密世界中，既能把握机会，又能守住底线！🛡️📊
`,

  // ===== 与前端适配的步骤结构（5步） =====
  steps: [
    { step_number: 1, title: '风险监控体系搭建', description: '设置投资组合监控工具（DeBank/Zapper），制定仓位分配策略（核心60%+卫星40%），设置止损规则（单币-15%/账户-5%/日），建立稳定币储备20%–30%。', estimated_time: '3–5 小时' },
    { step_number: 2, title: '税务软件配置', description: '选择并注册税务软件（Koinly/CoinTracker），通过API连接所有交易所导入历史交易，添加钱包地址同步链上数据，审查交易分类准确性。', estimated_time: '4–8 小时' },
    { step_number: 3, title: '交易记录整理', description: '创建交易日志（Excel/Sheets），记录每笔交易日期/数量/价格/成本基础，保存交易所月度对账单，截图Staking/空投收益，云端与物理双备份。', estimated_time: '2–4 小时' },
    { step_number: 4, title: '合规检查与申报', description: '完成交易所高级KYC认证，检查FBAR/FATCA申报要求（美国>$10K），计算应纳税额并选择成本基础方法（FIFO/Specific ID），12月31日前执行Tax Loss Harvesting。', estimated_time: '5–10 小时' },
    { step_number: 5, title: '专业咨询与提交', description: '复杂情况咨询CPA/税务律师（$200–$500/小时），使用软件生成Form 8949/Schedule D，4月15日前提交报税（美国），保留所有证据7年备审计。', estimated_time: '10–20 小时（税季）' },
  ],
};

// ===== 自动执行：与既有模板一致 =====
async function getAuthToken() {
  const response = await axios.post(`${DIRECTUS_URL}/auth/login`, {
    email: 'the_uk1@outlook.com',
    password: 'Mygcdjmyxzg2026!',
  });
  return response.data.data.access_token;
}

async function addGuide() {
  try {
    const token = await getAuthToken();

    const strategy = {
      ...GUIDE_CONFIG,
      status: 'published',
      is_featured: true,
      view_count: 0,
      bookmark_count: 0,
      published_at: new Date().toISOString(),
    };

    const response = await axios.post(
      `${DIRECTUS_URL}/items/strategies`,
      strategy,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      },
    );

    console.log('\n✅ 加密货币风险管理与税务合规完全指南创建成功!');
    console.log(`   ID: ${response.data.data.id}`);
    console.log(`   Slug: ${response.data.data.slug}`);
    console.log(`   访问: http://localhost:3000/strategies/${response.data.data.slug}\n`);
  } catch (error) {
    console.error('\n❌ 创建失败:', error.response?.data || error.message);
  }
}

addGuide();
