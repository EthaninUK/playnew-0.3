# 修复 Directus 图片上传问题完全指南

## 🔍 问题诊断结果

### ✅ 正常的部分
1. **字段配置正确**: `cover_image` 字段类型和界面配置都正确
2. **文件上传功能正常**: 可以通过 API 成功上传文件
3. **文件关联正常**: 可以成功将文件设置为策略封面

### ❌ 问题所在
1. **文件访问权限**: 文件上传后返回 403 错误，无法公开访问
2. **原因**: directus_files 表缺少公共读取权限

---

## 🛠️ 解决方案

### 方案 1：通过 Directus 后台修复权限（推荐）

#### 步骤 1：登录 Directus 后台

访问：http://localhost:8055

#### 步骤 2：进入权限设置

1. 点击左上角的 **设置图标**（齿轮）
2. 选择 **"Access Control"** 或 **"角色与权限"**
3. 找到你的角色（通常是 Administrator）

#### 步骤 3：配置文件权限

1. 在角色权限列表中找到 **"Directus Files"** 或 **"directus_files"**
2. 确保以下权限已启用：
   - ✅ **Create** (创建)
   - ✅ **Read** (读取)
   - ✅ **Update** (更新)
   - ✅ **Delete** (删除)

3. 点击每个权限，确保：
   - **"Use Custom Permissions"** 关闭（或设为 "No Limitations"）
   - **Fields** 设为 "All Fields" 或选择 `*`

#### 步骤 4：配置公共访问权限

1. 在角色列表中找到 **"Public"** 角色
2. 为 **"directus_files"** 添加 **Read** 权限
3. 确保允许访问所有字段

#### 步骤 5：保存并测试

1. 保存所有更改
2. 刷新页面
3. 尝试上传图片

---

### 方案 2：通过 Docker 命令修复（高级）

如果无法通过后台修复，可以直接修改数据库：

```bash
# 进入 PostgreSQL 容器
docker-compose exec postgres psql -U directus -d directus_play

# 查看当前权限
SELECT * FROM directus_permissions WHERE collection = 'directus_files';

# 添加公共读取权限
INSERT INTO directus_permissions (role, collection, action, permissions, fields)
VALUES (NULL, 'directus_files', 'read', '{}', '*');

# 退出
\q
```

---

### 方案 3：修改 Directus 环境变量（最简单）

编辑 `docker-compose.yml`，在 Directus 服务的环境变量中添加：

```yaml
directus:
  environment:
    # ... 其他环境变量 ...
    PUBLIC_URL: 'http://localhost:8055'
    ASSETS_CONTENT_SECURITY_POLICY: ''
    # 允许所有来源访问文件
    STORAGE_LOCATIONS: 'local'
    STORAGE_LOCAL_DRIVER: 'local'
    STORAGE_LOCAL_ROOT: './uploads'
```

然后重启 Directus：

```bash
docker-compose restart directus
```

---

## 🧪 测试步骤

### 步骤 1：测试文件上传

```bash
node test-file-upload.js
```

应该看到：
- ✅ 上传成功
- ✅ 可以访问文件（状态码 200）
- ✅ 成功设置为封面

### 步骤 2：手动测试

1. 打开 Directus 后台：http://localhost:8055
2. 点击左侧 **"Files"** (文件)
3. 点击右上角 **"+ Upload Files"**
4. 选择一张图片上传
5. 上传成功后，点击图片查看详情
6. 复制文件 ID
7. 在浏览器访问：`http://localhost:8055/assets/{文件ID}`
8. 应该能看到图片

### 步骤 3：测试设置封面

1. 进入 **Strategies** 集合
2. 点击任意策略进入编辑
3. 找到 **Cover Image** 字段
4. 点击字段，应该出现文件选择器
5. 可以看到之前上传的文件
6. 选择一个文件
7. 保存

---

## 📱 在前端显示图片

### 更新前端代码

确保前端代码正确处理图片 URL：

```typescript
// 在策略列表页面
{strategy.cover_image && (
  <img
    src={`http://localhost:8055/assets/${strategy.cover_image}`}
    alt={strategy.title}
  />
)}

// 或使用 Next.js Image 组件
import Image from 'next/image';

{strategy.cover_image && (
  <Image
    src={`http://localhost:8055/assets/${strategy.cover_image}`}
    alt={strategy.title}
    width={1200}
    height={630}
  />
)}
```

### 更新 Directus 查询

确保查询策略时包含封面图片：

```typescript
// frontend/lib/directus.ts
const strategies = await directus.request(
  readItems('strategies', {
    filter: { status: { _eq: 'published' } },
    fields: [
      '*',
      'cover_image.*'  // 👈 添加这行获取完整的文件信息
    ],
    limit: 50
  })
);
```

---

## 🔧 常见问题

### Q1: 上传后显示 403 错误

**原因**: 文件访问权限未配置

**解决**:
1. 检查 Public 角色是否有 directus_files 的 read 权限
2. 或按照"方案 2"直接添加数据库权限

### Q2: 上传按钮点击没反应

**原因**: 可能是浏览器控制台有 JavaScript 错误

**解决**:
1. 按 F12 打开开发者工具
2. 查看 Console 标签的错误信息
3. 查看 Network 标签的网络请求

### Q3: 文件上传成功但看不到

**原因**: 查询时没有包含文件字段

**解决**:
```typescript
fields: ['*', 'cover_image.*']
```

### Q4: 图片显示损坏

**原因**: URL 不正确或文件已删除

**解决**:
1. 检查 URL 格式：`http://localhost:8055/assets/{fileId}`
2. 在 Directus 后台检查文件是否存在

### Q5: 上传大文件失败

**原因**: 文件大小超过限制

**解决**:
在 `docker-compose.yml` 中添加：
```yaml
directus:
  environment:
    FILES_MAX_SIZE: '100MB'  # 或更大
```

---

## 🎯 快速检查清单

使用此清单确保所有配置正确：

### Directus 后台检查
- [ ] 登录 Directus 后台成功
- [ ] 可以访问 Files 文件库
- [ ] 可以上传文件
- [ ] 上传的文件可以在列表中看到
- [ ] 点击文件可以预览
- [ ] Strategies 表的 cover_image 字段类型为 "File"

### 权限检查
- [ ] 你的角色有 directus_files 的完整权限 (CRUD)
- [ ] Public 角色有 directus_files 的 Read 权限
- [ ] 在编辑策略时可以看到 Cover Image 字段
- [ ] 点击 Cover Image 字段能看到文件选择器

### 前端检查
- [ ] 查询策略时包含了 `cover_image.*`
- [ ] 图片 URL 格式正确
- [ ] 没有 CORS 错误

### 测试脚本
- [ ] 运行 `node test-file-upload.js` 成功
- [ ] 文件访问返回 200 状态码
- [ ] 可以设置为策略封面

---

## 💡 推荐工作流程

### 开发环境（本地）

1. 在 Directus 后台上传图片到文件库
2. 记录文件 ID
3. 在创建/编辑策略时选择图片

### 生产环境

1. 使用 CDN 托管图片（如 Cloudflare, AWS S3）
2. 或配置 Directus 使用云存储
3. 配置 `docker-compose.yml`：

```yaml
directus:
  environment:
    STORAGE_LOCATIONS: 's3'
    STORAGE_S3_DRIVER: 's3'
    STORAGE_S3_KEY: 'your-access-key'
    STORAGE_S3_SECRET: 'your-secret-key'
    STORAGE_S3_BUCKET: 'your-bucket'
    STORAGE_S3_REGION: 'us-east-1'
```

---

## 📞 需要更多帮助？

如果问题仍未解决，请提供以下信息：

1. **浏览器控制台截图**（F12 → Console）
2. **Network 标签的失败请求**
3. **Directus 日志**：
   ```bash
   docker-compose logs directus --tail=100 | grep -i error
   ```
4. **具体的错误信息**

---

## 🚀 下一步

一旦图片上传正常工作：

1. 为现有的 5 个指南添加封面图片
2. 创建图片素材库（Logo、图标、封面模板）
3. 更新前端组件以显示图片
4. 优化图片加载（懒加载、响应式图片）
5. 考虑添加图片压缩和优化

---

最后更新: 2025-10-27
