const axios = require('axios');

const DIRECTUS_URL = 'http://localhost:8055';

/**
 * 建议生产环境使用环境变量
 * const DIRECTUS_EMAIL = process.env.DIRECTUS_EMAIL
 * const DIRECTUS_PASSWORD = process.env.DIRECTUS_PASSWORD
 */

const GUIDE_CONFIG = {
  // ===== 基本信息 =====
  title: 'NFT 金融（NFT Finance / NFTFi）完全指南',
  slug: 'nft-finance-complete-guide',
  summary:
    '深度解析NFT金融化生态：抵押借贷（点对点/点对池）、碎片化（Fractionalization）、租赁协议、衍生品与期权、流动性挖矿、风险评估与清算机制、实战案例与合规要点。',

  // 使用 slug 作为分类标识（与前端 directus.ts 中的定义保持一致）
  category: 'nft-fi',

  // 站内一级/二级分类
  category_l1: 'nft',
  category_l2: 'NFT 金融',

  // ===== 元数据 =====
  difficulty_level: 4,           // 1-5
  risk_level: 4,                 // 清算风险/智能合约风险/流动性风险/市场波动
  apy_min: 5,
  apy_max: 120,

  // 资金/时间/技术门槛
  threshold_capital: '500–50,000 USD（根据NFT价值与策略弹性配置）',
  threshold_capital_min: 500,
  time_commitment: '每周 3–8 小时（市场监控/仓位管理/风控调整）',
  time_commitment_minutes: 330,
  threshold_tech_level: 'intermediate',

  // ===== 可读性强的 Markdown 正文 =====
  content: `> **适用人群**：希望**释放NFT流动性**、**获取收益**或**对冲风险**的NFT持有者、DeFi参与者、机构投资者
> **阅读时间**：≈ 20–28 分钟
> **关键词**：NFT Lending / Fractionalization / Rental / NFT Derivatives / Floor Price / Liquidation / Peer-to-Peer / Peer-to-Pool / Valuation / APY / LTV / Blue Chip

---

## 🧭 TL;DR
- **核心场景**：*NFT抵押借贷*（释放流动性）、*碎片化*（降低门槛/分散所有权）、*租赁*（使用权交易）、*衍生品*（价格对冲/杠杆）、*流动性挖矿*（做市收益）。
- **关键指标**：**LTV（贷款价值比）**、**地板价波动**、**清算阈值**、**年化利率/借贷成本**、**流动性深度**、**智能合约审计状态**。
- **风控纪律**：**蓝筹优先**、**保守LTV**（≤50%）、**实时监控清算线**、**小额试验**、**协议分散**、**应急退出预案**。

---

## 🗂 目录
1. [NFT金融概览：为何需要NFTFi](#nft金融概览为何需要nftfi)
2. [抵押借贷：点对点 vs 点对池](#抵押借贷点对点-vs-点对池)
3. [碎片化协议：ERC-20化NFT](#碎片化协议erc-20化nft)
4. [NFT租赁：使用权与收益权分离](#nft租赁使用权与收益权分离)
5. [衍生品与期权：价格对冲与杠杆](#衍生品与期权价格对冲与杠杆)
6. [估值与风险评估](#估值与风险评估)
7. [清算机制与应对策略](#清算机制与应对策略)
8. [流动性挖矿与做市收益](#流动性挖矿与做市收益)
9. [合规与税务考量](#合规与税务考量)
10. [主流协议对比](#主流协议对比)
11. [实战案例分析](#实战案例分析)
12. [FAQ](#faq)
13. [一页执行清单](#一页执行清单)

---

## 💡 NFT金融概览：为何需要NFTFi

### 痛点
- **流动性锁定**：高价值NFT变现困难，持有者无法短期套现又不想出售
- **入场门槛高**：蓝筹NFT价格昂贵（几万至数百万美元），普通投资者无法参与
- **价格波动**：缺乏对冲工具，持有者面临地板价暴跌风险
- **收益单一**：持有NFT仅靠升值/版税，缺少被动收入渠道

### NFTFi解决方案
- **抵押借贷**：抵押NFT借出稳定币/ETH，无需卖出资产
- **碎片化**：将一枚NFT分割为数千/数万份ERC-20代币，降低门槛
- **租赁市场**：出租NFT使用权（游戏道具/虚拟土地/会员权益）
- **衍生品**：看跌期权/地板价保险/永续合约对冲下跌
- **流动性挖矿**：提供NFT/代币做市，赚取手续费+激励

---

## 🏦 抵押借贷：点对点 vs 点对池

### 点对点（Peer-to-Peer / P2P）
**代表协议**：NFTfi、Arcade、Zharta

**运作机制**：
1. 借款人发起贷款请求（抵押NFT + 期望借款额/利率/期限）
2. 贷款人浏览市场，选择感兴趣的NFT提供报价
3. 双方匹配后锁定合约，借款人获得资金，NFT托管于智能合约
4. 到期还款+利息后NFT解锁；逾期则贷款人获得NFT所有权

**优点**：
- 灵活定价，稀有/非蓝筹NFT也可能获得融资
- 借款人可比较多个报价选择最优条款
- 无需依赖预言机，减少价格操纵风险

**缺点**：
- 流动性差，匹配耗时（可能数小时至数天）
- 利率离散，缺乏标准化定价
- 贷款人承担NFT估值风险

**适用场景**：稀有/非地板款NFT、长期借贷需求、愿意等待最优报价

---

### 点对池（Peer-to-Pool / P2Pool）
**代表协议**：BendDAO、JPEG'd、Drops、ParaSpace

**运作机制**：
1. 协议建立流动性池（由贷款人存入ETH/稳定币）
2. 借款人抵押蓝筹NFT，**即时**获得贷款（基于预言机地板价 × LTV）
3. 支付浮动/固定利率，持续抵押期间可随时还款
4. 价格跌破清算线则触发拍卖/清算机制

**优点**：
- **即时借贷**，无需等待匹配
- 标准化条款，透明定价
- 高流动性（针对蓝筹NFT）

**缺点**：
- 仅支持白名单蓝筹系列（BAYC/Azuki/Pudgy等）
- 依赖预言机（Chainlink/Reservoir），存在操纵风险
- 清算机制激进，地板价闪跌可能瞬间触发

**适用场景**：蓝筹NFT、短期流动性需求、追求便捷性

---

### 核心参数对比

| 参数 | P2P典型值 | P2Pool典型值 |
|------|----------|-------------|
| **LTV** | 30%–70%（协商） | 30%–50%（协议固定） |
| **利率** | 10%–80% APR | 5%–30% APR（浮动） |
| **期限** | 7–90天 | 无固定期限（持续抵押） |
| **清算** | 逾期后直接转让 | 健康因子<1触发拍卖 |
| **支持NFT** | 任意 | 仅白名单蓝筹 |

---

## 🧩 碎片化协议：ERC-20化NFT

### 原理
将单枚NFT锁入智能合约，发行对应的可互换代币（ERC-20），持有者可交易碎片份额。

### 主流协议
- **Fractional.art**（Tessera前身）：允许NFT持有者定义碎片总量、底价、治理权
- **NFTX**：将同系列NFT打包成指数基金（vToken），可在Uniswap交易
- **Unicly**：社区治理的碎片化协议，支持NFT组合打包

### 应用场景
1. **降低门槛**：价值100 ETH的NFT碎片化为100万份，每份0.0001 ETH
2. **价格发现**：二级市场碎片价格×总供应量 = NFT隐含估值
3. **流动性释放**：原NFT持有者可出售部分碎片保留部分权益
4. **投资组合**：将多枚NFT打包为指数基金（如蓝筹NFT ETF）

### 风险
- **赎回困难**：需持有>50%–90%碎片才可能触发赎回（buyout）
- **流动性分裂**：碎片市场与原NFT市场价格偏离
- **治理攻击**：大户控制碎片投票权操纵底价

---

## 🎮 NFT租赁：使用权与收益权分离

### 协议标准
- **ERC-4907**：增加"user"角色，可设置租赁到期时间
- **Double Protocol**、**reNFT**、**IQ Protocol**

### 应用领域
1. **GameFi**：租借稀有角色/武器/土地参与Play-to-Earn
2. **元宇宙**：租赁虚拟地块举办活动/开店
3. **会员权益**：租用社区通行证短期访问（活动门票/健身房）
4. **艺术展示**：画廊租借数字艺术品展览

### 定价机制
- **固定租金**：每日/每周固定价格
- **收益分成**：租户Play-to-Earn收益按比例分配
- **押金+租金**：防止租户违约/损坏（游戏账号封禁）

### 风险管理
- 智能合约确保**到期自动归还**
- 租户仅获得**使用权**，无法转让/出售
- 租赁期间原所有者保留**治理权/空投权**（协议不同规则各异）

---

## 📈 衍生品与期权：价格对冲与杠杆

### 地板价看跌期权
**协议**：Hook Protocol、NFTPerp

**机制**：
- 持有者购买看跌期权（Put Option），锁定地板价下限
- 若到期时地板价<行权价，持有者可按行权价卖出NFT（或获得差价补偿）
- 成本：支付期权费（地板价的2%–8%）

**示例**：
持有BAYC（地板价50 ETH），购买45 ETH行权价的30天看跌期权（费用2.5 ETH）。若到期地板价跌至40 ETH，可行权获得5 ETH补偿；若维持50 ETH以上，损失2.5 ETH期权费但NFT保值。

---

### 永续合约与杠杆交易
**协议**：NFTPerp、vFloor

**机制**：
- 追踪NFT系列地板价指数（如BAYC Floor Index）
- 支持多空双向、最高5x–10x杠杆
- 使用资金费率（Funding Rate）平衡多空持仓

**用例**：
- **多头套利**：相信BAYC地板价将上涨，开多单杠杆博收益
- **空头对冲**：持有实物NFT同时开空单，锁定价格下跌风险

**风险**：
- 高杠杆爆仓风险
- 流动性不足导致滑点/价格偏离
- 预言机延迟/操纵

---

## 🔍 估值与风险评估

### NFT估值方法
1. **地板价法**：同系列最低挂单价（最保守）
2. **交易均价法**：近7/30日成交均价（更稳定）
3. **稀有度加权**：基于属性稀有度评分（Rarity Tools/Rarity Sniper）
4. **机器学习**：Upshot、Abacus等AI估值平台
5. **同类比较**：对标已成交类似属性NFT

### 风险矩阵

| 风险类型 | 具体表现 | 缓解措施 |
|---------|---------|---------|
| **市场风险** | 地板价暴跌30%–70% | 蓝筹优先、低LTV、止损线 |
| **清算风险** | 健康因子<1被拍卖 | 实时监控、提前补仓/还款 |
| **智能合约** | 漏洞/黑客攻击 | 选已审计协议、分散资金 |
| **流动性风险** | NFT/碎片无法及时变现 | 蓝筹系列、深度做市池 |
| **预言机风险** | 价格操纵/延迟 | 多源预言机、抗操纵算法 |
| **监管风险** | 政策打压/定性证券 | 合规披露、税务咨询 |

---

## ⚠️ 清算机制与应对策略

### P2Pool清算流程
1. **健康因子**（Health Factor）= 抵押NFT价值（预言机价格×清算阈值）/ 债务
2. 当HF < 1.0时触发清算
3. 清算人可以折扣价购买抵押NFT（如95%地板价）或触发荷兰拍卖
4. 清算收益优先偿还债务，剩余归还借款人；不足则借款人损失NFT

### 应对策略
- **保守LTV**：建议≤40%，留出50%+安全垫
- **实时监控**：使用DeBank/Zapper/协议Dashboard追踪健康因子
- **自动化工具**：设置Telegram/Discord告警（HF<1.3时通知）
- **应急资金**：预留ETH/稳定币随时补仓或部分还款提升HF
- **提前退出**：地板价趋势恶化时主动还款取回NFT

### 案例：BendDAO清算危机（2022.08）
- BAYC/MAYC地板价暴跌，大量贷款接近清算线
- 流动性池ETH耗尽，存款人无法提款
- 协议紧急调整参数（降低LTV、提高利率、延长拍卖时间）
- **教训**：即使蓝筹也需留足安全边际；协议流动性危机可能阻止正常操作

---

## 💰 流动性挖矿与做市收益

### NFT AMM做市
**协议**：Sudoswap、NFTX、Blur Bidding

**机制**：
- 提供NFT或ETH到流动性池
- 用户交易时支付手续费（0.5%–5%）分配给LP
- 部分协议提供额外代币激励（流动性挖矿）

**收益来源**：
- 交易手续费分成
- 协议代币奖励（APR 10%–200%）
- 价格波动套利（若池内NFT升值）

**风险**：
- **无常损失**：NFT价格单边上涨时，持有NFT优于做LP
- **滞销风险**：提供的NFT属性差/稀有度低，难以卖出
- **代币贬值**：协议代币激励价值下跌

---

### 借贷协议做市
**机制**：
- 存入ETH/稳定币到BendDAO/JPEG'd等借贷池
- 赚取借款人支付的利息（APY 3%–15%）
- 部分协议提供治理代币奖励

**风险**：
- **坏账风险**：清算失败导致协议亏损
- **提款延迟**：流动性危机时无法即时提款
- **协议风险**：智能合约漏洞/治理攻击

---

## 📜 合规与税务考量

### 监管态势
- **证券属性**：碎片化代币可能被定性为证券（SEC关注）
- **借贷牌照**：部分司法管辖区要求NFT借贷平台持牌
- **反洗钱（AML）**：大额NFT交易需KYC（平台合规压力增加）

### 税务处理（美国IRS为例）
- **抵押借贷**：借款本身非应税事件；利息支出不可抵扣（非企业用途）
- **碎片化**：可能触发视同销售（Disposition），需确认公允价值与成本基础
- **租赁收入**：按普通收入纳税
- **衍生品交易**：资本利得税（短期/长期）
- **清算损失**：可确认资本损失抵扣

**建议**：咨询税务专业人士，保留完整交易记录（地址/时间/金额/协议）

---

## 🏆 主流协议对比

| 协议 | 类型 | 特色 | 支持NFT | 审计 | TVL（参考） |
|------|------|------|---------|------|------------|
| **NFTfi** | P2P借贷 | 最老牌、支持任意NFT | 全部 | ✅ | ~$50M |
| **BendDAO** | P2Pool借贷 | 即时借贷、蓝筹专用 | 蓝筹白名单 | ✅ | ~$30M |
| **JPEG'd** | P2Pool借贷 | 超额抵押铸造稳定币 | 蓝筹白名单 | ✅ | ~$20M |
| **ParaSpace** | P2Pool借贷 | 支持多链、组合抵押 | 蓝筹+多链 | ✅ | ~$60M |
| **Arcade** | P2P借贷 | 支持捆绑抵押、机构级 | 全部 | ✅ | ~$15M |
| **NFTX** | 碎片化/AMM | NFT指数基金、Uniswap流动性 | 同系列批量 | ✅ | ~$10M |
| **Tessera** | 碎片化 | 治理主导、赎回机制 | 全部 | ✅ | 停止新建 |
| **reNFT** | 租赁 | ERC-4907、多链 | 支持标准 | ✅ | ~$2M |
| **Hook** | 衍生品 | 看跌期权、地板价保护 | 蓝筹 | ✅ | 早期 |

**注**：TVL数据波动大，仅供参考；使用前务必验证最新审计报告与社区口碑。

---

## 📚 实战案例分析

### 案例1：蓝筹NFT抵押套利
**背景**：持有1枚BAYC（地板价80 ETH），短期看涨但需流动性

**策略**：
1. 在BendDAO抵押BAYC，LTV 40%借出32 ETH（年利率8%）
2. 将32 ETH存入Lido质押（APR 4%）获得stETH
3. 使用stETH在Aave再借出稳定币参与DeFi挖矿（APR 12%）
4. 监控BAYC地板价，设置告警（HF<1.5时补仓）

**结果**：
- 借贷成本：-8% APR
- 质押收益：+4% APR
- DeFi挖矿：+12% APR
- 净APR：~8%（扣除Gas与风险）

**风险**：地板价暴跌触发清算；stETH脱锚；DeFi协议风险

---

### 案例2：碎片化NFT投资组合
**背景**：看好蓝筹NFT但资金有限（5 ETH）

**策略**：
1. 在NFTX购买vBAYC（BAYC碎片代币）1 ETH
2. 购买vPUNKS（CryptoPunks碎片）2 ETH
3. 购买vAZUKI（Azuki碎片）2 ETH
4. 提供流动性到Uniswap vBAYC/ETH池赚取手续费

**结果**：
- 获得三个蓝筹系列敞口，分散风险
- 碎片价格跟随地板价波动，流动性高于整枚NFT
- LP手续费APR 15%–30%（取决于交易量）

**风险**：碎片价格折价于实际地板价；无常损失；赎回困难

---

### 案例3：地板价保护策略
**背景**：持有5枚Azuki（地板价15 ETH/枚），担心市场下行

**策略**：
1. 在Hook Protocol购买5枚30天看跌期权（行权价13 ETH，费用0.6 ETH/枚）
2. 同时在Blur挂限价单15.5 ETH（若有买家直接成交）
3. 30天内若地板价跌至10 ETH，行权获得(13-10)×5=15 ETH补偿

**结果**：
- 总成本：3 ETH期权费
- 最大损失：15 ETH当前价值 - 13 ETH行权价 - 3 ETH费用 = -1 ETH/枚
- 保护下限明确，心理压力减轻

**风险**：地板价维持/上涨则期权费全损；协议流动性不足

---

## ❓FAQ

**Q1：NFT借贷会失去空投资格吗？**
> 取决于协议与项目方规则。P2P借贷中NFT托管于合约，空投可能发到合约地址（需手动分配）；P2Pool部分协议（如BendDAO）支持质押期间获得空投。**建议提前确认协议文档**。

**Q2：碎片化后如何赎回完整NFT？**
> 需持有治理规定的碎片比例（通常>50%），发起赎回投票/buyout，按底价支付剩余碎片持有者。**实际操作困难**，适合长期投资而非短期套利。

**Q3：P2P与P2Pool该选哪个?**
> - **P2P**：稀有/非蓝筹NFT、长期借贷、愿意等待报价、接受高利率
> - **P2Pool**：蓝筹NFT、短期流动性、追求便捷、接受清算风险

**Q4：NFT金融合法吗？**
> 大部分国家尚无明确法规，但**碎片化/借贷可能触发证券监管**。美国SEC已对部分NFT项目发出Wells Notice。建议关注监管动态，必要时咨询法律顾问。

**Q5：如何评估协议安全性？**
> 1. 查看审计报告（CertiK/PeckShield/Trail of Bits）
> 2. 检查TVL历史与社区口碑
> 3. 测试网小额试验
> 4. 关注漏洞赏金计划
> 5. 追踪Discord/Twitter官方公告

---

## ✅ 一页执行清单

### 借贷篇
- [ ] 确认协议类型（P2P/P2Pool）与支持NFT列表
- [ ] 查看审计报告与TVL数据，评估安全性
- [ ] 计算LTV、利率、清算阈值，确保HF>1.5安全边际
- [ ] 设置价格告警（Zapper/DeBank/协议Dashboard）
- [ ] 准备应急资金（≥10%抵押品价值）随时补仓
- [ ] 记录交易明细（时间/金额/利率/协议）备税务申报

### 碎片化篇
- [ ] 研究碎片协议赎回机制与治理规则
- [ ] 对比碎片价格与地板价折溢价（合理范围±5%）
- [ ] 小额试验交易流动性与滑点
- [ ] 评估持有期目标（长期投资 vs 短期套利）
- [ ] 关注治理提案与大户地址动向

### 租赁篇
- [ ] 确认租赁协议支持标准（ERC-4907等）
- [ ] 核对租赁期间权益分配（空投/治理/收益）
- [ ] 设置自动到期归还机制
- [ ] 评估租户信用（GameFi公会/KYC平台）
- [ ] 计算租金回报率 vs 持有收益

### 衍生品篇
- [ ] 理解期权/永续合约机制与爆仓规则
- [ ] 小仓位测试（≤总仓位10%）
- [ ] 设置止损线（期权：最大损失=期权费；杠杆：严格止损）
- [ ] 监控资金费率与流动性深度
- [ ] 对冲组合再平衡（Delta中性/价差策略）

### 通用风控
- [ ] **蓝筹优先**：BAYC/Punks/Azuki等经过时间验证
- [ ] **协议分散**：避免单一协议集中度>50%
- [ ] **小额起步**：首次使用协议先投入<5%资金试验
- [ ] **实时监控**：每日检查健康因子/地板价/协议公告
- [ ] **应急预案**：预设清算触发后操作流程（补仓/还款/止损）
- [ ] **税务合规**：保留完整交易记录，咨询专业人士

---

## 🎓 进阶学习资源
- **NFTfi官方文档**：https://docs.nftfi.com
- **BendDAO Docs**：https://docs.benddao.xyz
- **NFT价格追踪**：NFTGo.io、NFTScan、Reservoir
- **DeFi组合管理**：DeBank、Zapper、Zerion
- **审计报告库**：DeFi Safety、CertiK排行榜
- **行业研报**：Messari、Dune Analytics NFT Dashboard
- **社区**：NFTfi Discord、r/NFT、CT（Crypto Twitter）

---

## 🔚 结语
NFT金融生态正处于快速迭代期，协议创新与风险并存。**无论选择何种策略，请牢记**：
1. **只投资你能承受全损的金额**
2. **蓝筹NFT是相对安全基础**（但非绝对）
3. **低LTV + 实时监控 = 降低清算风险**
4. **协议审计与TVL是安全第一道防线**
5. **分散投资、小额试验、持续学习**

祝你在NFTFi旅程中释放流动性、获取收益、稳健前行！🚀
`,

  // ===== 与前端适配的步骤结构（5步） =====
  steps: [
    { step_number: 1, title: '基础准备与协议选型', description: '评估持有NFT价值与类型（蓝筹/稀有），选择适合的协议类型（P2P/P2Pool/碎片化/租赁），查看审计报告与TVL，准备钱包与资金。', estimated_time: '1–2 小时' },
    { step_number: 2, title: '风险参数配置', description: '计算LTV、利率、清算阈值，设置健康因子告警（建议HF>1.5），预留应急资金（≥10%抵押品价值），制定补仓/止损预案。', estimated_time: '30–60 分钟' },
    { step_number: 3, title: '小额试验与执行', description: '先投入小额资金（<5%总仓位）测试协议操作流程、Gas成本、流动性，确认无误后再扩大规模；记录交易明细（时间/金额/协议）。', estimated_time: '1–2 小时' },
    { step_number: 4, title: '仓位监控与管理', description: '每日检查健康因子/地板价波动/协议公告，使用DeBank/Zapper等工具汇总仓位，根据市场变化调整LTV或部分还款，避免被动清算。', estimated_time: '15–30 分钟/日' },
    { step_number: 5, title: '定期复盘与优化', description: '每周/月统计净收益（利息/手续费/清算损失），评估协议表现与风险事件，优化策略（协议切换/参数调整/退出时机），更新应急预案。', estimated_time: '1–3 小时/周' },
  ],
};

// ===== 自动执行：与既有模板一致 =====
async function getAuthToken() {
  const response = await axios.post(`${DIRECTUS_URL}/auth/login`, {
    email: 'the_uk1@outlook.com',
    password: 'Mygcdjmyxzg2026!',
  });
  return response.data.data.access_token;
}

async function addGuide() {
  try {
    const token = await getAuthToken();

    const strategy = {
      ...GUIDE_CONFIG,
      status: 'published',
      is_featured: true,
      view_count: 0,
      bookmark_count: 0,
      published_at: new Date().toISOString(),
    };

    const response = await axios.post(
      `${DIRECTUS_URL}/items/strategies`,
      strategy,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      },
    );

    console.log('\n✅ NFT 金融完全指南创建成功!');
    console.log(`   ID: ${response.data.data.id}`);
    console.log(`   Slug: ${response.data.data.slug}`);
    console.log(`   访问: http://localhost:3000/strategies/${response.data.data.slug}\n`);
  } catch (error) {
    console.error('\n❌ 创建失败:', error.response?.data || error.message);
  }
}

addGuide();
