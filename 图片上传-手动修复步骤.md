# 图片上传功能 - 手动修复步骤

## 🎯 问题说明

文件上传功能本身正常，但上传的文件无法公开访问（返回 403 错误）。
需要在 Directus 后台配置文件的公共访问权限。

---

## ✅ 解决方案：在 Directus 后台配置权限

### 步骤 1：登录 Directus 后台

1. 打开浏览器，访问：**http://localhost:8055**
2. 使用管理员账号登录：
   - Email: `the_uk1@outlook.com`
   - Password: `Mygcdjmyxzg2026!`

### 步骤 2：进入设置页面

1. 点击左上角的 **设置图标**（齿轮⚙️）
2. 在设置菜单中选择 **"Access Control"** (访问控制)

### 步骤 3：配置 Public 角色权限

1. 在角色列表中找到 **"Public"** 角色并点击
2. 向下滚动找到 **"Directus Files"** 集合

#### 如果已经有 Directus Files 行：

1. 点击该行进行编辑
2. 确保 **"Read"** (读取) 权限已启用 ✅
3. 点击 "Read" 权限查看详细配置
4. 确保设置为：
   - **Custom Permissions**: 关闭（或选择 "All Items"）
   - **Field Permissions**: "All Fields" 或选择 `*`
5. 保存更改

#### 如果没有 Directus Files 行：

1. 点击 **"+ Create Permission"** 或 **"Add Collection"**
2. 选择 **"directus_files"**
3. 启用 **"Read"** 权限
4. 设置权限：
   - **Access**: "All Items"
   - **Fields**: "All Fields"
5. 保存

### 步骤 4：保存并刷新

1. 点击右上角的 **"Save"** 按钮
2. 刷新页面或重新加载 Directus

### 步骤 5：测试文件访问

1. 进入 Directus 后台的 **"Files"** (文件库)
2. 点击任意一个已上传的文件
3. 在详情页面找到文件 **ID**（在 URL 中或详情中）
4. 打开新的浏览器标签页（无需登录）
5. 访问：`http://localhost:8055/assets/{文件ID}`
6. 如果能看到图片，说明配置成功！✅

---

## 🧪 测试步骤

### 测试 1：上传图片

1. 在 Directus 后台，点击左侧 **"Files"** 图标
2. 点击右上角 **"+ Upload Files"**
3. 选择一张图片上传
4. 上传成功后，记录文件 ID

### 测试 2：设置策略封面

1. 进入 **"Strategies"** 集合
2. 点击任意一个策略进入编辑
3. 找到 **"Cover Image"** 字段
4. 点击字段，应该会弹出文件选择器
5. 选择刚才上传的图片
6. 保存

### 测试 3：前端显示

1. 访问前端网站：http://localhost:3000/strategies
2. 找到刚才编辑的策略
3. 封面图片应该正常显示

---

## 🔧 如果仍然不work

### 方案 A：重启 Directus

```bash
docker-compose restart directus
```

等待约 30 秒让 Directus 完全启动。

### 方案 B：检查你的角色权限

你的账号可能不是使用 Public 角色，而是另一个角色：

1. 在 Directus 设置中，进入 **"Roles"**
2. 找到你的角色（可能叫 "Administrator" 或其他名称）
3. 为该角色添加 **directus_files** 的完整权限（Create, Read, Update, Delete）

### 方案 C：使用脚本测试

运行测试脚本查看详细信息：

```bash
node test-file-upload.js
```

如果看到 "❌ 无法访问文件 (状态码: 403)"，说明权限配置还未生效。

---

## 📸 正确的权限配置截图参考

### Public 角色应该有的配置：

```
Collection: directus_files
Actions:
  ✅ Read

Read Permission:
  - Access: All Items (或不限制)
  - Fields: All Fields (或 *)
```

### 你的角色应该有的配置：

```
Collection: directus_files
Actions:
  ✅ Create
  ✅ Read
  ✅ Update
  ✅ Delete

All Permissions:
  - Access: All Items
  - Fields: All Fields
```

---

## 💡 常见问题

### Q: 我看不到 "Access Control" 选项

**答**: 你的账号可能没有管理员权限。确保你使用的是管理员账号登录。

### Q: 我看不到 "Public" 角色

**答**: Public 角色是 Directus 的内置角色，用于未登录用户。如果看不到，可能是 Directus 版本问题。

### Q: 配置后仍然返回 403

**答**:
1. 清除浏览器缓存
2. 重启 Directus: `docker-compose restart directus`
3. 检查是否设置了其他限制性规则

### Q: 上传按钮点击没反应

**答**:
1. 按 F12 打开浏览器控制台
2. 查看 Console 标签是否有错误
3. 查看 Network 标签，看上传请求是否发送

---

## ✅ 成功标志

当配置正确后，你应该能够：

1. ✅ 在 Directus 后台上传文件
2. ✅ 无需登录即可访问 `http://localhost:8055/assets/{fileId}`
3. ✅ 在编辑策略时可以选择封面图片
4. ✅ 前端页面可以显示图片

---

## 🚀 下一步

权限配置成功后：

1. 为已创建的 5 个指南添加封面图片
2. 准备一些通用的封面图模板
3. 更新前端代码以正确显示图片
4. 考虑添加图片优化和压缩

---

## 📞 需要帮助

如果按照以上步骤操作后仍有问题，请提供：

1. Directus 后台 "Access Control" 页面的截图
2. 浏览器控制台的错误信息
3. 文件上传时 Network 标签的请求详情

可以截图发送，我会根据具体情况提供解决方案。

---

最后更新: 2025-10-27
