# HTTP 402 çº¯ Web3 æ”¯ä»˜æ–¹æ¡ˆ

## ä¸€ã€æ ¸å¿ƒç†è§£

### HTTP 402 çš„æœ¬è´¨
```
HTTP 402 â‰  æ”¯ä»˜ç³»ç»Ÿ
HTTP 402 = åè®®æ ‡å‡†ï¼ˆå‘Šè¯‰å®¢æˆ·ç«¯ï¼šè¿™ä¸ªèµ„æºéœ€è¦ä»˜è´¹ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP 402 åªåšä¸€ä»¶äº‹ï¼š                   â”‚
â”‚  è¿”å› 402 çŠ¶æ€ç  + æ”¯ä»˜ä¿¡æ¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½ éœ€è¦è‡ªå·±å®ç°ï¼š                        â”‚
â”‚  1. æ”¯ä»˜ UIï¼ˆå¼¹çª—ã€è¡¨å•ç­‰ï¼‰              â”‚
â”‚  2. é’±åŒ…è¿æ¥ï¼ˆMetamaskã€WalletConnectï¼‰  â”‚
â”‚  3. äº¤æ˜“å‘é€å’Œç¡®è®¤                       â”‚
â”‚  4. æ”¯ä»˜éªŒè¯é€»è¾‘                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆä¸éœ€è¦ Stripeï¼Ÿ**
- âœ… Web3 ç”¨æˆ·å·²ç»æœ‰åŠ å¯†é’±åŒ…
- âœ… ç›´æ¥é“¾ä¸Šæ”¯ä»˜ï¼Œæ— ä¸­é—´å•†
- âœ… æ›´ç¬¦åˆå»ä¸­å¿ƒåŒ–ç†å¿µ
- âœ… é™ä½æ”¯ä»˜æ‰‹ç»­è´¹

---

## äºŒã€çº¯ Web3 æ¶æ„è®¾è®¡

### 2.1 å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·è®¿é—®ä»˜è´¹å†…å®¹
      â†“
Next.js Middleware æ£€æµ‹
      â†“
è¿”å› 402 çŠ¶æ€ç 
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªå®šä¹‰ UI å¼¹å‡ºï¼ˆä½ çš„è®¾è®¡ï¼‰         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¦Š è§£é”é«˜çº§å†…å®¹             â”‚   â”‚
â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚  ä»·æ ¼: 0.001 ETH ($2.99)    â”‚   â”‚
â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚  [è¿æ¥é’±åŒ…]  [ç¡®è®¤æ”¯ä»˜]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
ç”¨æˆ·ç¡®è®¤äº¤æ˜“
      â†“
å‘é€é“¾ä¸Šäº¤æ˜“
      â†“
ç­‰å¾…ç¡®è®¤ï¼ˆæ˜¾ç¤ºè¿›åº¦ UIï¼‰
      â†“
åç«¯éªŒè¯äº¤æ˜“
      â†“
ç”Ÿæˆè®¿é—® Token
      â†“
åˆ·æ–°é¡µé¢ â†’ æ˜¾ç¤ºå†…å®¹
```

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©

```typescript
// å‰ç«¯æ”¯ä»˜ UI
- React/Next.js          // æ¡†æ¶
- wagmi/viem             // Web3 hooks
- RainbowKit             // é’±åŒ…è¿æ¥ UIï¼ˆå¯é€‰ï¼Œä¹Ÿå¯è‡ªå·±åšï¼‰
- framer-motion          // åŠ¨ç”»æ•ˆæœ

// åç«¯éªŒè¯
- Next.js API Routes     // API
- ethers.js / viem       // åŒºå—é“¾äº¤äº’
- Supabase               // æ•°æ®å­˜å‚¨
```

---

## ä¸‰ã€è‡ªå®šä¹‰ UI è®¾è®¡

### 3.1 æ”¯ä»˜å¼¹çª—ç»„ä»¶ï¼ˆå®Œå…¨è‡ªå®šä¹‰ï¼‰

```typescript
// components/Web3PaymentDialog.tsx
'use client';

import { useState, useEffect } from 'react';
import { useAccount, useConnect, useDisconnect, useSendTransaction } from 'wagmi';
import { parseEther } from 'viem';
import { motion, AnimatePresence } from 'framer-motion';

interface Web3PaymentDialogProps {
  contentId: string;
  priceUSD: number;
  priceETH: string;
  onSuccess: () => void;
}

export function Web3PaymentDialog({
  contentId,
  priceUSD,
  priceETH,
  onSuccess
}: Web3PaymentDialogProps) {
  const [step, setStep] = useState<'connect' | 'confirm' | 'pending' | 'success'>('connect');
  const { address, isConnected } = useAccount();
  const { connect, connectors } = useConnect();
  const { sendTransaction, data: txHash } = useSendTransaction();

  // è¿æ¥é’±åŒ…åè‡ªåŠ¨è¿›å…¥ç¡®è®¤æ­¥éª¤
  useEffect(() => {
    if (isConnected) {
      setStep('confirm');
    }
  }, [isConnected]);

  // ç›‘å¬äº¤æ˜“çŠ¶æ€
  useEffect(() => {
    if (txHash) {
      setStep('pending');
      pollTransactionStatus(txHash);
    }
  }, [txHash]);

  async function handleConnect(connector: any) {
    try {
      await connect({ connector });
    } catch (error) {
      console.error('Connection failed:', error);
    }
  }

  async function handlePayment() {
    try {
      // å‘é€äº¤æ˜“åˆ°ä½ çš„æ”¶æ¬¾åœ°å€
      await sendTransaction({
        to: process.env.NEXT_PUBLIC_PAYMENT_WALLET_ADDRESS as `0x${string}`,
        value: parseEther(priceETH),
        data: `0x${Buffer.from(contentId).toString('hex')}`, // åœ¨ data ä¸­è®°å½• contentId
      });
    } catch (error) {
      console.error('Payment failed:', error);
    }
  }

  async function pollTransactionStatus(hash: string) {
    // è½®è¯¢äº¤æ˜“çŠ¶æ€
    const interval = setInterval(async () => {
      const response = await fetch('/api/payment/web3/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          txHash: hash,
          contentId: contentId,
        }),
      });

      const data = await response.json();

      if (data.success) {
        clearInterval(interval);
        setStep('success');
        setTimeout(() => onSuccess(), 2000);
      }
    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
  }

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50"
      >
        <motion.div
          initial={{ scale: 0.9, y: 20 }}
          animate={{ scale: 1, y: 0 }}
          className="bg-white dark:bg-slate-900 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl"
        >
          {/* æ­¥éª¤ 1: è¿æ¥é’±åŒ… */}
          {step === 'connect' && (
            <div className="space-y-6">
              <div className="text-center">
                <h2 className="text-2xl font-bold mb-2">è¿æ¥é’±åŒ…</h2>
                <p className="text-slate-600 dark:text-slate-400">
                  é€‰æ‹©ä½ çš„ Web3 é’±åŒ…ä»¥ç»§ç»­
                </p>
              </div>

              <div className="space-y-3">
                {connectors.map((connector) => (
                  <button
                    key={connector.id}
                    onClick={() => handleConnect(connector)}
                    className="w-full flex items-center gap-4 p-4 border-2 border-slate-200 dark:border-slate-700 rounded-xl hover:border-purple-500 dark:hover:border-purple-500 transition-colors"
                  >
                    {/* é’±åŒ…å›¾æ ‡ */}
                    <WalletIcon name={connector.name} />
                    <span className="font-semibold">{connector.name}</span>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* æ­¥éª¤ 2: ç¡®è®¤æ”¯ä»˜ */}
          {step === 'confirm' && (
            <div className="space-y-6">
              <div className="text-center">
                <div className="w-16 h-16 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                  ğŸ”“
                </div>
                <h2 className="text-2xl font-bold mb-2">è§£é”é«˜çº§å†…å®¹</h2>
                <p className="text-slate-600 dark:text-slate-400">
                  ç¡®è®¤æ”¯ä»˜ä»¥æ°¸ä¹…è®¿é—®æ­¤å†…å®¹
                </p>
              </div>

              {/* ä»·æ ¼æ˜¾ç¤º */}
              <div className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-6">
                <div className="flex items-baseline justify-center gap-2 mb-2">
                  <span className="text-4xl font-bold text-purple-600">
                    {priceETH}
                  </span>
                  <span className="text-xl text-slate-600">ETH</span>
                </div>
                <div className="text-center text-sm text-slate-500">
                  â‰ˆ ${priceUSD} USD
                </div>
              </div>

              {/* è¿æ¥çš„é’±åŒ…ä¿¡æ¯ */}
              <div className="bg-slate-50 dark:bg-slate-800 rounded-lg p-4">
                <div className="flex items-center justify-between">
                  <span className="text-sm text-slate-600 dark:text-slate-400">
                    æ”¯ä»˜é’±åŒ…
                  </span>
                  <span className="font-mono text-sm">
                    {address?.slice(0, 6)}...{address?.slice(-4)}
                  </span>
                </div>
              </div>

              {/* æ”¯ä»˜æŒ‰é’® */}
              <button
                onClick={handlePayment}
                className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold rounded-xl transition-all shadow-lg hover:shadow-xl"
              >
                ç¡®è®¤æ”¯ä»˜
              </button>

              <p className="text-xs text-center text-slate-500">
                äº¤æ˜“å°†åœ¨åŒºå—é“¾ä¸Šå¤„ç†ï¼Œé€šå¸¸éœ€è¦ 1-2 åˆ†é’Ÿç¡®è®¤
              </p>
            </div>
          )}

          {/* æ­¥éª¤ 3: ç­‰å¾…ç¡®è®¤ */}
          {step === 'pending' && (
            <div className="space-y-6 text-center">
              <div className="w-20 h-20 mx-auto">
                <LoadingSpinner />
              </div>

              <div>
                <h2 className="text-2xl font-bold mb-2">å¤„ç†ä¸­...</h2>
                <p className="text-slate-600 dark:text-slate-400">
                  ç­‰å¾…åŒºå—é“¾ç¡®è®¤äº¤æ˜“
                </p>
              </div>

              <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                <p className="text-sm text-blue-600 dark:text-blue-400">
                  ğŸ’¡ äº¤æ˜“å·²å‘é€ï¼Œè¯·å‹¿å…³é—­é¡µé¢
                </p>
              </div>

              {txHash && (
                <a
                  href={`https://etherscan.io/tx/${txHash}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sm text-purple-600 hover:underline"
                >
                  åœ¨ Etherscan ä¸ŠæŸ¥çœ‹ â†’
                </a>
              )}
            </div>
          )}

          {/* æ­¥éª¤ 4: æˆåŠŸ */}
          {step === 'success' && (
            <div className="space-y-6 text-center">
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                className="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto"
              >
                <svg className="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </motion.div>

              <div>
                <h2 className="text-2xl font-bold mb-2">æ”¯ä»˜æˆåŠŸï¼</h2>
                <p className="text-slate-600 dark:text-slate-400">
                  æ­£åœ¨è§£é”å†…å®¹...
                </p>
              </div>
            </div>
          )}
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
}

// é’±åŒ…å›¾æ ‡ç»„ä»¶
function WalletIcon({ name }: { name: string }) {
  const icons: Record<string, string> = {
    'MetaMask': 'ğŸ¦Š',
    'WalletConnect': 'ğŸ”—',
    'Coinbase Wallet': 'ğŸ”µ',
  };

  return (
    <div className="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-2xl">
      {icons[name] || 'ğŸ’¼'}
    </div>
  );
}

// åŠ è½½åŠ¨ç”»ç»„ä»¶
function LoadingSpinner() {
  return (
    <motion.div
      animate={{ rotate: 360 }}
      transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
      className="w-full h-full border-4 border-purple-200 dark:border-purple-800 border-t-purple-600 rounded-full"
    />
  );
}
```

### 3.2 wagmi é…ç½®

```typescript
// lib/wagmi-config.ts
import { createConfig, http } from 'wagmi';
import { mainnet, polygon, base } from 'wagmi/chains';
import { metaMask, walletConnect, coinbaseWallet } from 'wagmi/connectors';

export const wagmiConfig = createConfig({
  chains: [mainnet, polygon, base],
  connectors: [
    metaMask(),
    walletConnect({
      projectId: process.env.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID!,
    }),
    coinbaseWallet({
      appName: 'PlayNew.ai',
    }),
  ],
  transports: {
    [mainnet.id]: http(),
    [polygon.id]: http(),
    [base.id]: http(),
  },
});
```

### 3.3 Provider åŒ…è£…

```typescript
// app/layout.tsx
import { WagmiProvider } from 'wagmi';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { wagmiConfig } from '@/lib/wagmi-config';

const queryClient = new QueryClient();

export default function RootLayout({ children }) {
  return (
    <html lang="zh-CN">
      <body>
        <WagmiProvider config={wagmiConfig}>
          <QueryClientProvider client={queryClient}>
            {children}
          </QueryClientProvider>
        </WagmiProvider>
      </body>
    </html>
  );
}
```

---

## å››ã€åç«¯å®ç°

### 4.1 äº¤æ˜“éªŒè¯ API

```typescript
// app/api/payment/web3/verify/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createPublicClient, http } from 'viem';
import { mainnet } from 'viem/chains';
import { createClient } from '@supabase/supabase-js';
import crypto from 'crypto';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const publicClient = createPublicClient({
  chain: mainnet,
  transport: http(),
});

export async function POST(request: NextRequest) {
  const { txHash, contentId } = await request.json();

  try {
    // 1. è·å–äº¤æ˜“è¯¦æƒ…
    const transaction = await publicClient.getTransaction({
      hash: txHash as `0x${string}`,
    });

    // 2. è·å–äº¤æ˜“æ”¶æ®ï¼ˆç¡®è®¤çŠ¶æ€ï¼‰
    const receipt = await publicClient.getTransactionReceipt({
      hash: txHash as `0x${string}`,
    });

    // 3. éªŒè¯äº¤æ˜“
    if (receipt.status !== 'success') {
      return NextResponse.json(
        { success: false, error: 'Transaction failed' },
        { status: 400 }
      );
    }

    // 4. éªŒè¯æ”¶æ¬¾åœ°å€
    if (transaction.to?.toLowerCase() !== process.env.PAYMENT_WALLET_ADDRESS?.toLowerCase()) {
      return NextResponse.json(
        { success: false, error: 'Invalid recipient' },
        { status: 400 }
      );
    }

    // 5. éªŒè¯é‡‘é¢ï¼ˆå…è®¸ 5% è¯¯å·®ï¼Œè€ƒè™‘ gas ä»·æ ¼æ³¢åŠ¨ï¼‰
    const expectedAmount = BigInt(process.env.PAYMENT_AMOUNT_WEI!);
    const actualAmount = transaction.value;
    const tolerance = expectedAmount / BigInt(20); // 5%

    if (actualAmount < expectedAmount - tolerance) {
      return NextResponse.json(
        { success: false, error: 'Insufficient payment amount' },
        { status: 400 }
      );
    }

    // 6. æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡æ­¤äº¤æ˜“ï¼ˆé˜²é‡æ”¾ï¼‰
    const { data: existing } = await supabase
      .from('payment_402_transactions')
      .select('id')
      .eq('payment_proof', txHash)
      .single();

    if (existing) {
      return NextResponse.json(
        { success: false, error: 'Transaction already used' },
        { status: 400 }
      );
    }

    // 7. ç”Ÿæˆè®¿é—® Token
    const accessToken = crypto.randomBytes(32).toString('hex');

    // 8. ä¿å­˜äº¤æ˜“è®°å½•
    await supabase.from('payment_402_transactions').insert({
      content_id: contentId,
      payment_method: 'web3',
      payment_proof: txHash,
      payment_status: 'completed',
      amount_crypto: transaction.value.toString(),
      currency: 'ETH',
      user_address: transaction.from,
    });

    // 9. åˆ›å»ºè®¿é—®ä»¤ç‰Œ
    await supabase.from('payment_402_access_tokens').insert({
      content_id: contentId,
      token: accessToken,
      expires_at: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1å¹´
    });

    return NextResponse.json({
      success: true,
      token: accessToken,
    });

  } catch (error) {
    console.error('Verification failed:', error);
    return NextResponse.json(
      { success: false, error: 'Verification failed' },
      { status: 500 }
    );
  }
}
```

### 4.2 ä»·æ ¼è½¬æ¢ APIï¼ˆå®æ—¶æ±‡ç‡ï¼‰

```typescript
// app/api/payment/price/route.ts
import { NextResponse } from 'next/server';

export async function GET() {
  try {
    // ä» CoinGecko è·å–å®æ—¶ ETH ä»·æ ¼
    const response = await fetch(
      'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd'
    );
    const data = await response.json();
    const ethPrice = data.ethereum.usd;

    // è®¡ç®—å†…å®¹ä»·æ ¼ï¼ˆå‡è®¾ $2.99ï¼‰
    const priceUSD = 2.99;
    const priceETH = (priceUSD / ethPrice).toFixed(6);

    return NextResponse.json({
      success: true,
      priceUSD: priceUSD,
      priceETH: priceETH,
      ethUSD: ethPrice,
    });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'Failed to fetch price' },
      { status: 500 }
    );
  }
}
```

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 5.1 ä¿æŠ¤ç­–ç•¥è¯¦æƒ…é¡µ

```typescript
// app/strategies/[slug]/page.tsx
import { Payment402Guard } from '@/components/Payment402Guard';

export default async function StrategyPage({ params }: { params: { slug: string } }) {
  const strategy = await getStrategy(params.slug);

  return (
    <div>
      {/* å…è´¹é¢„è§ˆéƒ¨åˆ† */}
      <StrategyHeader strategy={strategy} />
      <StrategySummary summary={strategy.summary} />

      {/* ä»˜è´¹å®Œæ•´å†…å®¹ */}
      {strategy.is_premium ? (
        <Payment402Guard
          contentId={strategy.id}
          priceUSD={2.99}
        >
          <StrategyFullContent content={strategy.full_content} />
          <StrategyBacktest backtest={strategy.backtest_data} />
          <StrategyRiskAnalysis risks={strategy.risks} />
        </Payment402Guard>
      ) : (
        <>
          <StrategyFullContent content={strategy.full_content} />
          <StrategyBacktest backtest={strategy.backtest_data} />
          <StrategyRiskAnalysis risks={strategy.risks} />
        </>
      )}
    </div>
  );
}
```

### 5.2 Payment Guard ç»„ä»¶

```typescript
// components/Payment402Guard.tsx
'use client';

import { useEffect, useState } from 'react';
import { Web3PaymentDialog } from './Web3PaymentDialog';
import Cookies from 'js-cookie';

export function Payment402Guard({
  contentId,
  priceUSD,
  children
}: {
  contentId: string;
  priceUSD: number;
  children: React.ReactNode;
}) {
  const [hasAccess, setHasAccess] = useState(false);
  const [showPayment, setShowPayment] = useState(false);
  const [priceETH, setPriceETH] = useState('0');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    checkAccess();
    fetchPrice();
  }, []);

  async function checkAccess() {
    // æ£€æŸ¥ Cookie ä¸­çš„è®¿é—®ä»¤ç‰Œ
    const token = Cookies.get(`access_${contentId}`);

    if (token) {
      // éªŒè¯ token æœ‰æ•ˆæ€§
      const response = await fetch('/api/payment/verify-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contentId, token }),
      });

      const data = await response.json();

      if (data.valid) {
        setHasAccess(true);
      } else {
        setShowPayment(true);
      }
    } else {
      setShowPayment(true);
    }

    setLoading(false);
  }

  async function fetchPrice() {
    const response = await fetch('/api/payment/price');
    const data = await response.json();
    setPriceETH(data.priceETH);
  }

  function handlePaymentSuccess() {
    setShowPayment(false);
    setHasAccess(true);
  }

  if (loading) {
    return <LoadingSkeleton />;
  }

  if (showPayment) {
    return (
      <Web3PaymentDialog
        contentId={contentId}
        priceUSD={priceUSD}
        priceETH={priceETH}
        onSuccess={handlePaymentSuccess}
      />
    );
  }

  return hasAccess ? <>{children}</> : null;
}
```

---

## å…­ã€UI è®¾è®¡å»ºè®®

### 6.1 è®¾è®¡åŸåˆ™

```
1. æ¸…æ™°æ˜ç¡®
   - ä»·æ ¼æ˜¾ç¤ºçªå‡ºï¼ˆETH + USDï¼‰
   - æ­¥éª¤æŒ‡ç¤ºæ¸…æ™°
   - é”™è¯¯æç¤ºå‹å¥½

2. ä¿¡ä»»æ„Ÿ
   - æ˜¾ç¤ºåŒºå—é“¾äº¤æ˜“é“¾æ¥
   - å±•ç¤ºå®æ—¶äº¤æ˜“çŠ¶æ€
   - ä¿è¯é€æ˜åº¦

3. å¿«é€Ÿæµç•…
   - å‡å°‘ç‚¹å‡»æ­¥éª¤
   - è‡ªåŠ¨æ£€æµ‹é’±åŒ…è¿æ¥
   - æ™ºèƒ½ç­‰å¾…å’Œé‡è¯•
```

### 6.2 å¯é€‰çš„ UI åº“

```typescript
// é€‰é¡¹ 1: å®Œå…¨è‡ªå®šä¹‰ï¼ˆæ¨èï¼‰
- Tailwind CSS + Framer Motion
- å®Œå…¨æ§åˆ¶æ ·å¼å’Œäº¤äº’

// é€‰é¡¹ 2: ä½¿ç”¨ RainbowKitï¼ˆå¯é€‰ï¼‰
import { RainbowKitProvider } from '@rainbow-me/rainbowkit';
// æä¾›ç°æˆçš„é’±åŒ…è¿æ¥ UIï¼Œä½†ä½ ä»éœ€è‡ªå·±åšæ”¯ä»˜ç¡®è®¤ UI

// é€‰é¡¹ 3: æ··åˆä½¿ç”¨
- RainbowKit å¤„ç†é’±åŒ…è¿æ¥
- è‡ªå®šä¹‰æ”¯ä»˜ç¡®è®¤å’ŒçŠ¶æ€ UI
```

---

## ä¸ƒã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

âœ… **HTTP 402 æ˜¯åè®®ï¼Œä¸æ˜¯äº§å“**
   - åªå®šä¹‰äº†"å¦‚ä½•å‘ŠçŸ¥éœ€è¦ä»˜è´¹"
   - ä¸åŒ…å«ä»»ä½• UI æˆ–æ”¯ä»˜å®ç°

âœ… **æ‰€æœ‰ UI éƒ½éœ€è¦è‡ªå·±åš**
   - é’±åŒ…è¿æ¥ç•Œé¢
   - æ”¯ä»˜ç¡®è®¤å¯¹è¯æ¡†
   - äº¤æ˜“çŠ¶æ€å±•ç¤º
   - æˆåŠŸ/å¤±è´¥æç¤º

âœ… **çº¯ Web3 æ›´ç®€å•**
   - ä¸éœ€è¦ Stripe é›†æˆ
   - ä¸éœ€è¦å¤„ç†é€€æ¬¾é€»è¾‘
   - ç›´æ¥é“¾ä¸ŠéªŒè¯
   - é€‚åˆ crypto native ç”¨æˆ·

### å®æ–½ä¼˜å…ˆçº§

**Week 1: åŸºç¡€åŠŸèƒ½**
- [x] wagmi é…ç½®
- [x] ç®€å•æ”¯ä»˜ UI
- [x] äº¤æ˜“éªŒè¯ API

**Week 2: ä¼˜åŒ–ä½“éªŒ**
- [x] å®æ—¶ä»·æ ¼è½¬æ¢
- [x] äº¤æ˜“çŠ¶æ€è½®è¯¢
- [x] é”™è¯¯å¤„ç†

**Week 3: å¤šé“¾æ”¯æŒ**
- [x] Polygonï¼ˆä½ gasï¼‰
- [x] Baseï¼ˆå¿«é€Ÿç¡®è®¤ï¼‰
- [x] Arbitrumï¼ˆä¾¿å®œï¼‰

### é¢„ä¼°æˆæœ¬

- **å¼€å‘æ—¶é—´**: 1-2å‘¨
- **Gasè´¹ç”¨**: ç”¨æˆ·æ‰¿æ‹…
- **è¿è¥æˆæœ¬**: å‡ ä¹ä¸ºé›¶
- **æ”¶æ¬¾ç›´æ¥åˆ°è´¦**: æ— éœ€ç­‰å¾…ç»“ç®—

éœ€è¦æˆ‘å¸®ä½ å¼€å§‹å®ç°å…·ä½“çš„ä»£ç å—ï¼Ÿ
